---
title: "Choice of plant size proxy"
author: "Eric R. Scott"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, paged.print = FALSE)

withr::with_dir(here::here(), {
  targets::tar_load(la_data)
})

library(tidyverse)
library(performance)
```

## What proxy of size is best?

In our 10 year demographic dataset we have yearly measurements of plant height (height to tip of tallest leaf) and shoot number.
Height $\times$ shoot number is a possibility for an integrative proxy of plant size.

Using data from transplant experiments (CITATION), we show that plant size (height $\times$ shoot number) best explains variation in total plant leaf area.

```{r}
la <- 
  la_data %>% 
  mutate(size = shts * ht) %>% 
  #log transform all size variables
  mutate(across(c(leaf_area, leaves, ht, shts, size), list(log = log), .names = "{.fn}_{.col}")) %>% 
  filter(!is.na(leaf_area) & !is.na(ht) & !is.na(shts)) %>% 
  filter(shts > 0)
```

```{r}
hist(la$leaf_area)
hist(la$log_leaf_area)
#use log(leaf area) as response to better meet normality assumptions.
```

```{r}
m_ht <- lm(log_leaf_area ~ log_ht, data = la)
m_shts <- lm(log_leaf_area ~ log_shts, data = la)
m_size <- lm(log_leaf_area ~ log_size, data = la)
```

```{r}
check_model(m_ht)
check_model(m_shts)
check_model(m_size)
```

```{r}
compare_performance(m_ht, m_shts, m_size, metrics = "common", rank = TRUE)
```

```{r}
plot_fit <- function(m) {
  df <- broom::augment(m, se_fit = TRUE)
  
  pred <- colnames(df)[2]
  resp <- colnames(df)[1]
  
  p <- ggplot(df, aes_string(x = pred)) +
    geom_point(aes_string(y = resp)) + 
    geom_ribbon(aes(ymin = .fitted - .se.fit, ymax = .fitted + .se.fit), alpha = 0.4) +
    geom_line(aes(y = .fitted))
  return(p)
}
```

```{r}
plot_fit(m_ht) + labs(x = "log(height)", y = "log(leaf area)")
plot_fit(m_shts) + labs(x = "log(shoot number)", y = "log(leaf area)")
plot_fit(m_size) + labs(x = "log(shoots * height)", y = "log(leaf area)")
```

Using the log of size (shoot number $\times$ height) as a predictor gives the highest $R^2$ and lowest RMSE of the models as well as the lowest AIC indicating that it results in the best explanatory power and model fit for predicting log(leaf area) as a response.

## Reproducibility

<details>

<summary>

Reproducibility receipt

</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
