---
title: "Appendix A: Model Validation"
subtitle: "Supplement to 'Delayed effects of climate on vital rates lead to demographic divergence in Amazonian forest fragments'"
author: 
  - Eric R. Scott
  - Mar√≠a Uriarte
  - Emilio M. Bruna
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    toc_float: yes
linkcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
## target knits Rmds in their own session, so load libraries here.
library(targets)
library(statmod)
library(tidyverse)
library(gratia)
library(mgcv)
library(dlnm)
library(arm)
source(here::here("R", "utils.R"))
```


# Survival

```{r, echo=FALSE, eval=TRUE}
withr::with_dir(here::here(),{
  tar_load(c(s_1ha, s_cf, s_cf_sub))
})
```


## Forest Fragments

### Diagnostics

```{r echo=TRUE, eval=TRUE}
s_1ha_qres <- qresid(s_1ha)
par(mfrow = c(2,2))
#histogram
plot(density(s_1ha_qres))
#QQ plot
qqnorm(s_1ha_qres); qqline(s_1ha_qres)
#Fitted vs. residuals--binned residuals plot
binnedplot(fitted(s_1ha), residuals(s_1ha, type = "response"))
```

### Basis dimensions

```{r eval=TRUE}
k.check(s_1ha)
```

`k` is adequate for `log_size_prev`. Unfortunately `k.check()` doesn't work for data with matrices, so I'll use an alternative approach detailed in `?mgcv::choose.k` for the crossbasis smooth.  Briefly, it involves looking for pattern in residuals by extracting residuals and fitting a GAM to them with the smooth of interest with an increased value for `k`.  If there is no unexplained pattern in residuals, that smooth should have an edf near zero.

```{r eval=TRUE}
# Function sourced from R/utils.R
check_res_edf(s_1ha)
```

Adequate k for crossbasis.

## Continuous Forest

### Diagnostics

```{r echo=TRUE}
s_cf_qres <- qresid(s_cf)
par(mfrow = c(2,2))
#histogram
plot(density(s_cf_qres))
#QQ plot
qqnorm(s_cf_qres); qqline(s_cf_qres)
#Fitted vs. residuals--binned residuals plot
binnedplot(fitted(s_cf), residuals(s_cf, type = "response"))
```


### Basis dimensions

```{r}
k.check(s_cf)
```

Adequate knots for `log_size_prev`

```{r}
check_res_edf(s_cf)
```
Adequate knots for crossbasis smooth.

## Effect of sample size

Here I use a random sub-sample to check that differences between continuous forest and fragments are not purely due to sample size differences, particularly differences in the complexity and shape of the crossbasis smooth.

```{r}
summary(s_1ha)$edf[2]
summary(s_cf)$edf[2]
summary(s_cf_sub)$edf[2]
```

The crossbasis is smoother, but shows a similar pattern.

```{r}
draw(s_cf, select = "s(spei_history,L)", n_contour = 5)
draw(s_cf_sub, select = "s(spei_history,L)", n_contour = 5)
```

```{r echo=FALSE}
rm(s_1ha, s_cf, s_cf_sub)
```

# Growth

```{r echo=FALSE}
withr::with_dir(here::here(),{
  tar_load(c(g_1ha, g_cf, g_cf_sub))
})
```

## Fragments

### Diagnostics

```{r}
appraise(g_1ha)
```

### Basis dimensions

```{r}
k.check(g_1ha)
```

Adequate k for `log_size_prev`.

```{r}
check_res_edf(g_1ha)
```

Adequate k for crossbasis.

## Continuous Forest

### Diagnostics

```{r}
gratia::appraise(g_cf)
```

### Basis dimensions

```{r}
k.check(g_cf)
```

Adequate k for `log_size_prev`

```{r}
check_res_edf(g_cf)
```

Adequate k for crossbasis smooth.

## Effect of sample size

To check that differences are not purely due to sample size differences, particularly that lower edf in continuous forests is due to higher sample size.

```{r}
summary(g_1ha)$edf[2]
summary(g_cf)$edf[2]
summary(g_cf_sub)$edf[2]
```

edf is similar for the sub-sample

```{r}
draw(g_cf, select = "s(spei_history,L)", n_contour = 5)
draw(g_cf_sub, select = "s(spei_history,L)", n_contour = 5)
```

The shape of the smooth is also similar.

```{r echo=FALSE}
rm(g_1ha, g_cf, g_cf_sub)
```

# Flowering

```{r echo=FALSE}
withr::with_dir(here::here(),{
  tar_load(c(f_1ha, f_cf, f_cf_sub))
})
```

## Fragments

### Diagnostics

```{r}
f_1ha_qres <- qresid(f_1ha)
par(mfrow = c(2,2))
#histogram
plot(density(f_1ha_qres))
#QQ plot
qqnorm(f_1ha_qres); qqline(f_1ha_qres)
#Fitted vs. residuals--binned residuals plot
binnedplot(fitted(f_1ha), residuals(f_1ha, type = "response"))
```

### Basis dimensions

```{r}
k.check(f_1ha)
```

Adequate k for `log_size_prev`

```{r}
# looking for near zero edf
check_res_edf(f_1ha)
```

Adequate k for crossbasis smooth.

## Continuous Forest

### Diagnostics

```{r}
f_cf_qres <- qresid(f_cf)
par(mfrow = c(2,2))
#histogram
plot(density(f_cf_qres))
#QQ plot
qqnorm(f_cf_qres); qqline(f_cf_qres)
#Fitted vs. residuals--binned residuals plot
binnedplot(fitted(f_cf), residuals(f_cf, type = "response"))
```

### Basis dimensions

```{r}
k.check(f_cf)
```

Adequate k for `log_size_prev`

```{r}
# looking for near zero edf
check_res_edf(f_cf)
```
Adequate k for crossbasis.

## Effect of sample size

To check that differences are not purely due to sample size differences, particularly that lower edf in continuous forests is due to higher sample size.

```{r}
summary(f_1ha)$edf[2]
summary(f_cf)$edf[2]
summary(f_cf_sub)$edf[2]
```

Similar edf for sub-sample

```{r}
draw(f_cf, select = "s(spei_history,L)", n_contour = 5)
draw(f_cf_sub, select = "s(spei_history,L)", n_contour = 5)
```


Similar, but essentially linear in SPEI dimension.

# Reproducibility

<details>

<summary>

Reproducibility receipt

</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
