---
title: "Model validation plots"
author: "Eric R. Scott"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE)
## target knits Rmds in their own session, so load libraries here.
library(targets)
library(statmod)
library(tidyverse)
library(gratia)
library(mgcv)
library(dlnm)
library(arm)
source(here::here("R", "utils.R"))
```

**TODO**

- check that # of knots are adequate
- check diagnostics for individual-level random effects.  Doesn't look good, but not sure how to interpret or what to do. 


# Survival

```{r, echo=FALSE, eval=TRUE}
withr::with_dir(here::here(),{
  tar_load(c(s_1ha, s_cf, s_cf_sub))
})
```


## Forest Fragments

### Diagnostics

```{r echo=TRUE, eval=TRUE}
s_1ha_qres <- qresid(s_1ha)
par(mfrow = c(2,2))
#histogram
plot(density(s_1ha_qres))
#QQ plot
qqnorm(s_1ha_qres); qqline(s_1ha_qres)
#Fitted vs. residuals--binned residuals plot
binnedplot(fitted(s_1ha), residuals(s_1ha, type = "response"))
```

### Basis dimensions

```{r eval=TRUE}
k.check(s_1ha)
```

Basis dimension checking with `gam.check()` doesn't appear to work for `dlnm` crossbasis smooths. Instead I'll use a method described in the help file `?choose.k` to check for adequate knots.  Unfortunately, `bs = "cs"` doesn't work with `dlnm`, so I'll use `select = TRUE` instead to reduce chance of overfitting.

```{r eval=TRUE}
check_res_edf(s_1ha)
```

The crossbasis smooth possibly needs more knots.

```{r}
# plot_lag_slice(s_1ha, "spei_history", lag =  0) + labs(title = "surv, 1ha")
```

Here you can see how the CIs hardly overlap 0, but it could be an artifact of the line not being allowed to be wiggly enough.

### Summary

```{r eval=TRUE}
summary(s_1ha)
```


```{r eval=TRUE}
draw(s_1ha)
```




## Continuous Forest

### Diagnostics

```{r echo=TRUE}
s_cf_qres <- qresid(s_cf)
par(mfrow = c(2,2))
#histogram
plot(density(s_cf_qres))
#QQ plot
qqnorm(s_cf_qres); qqline(s_cf_qres)
#Fitted vs. residuals--binned residuals plot
binnedplot(fitted(s_cf), residuals(s_cf, type = "response"))
```


### Basis dimensions


```{r}
k.check(s_cf)
```

```{r}
# looking for near zero edf
check_res_edf(s_cf)
```

### Summary 

```{r}
summary(s_cf)
```

```{r}
draw(s_cf)
```

## Effect of sample size

Here I use a random sub-sample to check that differences between continuous forest and fragments are not purely due to sample size differences, particularly differences in the complexity of the crossbasis smooth.

```{r}
summary(s_1ha)$edf[3]
summary(s_cf)$edf[3]
summary(s_cf_sub)$edf[3]
```


```{r}
draw(s_cf_sub)
```
Surface still looks different in a similar way though.

```{r echo=FALSE}
rm(s_1ha, s_cf, s_cf_sub)
```

# Growth

```{r echo=FALSE}
withr::with_dir(here::here(),{
  tar_load(c(g_1ha, g_cf, g_cf_sub))
})
```

## Fragments

### Diagnostics

```{r}
appraise(g_1ha)
```

### Basis dimensions

```{r}
k.check(g_1ha)
```

```{r}
check_res_edf(g_1ha)
```

### Summary

```{r}
summary(g_1ha)
```

```{r}
draw(g_1ha)
```

## Continuous Forest

### Diagnostics

```{r}
gratia::appraise(g_cf)
```

### Basis dimensions

```{r}
k.check(g_cf)
```

```{r}
check_res_edf(g_cf)
```

```{r}
# plot_lag_slice(g_1ha, "spei_history", lag = 33)
```

hmm... CIs are **super** narrow here, but effect size is **tiny**

### Summary

```{r}
summary(g_cf)
```

```{r}
draw(g_cf)
```

## Continuous Forest subsample

To check that differences are not purely due to sample size differences, particularly that lower edf in continuous forests is due to higher sample size.

```{r}
summary(g_1ha)$edf[3]
summary(g_cf)$edf[3]
summary(g_cf_sub)$edf[3]
```
edf of subsample is similar to full dataset, despite differences in sample size.

```{r}
draw(g_cf_sub)
```
Crossbasis surface looks nearly identical.

```{r echo=FALSE}
rm(g_1ha, g_cf, g_cf_sub)
```

# Flowering

```{r echo=FALSE}
withr::with_dir(here::here(),{
  tar_load(c(f_1ha, f_cf, f_cf_sub))
})
```

## Fragments

### Diagnostics

```{r}
f_1ha_qres <- qresid(f_1ha)
par(mfrow = c(2,2))
#histogram
plot(density(f_1ha_qres))
#QQ plot
qqnorm(f_1ha_qres); qqline(f_1ha_qres)
#Fitted vs. residuals--binned residuals plot
binnedplot(fitted(f_1ha), residuals(f_1ha, type = "response"))
```

### Basis dimensions

```{r}
k.check(f_1ha)
```

```{r}
# looking for near zero edf
check_res_edf(f_1ha)
```

### Summary

```{r}
summary(f_1ha)
```

```{r}
draw(f_1ha)
```


## Continuous Forest

### Diagnostics

```{r}
f_cf_qres <- qresid(f_cf)
par(mfrow = c(2,2))
#histogram
plot(density(f_cf_qres))
#QQ plot
qqnorm(f_cf_qres); qqline(f_cf_qres)
#Fitted vs. residuals--binned residuals plot
binnedplot(fitted(f_cf), residuals(f_cf, type = "response"))
```

### Basis dimensions

```{r}
k.check(f_cf)
```

```{r}
# looking for near zero edf
check_res_edf(f_cf)
```

### Summary

```{r}
summary(f_cf)
```

```{r}
draw(f_cf)
```

## Continuous Forest subsample

To check that differences are not purely due to sample size differences, particularly that lower edf in continuous forests is due to higher sample size.  For flowering, edf is actually slightly higher in CF with a larger sample size.  With subsample, edf are more similar.

```{r}
summary(f_1ha)$edf[3]
summary(f_cf)$edf[3]
summary(f_cf_sub)$edf[3]
```

```{r}
draw(f_cf_sub)
```
Crossbasis surface looks extremely similar.


# Reproducibility

<details>

<summary>

Reproducibility receipt

</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
