---
title: "Model validation plots"
author: "Eric R. Scott"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## target knits Rmds in their own session, so load libraries here.
library(targets)
library(statmod)
library(tidyverse)
library(gratia)
```

# Analysis

## Survival

Quantile residuals are more appropriate for binomial models.
### Fragments
```{r}
withr::with_dir(here::here(),{
  tar_load(c(s_1ha, s_cf, s_cf_sub))
})
```

```{r}

summary(s_1ha)
```

```{r}
draw(s_1ha)
```

```{r echo=TRUE}
par(mfrow = c(2,2))
#histogram
plot(density(qresid(s_1ha)))
#QQ plot
qqnorm(qresid(s_1ha)); qqline(qresid(s_1ha))
#Fitted vs. residuals
scatter.smooth(predict(s_1ha, type = "response"), qresid(s_1ha), col = "grey")
```

### Continuous Forest

```{r}
summary(s_cf)
```

```{r}
draw(s_cf)
```

```{r echo=TRUE}
par(mfrow = c(2,2))
#histogram
plot(density(qresid(s_cf)))
#QQ plot
qqnorm(qresid(s_cf)); qqline(qresid(s_cf))
#Fitted vs. residuals
scatter.smooth(predict(s_cf, type = "response"), qresid(s_cf), col = "grey")
```

### Continuous forest subsample

To check that differences are not purely due to sample size differences, particularly that lower edf in continuous forests is due to higher sample size.  For survival, edf is actually higher in CF with a larger sample size.  With subsample, edf are more similar.

```{r}
summary(s_1ha)$edf[3]
summary(s_cf)$edf[3]
summary(s_cf_sub)$edf[3]
```


```{r}
draw(s_cf_sub)
```
Surface still looks different in a similar way though.
```{r}
rm(s_1ha, s_cf, s_cf_sub)
```

## Growth

```{r}
withr::with_dir(here::here(),{
  tar_load(c(g_1ha, g_cf, g_cf_sub))
})
```

### Fragments

```{r}
summary(g_1ha)
```

```{r}
draw(g_1ha)
```

```{r}
appraise(g_1ha)
```

### Continuous Forest

```{r}
summary(g_cf)
```

```{r}
draw(g_cf)
```

```{r}
gratia::appraise(g_cf)
```
### Continuous Forest subsample

To check that differences are not purely due to sample size differences, particularly that lower edf in continuous forests is due to higher sample size.

```{r}
summary(g_1ha)$edf[3]
summary(g_cf)$edf[3]
summary(g_cf_sub)$edf[3]
```
edf of subsample is similar to full dataset, despite differences in sample size.

```{r}
draw(g_cf_sub)
```
Crossbasis surface looks nearly identical.

```{r}
rm(g_1ha, g_cf, g_cf_sub)
```

## Flowering

Quantile residuals are more appropriate for binomial models.

```{r}
withr::with_dir(here::here(),{
  tar_load(c(f_1ha, f_cf, f_cf_sub))
})
```

### Fragments

```{r}
summary(f_1ha)
```

```{r}
draw(f_1ha)
```

```{r}
par(mfrow = c(2,2))
#histogram
plot(density(qresid(f_1ha)))
#QQ plot
qqnorm(qresid(f_1ha)); qqline(qresid(f_1ha))
#Fitted vs. residuals
scatter.smooth(predict(f_1ha, type = "response"), qresid(f_1ha), col = "grey")
```
### Continuous Forest

```{r}
summary(f_cf)
```

```{r}
draw(f_cf)
```

```{r}
par(mfrow = c(2,2))
#histogram
plot(density(qresid(f_cf)))
#QQ plot
qqnorm(qresid(f_cf)); qqline(qresid(f_cf))
#Fitted vs. residuals
scatter.smooth(predict(f_cf, type = "response"), qresid(f_cf), col = "grey")
```

### Continuous Forest subsample
To check that differences are not purely due to sample size differences, particularly that lower edf in continuous forests is due to higher sample size.  For flowering, edf is actually slightly higher in CF with a larger sample size.  With subsample, edf are more similar.

```{r}
summary(f_1ha)$edf[3]
summary(f_cf)$edf[3]
summary(f_cf_sub)$edf[3]
```

```{r}
draw(f_cf_sub)
```
Crossbasis surface looks extremely similar.

### Flowering prob of largest plants

Figure out flowering probability of largest quartile of plants in each habitat

```{r}
newdf_cf <-
  f_cf$model %>% #use model data frame
  mutate(quartiles = ntile(log_size_prev, 4)) %>% 
  filter(quartiles == 4)

newdf_1ha <-
  f_1ha$model %>% 
  mutate(quartiles = ntile(log_size_prev, 4)) %>% 
  filter(quartiles == 4)
```


```{r}
#equivalent to flowering once every __ years
1/predict(f_cf, newdata = newdf_cf) %>% mean() %>% plogis()
1/predict(f_1ha, newdata = newdf_1ha) %>% mean() %>% plogis()
```


```{r}
rm(f_1ha, f_cf, f_cf_sub)
```

# Reproducibility

<details>

<summary>

Reproducibility receipt

</summary>

```{r}
## datetime
Sys.time()

## repository
if(requireNamespace('git2r', quietly = TRUE)) {
  git2r::repository()
} else {
  c(
    system2("git", args = c("log", "--name-status", "-1"), stdout = TRUE),
    system2("git", args = c("remote", "-v"), stdout = TRUE)
  )
}

## session info
sessionInfo()
```

</details>
