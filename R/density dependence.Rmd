---
title: "Density dependence"
author: "Eric R. Scott"
date: "2020-09-13"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
library(lme4)
library(bbmle)
library(car)
library(broom)
library(broom.mixed)
library(patchwork)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# Purpose

Start by looking for density dependence on growth, survival, and reproduction in continuous forests using the number of plants in the same grid-cell as a metric for density.

# Load Data

```{r data, echo=TRUE}
ha <- read_rds(here("analysis", "data", "derived_data", "ha_density.rds"))
ha
```
Actually interested in density in the previous year

```{r}
ha <-
  ha %>% 
  group_by(ha_id_number) %>% 
  arrange(ha_id_number, year) %>% 
  mutate(across(starts_with("density"), lag)) %>% 
  ungroup() %>% 
  #scale year
  mutate(year_post = year - min(year))
```

Filter to just continuous forest

```{r}
ha_cf <- 
  ha %>% 
  filter(habitat == "CF") %>% 
  mutate(log_ht = log(ht),
         log_ht_prev = log(ht_prev))
```

I don't know what a height of 0 means...
Height of 0 probably means it was knocked over, or very small, or dead.


# Growth

For this I'm going to use shoot number. Very closely related to height, but better behaved distribution and not sensitive to plants being knocked over.

```{r}
mpois <- glm(shts ~ log(shts_prev) * density_0_10,
             family = poisson(link = "log"),
             data = ha_cf)
lm <- lm(shts ~ log(shts_prev) * density_0_10,
         data = ha_cf)
mnorm <- glm(shts ~ log(shts_prev) * density_0_10,
             family = gaussian(link = "log"),
             data = ha_cf)
mpois2 <- glmer(shts ~ log(shts_prev) * density_0_10 + (1|ha_id_number) + (1|year_post) + (1|plot),
                family = poisson(link = "log"),
                data = ha_cf)

mnorm2 <- glmer(shts ~ log(shts_prev) * density_0_10 + (1|ha_id_number) + (1|year_post) + (1|plot),
                family = gaussian(link = "log"),
                data = ha_cf)

AICtab(mpois, mnorm, lm, mpois2, mnorm2)
```

Lognormal distribution fits best, even after attempting to account of overdispersion with random effects.  I guess despite being discrete, this isn't really "count" data *per se*.

Model doesn't converge though.


```{r}
mnorm3 <- glmer(shts ~ log(shts_prev) * density_0_10 + (1|ha_id_number) + (1|year_post),
               family = gaussian(link = "log"),
               data = ha_cf)

AICtab(mnorm2, mnorm3)
```

Can't remove plot ID.

```{r}
mnorm4 <- glmer(shts ~ log(shts_prev) * density_0_10 + (1|year_post) + (1|plot),
               family = gaussian(link = "log"),
               data = ha_cf)
AICtab(mnorm2, mnorm4)
```

Can't remove plant ID

```{r}
mnorm5 <- glmer(shts ~ log(shts_prev) * density_0_10 + (1|ha_id_number) + (1|plot),
               family = gaussian(link = "log"),
               data = ha_cf)
AICtab(mnorm2, mnorm3, mnorm4, mnorm5)
```

Can't remove year as random effect.  

Inspect residuals:

```{r}
ha_aug <- augment(mnorm2)
h <-
  ggplot(ha_aug, aes(.resid)) +
  geom_histogram() 

qq <-
  ggplot(ha_aug, aes(sample = .resid)) +
  geom_qq() + geom_qq_line() 

resid<- 
  ggplot(ha_aug, aes(x = .fitted, y = .resid)) + geom_point() 
h/(qq|resid)
```
I don't love this, but it is a better fit than a poisson distribution.



# TODO: 

- ~~Density should be total shoot number~~
- ~~Should actually be density in previous year~~
- ~~Shoots should be poisson distribution, not log-transformed?~~
- incorporate 1-ha fragments and use habitat type as a predictor.
- Implement FLM approach to density dependence.
