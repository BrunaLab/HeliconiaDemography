---
title: "Density dependence"
author: "Eric R. Scott"
date: "2020-09-13"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
library(lme4)
library(bbmle)
library(car)
library(broom)
library(broom.mixed)
library(patchwork)
library(performance)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# TODO

- Get confidence intervals for cross-basis predictions.  Plot slices with confidence bands.

# Purpose

Start by looking for density dependence on growth, survival, and reproduction in continuous forests using the number of plants in the same grid-cell as a metric for density.

# Load Data

```{r data, echo=TRUE}
ha <- read_rds(here("analysis", "data", "derived_data", "ha_density.rds"))
ha
```
This is the main *Heliconia* dataset, but with densities of conspecifics (shoots/m^2^) at different rings with inner and outer radii in meters.  So, for example, the `shts_8_8.5` column is the number of *Heliconia* shoots/m^2^ in a ring 8 to 8.5 m around the focal plant.

The `x` and `y` coordinates are averages of data from 2006, 2007, and 2009, but joined to the full range of the dataset--assuming that plants don't move.

## Tidying and subsetting

```{r}
ha <-
  ha %>%
  ungroup() %>% 
  arrange(ha_id_number, year) %>% 
  #scale year, and convert to factor since I'll be using as random effect
  mutate(year_post = as_factor(year - min(year)))
```

Use just 1-ha and cf

```{r}
ha_sub <-
  ha %>% 
  filter(habitat %in% c("CF", "1-ha")) %>% 
  mutate(log_shts = log(shts),
         log_shts_next = log(shts_next),
         habitat = as.factor(habitat),
         ha_id_number = as.factor(ha_id_number))
```


# General model structure

For each vital rate I'll include the number of shoots and habitat as fixed effects and plant ID and year as random effects. For the mixed effects models I'll use density at just two rings (0--5m and 5--10m) as fixed effects. There are probably too few plots (4 1-ha and 6CF) to use plot as a random effect, but I don't know how to code it as a fixed effect right now.

```
vital_rate ~ log(shts) + habitat + shts_0_2.5 + shts_2.5_5 + (1|year) + (1|ha_id_number) + (1|habitat:plot)
```

```{r}
ha_sub %>% 
  group_by(habitat) %>% 
  summarize(length(unique(plot)))
```

# Growth

For this I'm going to use shoot number. Very closely related to height, but better behaved distribution and not sensitive to plants being knocked over.

## Distribution

Number of shoots is discrete, but not *really* count data.  I'll try a poisson distribution and a lognormal distribution.

```{r}
mpois <-
  glmer(
    shts_next ~ log_shts + habitat + shts_0_2.5 + shts_2.5_5 +
      (1|ha_id_number) + (1|year_post) + (1|habitat:plot),
    family = poisson(link = "log"),
    data = ha_sub
  )

check_overdispersion(mpois) #actually underdispersed

mnorm <-
  glmer(
    shts_next ~ log_shts + habitat + shts_0_2.5 + shts_2.5_5 +
      (1|ha_id_number) + (1|year_post) + (1|habitat:plot),
    family = gaussian(link = "log"),
    data = ha_sub
  )
```


```{r}
AICtab(mpois, mnorm)
compare_performance(mpois, mnorm, rank = TRUE)
```

Lognormal distribution fits best according to AIC, although poisson has lower RMSE.  I guess despite being discrete, this isn't really "count" data *per se*.  The lognormal model doesn't have problems with singularity that the poisson model has.  Both have problems with heteroscedasticity. A log-transformation of the response doesn't fix the heteroscedatsticyt either. I'll go with log-normal.

```{r}
m_growth <- mnorm
```

```{r}
x <- check_heteroscedasticity(m_growth)
plot(x)
```


## Random effects

Plot:

```{r}
m_growth2 <- update(m_growth, .~. - (1|habitat:plot))
AICtab(m_growth, m_growth2)
```

Plant ID:

```{r}
m_growth3 <- update(m_growth2, .~. - (1|ha_id_number))
AICtab(m_growth2, m_growth3)
```

Can't remove plant ID

Year:

```{r}
m_growth4 <- update(m_growth2, .~. - (1|year_post))
AICtab(m_growth, m_growth2, m_growth3, m_growth4)
```
Can remove year

## Does density matter beyond immediate surroundings?

```{r}
Anova(m_growth4)
fixef(m_growth4)
```

No density dependence

# Survival

Pre-reproductive census, so plants live/die in same year as `shts` and `ht`

```{r}
m_surv <-
  glmer(
    surv ~ log_shts + habitat + shts_0_2.5 + shts_2.5_5 +
      (1|ha_id_number) + (1|year_post) + (1|habitat:plot), 
    family = binomial, data = ha_sub
  )
```

## Random effects

Plot:

```{r}
m_surv2 <- update(m_surv, .~. - (1|habitat:plot))
AICtab(m_surv, m_surv2)
```

Plant ID:

```{r}
m_surv3 <- update(m_surv2, .~. - (1|ha_id_number))
AICtab(m_surv2, m_surv3)
```

Close to equivalent, so remove plant ID.  This makes sense, as plants only die once!

Year: 

```{r}
m_surv4 <- glm(surv ~ log_shts + habitat + shts_0_2.5 + shts_2.5_5, 
                family = binomial, data = ha_sub)
AICtab(m_surv4, m_surv3)
```
glm is best

## Density dependence?

```{r}
Anova(m_surv4)
coef(m_surv4)
```

Positive density dependence for survival.


# Flowering probability

Make a binary column

```{r}
ha_sub <- 
  ha_sub %>% 
  mutate(flwr = as.integer(infl > 0), .before = infl)

unique(ha_sub$flwr)
```

Can't do this model because no variation in flowering.

```{r eval=FALSE}
m_flwr <-
  glmer(
    flwr ~ log_shts + habitat + shts_0_2.5 + shts_2.5_5 +
      (1|ha_id_number) + (1|year_post) + (1|habitat:plot),
    family = binomial, data = ha_sub
  )
```

# Kernel approach

I'd like to take the approach in Teller et al. 2016, but the code is so convoluted that it is not adaptable. Instead, I'll start by trying to adapt the `dlnm` approach.

## Set up the crossbasis

```{r}
Q <-
  ha_sub %>%
  select(shts_0_0.5:shts_4.5_5) %>%
  as.matrix()

L <-
  matrix(seq(0.25, 4.75, by = 0.5), #use midpoint of r1 and r2
         nrow = nrow(Q),
         ncol = ncol(Q),
         byrow = TRUE)
```


```{r}
library(dlnm)
library(mgcv)
library(visibly) # better diagnostic visulazations.  one of several packages for this.
source(here("R", "utils.R"))
```

## Growth

```{r}
g_growth <-
  gam(shts_next ~ 
        s(log_shts) + #Essentially linear, could replace with parametric
        habitat +
        s(Q, L,
          bs = "cb",
          xt = list(bs = "cr")), #+
        # s(ha_id_number, bs = "re"), #this takes waaay too long to converge
      family = gaussian(link = "log"),
      data = ha_sub,
      method = "REML")
```


```{r}
plot_gam_check(g_growth)
```


```{r}
anova(g_growth)
```

Effect of size on size(t+1):

```{r}
plot(g_growth, pages = 1)
```

Effects of density:

```{r}
pred_growth <- pred_cb(Q, L, g_growth)
ggplot(pred_growth, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4) + 
  scale_y_continuous("distance (m)", expand = c(0,0)) +
  scale_x_continuous("conspecific density (shoots/m^2)", expand = c(0,0)) +
  scale_fill_viridis_c("#shoots (t+1)", option = "A")
```

## Survival

```{r}
g_surv <-
  gam(surv ~
        s(log_shts) +
        habitat +
        s(Q, L,
          bs = "cb",
          # k = c(10, 10),
          xt = list(bs = "cr")),
      family = binomial,
      data = ha_sub,
      method = "REML")
```

```{r}
# plot_gam_check(g_surv)
anova(g_surv)
```

Effect of size on survival:

```{r}
plot(g_surv, pages = 1)
```


```{r}
pred_surv <- pred_cb(Q, L, g_surv)
ggplot(pred_surv, aes(x = x, y = lag, z = fitted, fill = fitted)) +
  geom_raster(interpolate = TRUE) +
  geom_contour(color = "grey50", size = 0.4) + 
  scale_y_continuous("distance (m)", expand = c(0,0)) +
  scale_x_continuous("conspecific density (shoots/m^2)", expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A")
```

