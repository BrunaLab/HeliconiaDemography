---
title: "Density dependence"
author: "Eric R. Scott"
date: "2020-09-13"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
library(lme4)
library(bbmle)
library(car)
library(broom)
library(broom.mixed)
library(patchwork)
library(performance)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# Purpose

Start by looking for density dependence on growth, survival, and reproduction in continuous forests using the number of plants in the same grid-cell as a metric for density.

# Load Data

```{r data, echo=TRUE}
ha <- read_rds(here("analysis", "data", "derived_data", "ha_density.rds"))
ha
```

```{r}
ha <-
  ha %>% 
  group_by(ha_id_number) %>% 
  arrange(ha_id_number, year) %>% 
  ungroup() %>% 
  #scale year
  mutate(year_post = year - min(year))
```

Filter to just continuous forest

```{r}
ha_cf <- 
  ha %>% 
  filter(habitat == "CF") %>% 
  mutate(log_shts = log(shts),
         log_shts_next = log(shts_next))
```

Or filter to just 1-ha and cf

```{r}
ha_sub <-
  ha %>% 
  filter(habitat %in% c("CF", "1-ha")) %>% 
  mutate(log_shts = log(shts),
         log_shts_next = log(shts_next),
         habitat = as.factor(habitat))
```


I don't know what a height of 0 means...
Height of 0 probably means it was knocked over, or very small, or dead.

# General model structure

For each vital rate I'll include the number of shoots and habitat as fixed effects and plant ID and year as random effects.  I'm not including plot since there are few plots in each habitat type, and preliminary modeling shows the variance for plot is the lowest of those three random effects.

```{r}
ha_sub %>% 
  group_by(habitat) %>% 
  summarize(length(unique(plot)))
```

# Growth

For this I'm going to use shoot number. Very closely related to height, but better behaved distribution and not sensitive to plants being knocked over.

## Distribution

Number of shoots is discrete, but not *really* count data.  I'll try a poisson distribution and a lognormal distribution.

```{r}
mpois <- glmer(shts_next ~ log_shts + habitat + density_0_10 + density_10_20 + (1|ha_id_number) + (1|year_post),
                family = poisson(link = "log"),
                data = ha_sub)

check_overdispersion(mpois) #actually underdispersed

mnorm <- glmer(shts_next ~ log_shts + habitat + density_0_10 + density_10_20 + (1|ha_id_number) + (1|year_post),
                family = gaussian(link = "log"),
                data = ha_sub)
```

But how bad is this convergence failure?

Is the max|grad| calculation correct?

```{r}
derivs1 <- mnorm@optinfo$derivs
sc_grad1 <- with(derivs1, solve(Hessian, gradient))
max(abs(sc_grad1))
```
No, it's actually a lot smaller than `tol`, so nothing to worry about


```{r}
AICtab(mpois, mnorm)
compare_performance(mpois, mnorm, rank = TRUE)
```

Lognormal distribution fits best according to AIC, although poisson has lower RMSE.  I guess despite being discrete, this isn't really "count" data *per se*.  The lognormal model doesn't have problems with singularity that the poisson model has.  Both have problems with heteroscedasticity.  I'll go with log-normal.

```{r}
m_growth <- mnorm
```

```{r}
x<-check_heteroscedasticity(m_growth)
plot(x)
```

## Random effects

```{r}
m_growth2 <- glmer(shts_next ~ log_shts + habitat + density_0_10 + density_10_20 + (1|year_post),
               family = gaussian(link = "log"),
               data = ha_sub)
AICtab(m_growth, m_growth2)
```

Can't remove plant ID

```{r}
m_growth3 <- glmer(shts_next ~ log_shts + habitat + density_0_10 + density_10_20 + (1|ha_id_number),
               family = gaussian(link = "log"),
               data = ha_sub)
AICtab(m_growth, m_growth2, m_growth3)
```

## Does density matter beyond immediate surroundings?

```{r}
Anova(m_growth)
```

Odd, density further out is significant, but density close is not.

```{r}
fixef(m_growth)
```

Both weakly positive density dependence

# Survival

Pre-reproductive census, so plants live/die in same year as `shts` and `ht`

```{r}
m_surv <- glmer(surv ~ log_shts + habitat + density_0_10 + density_10_20 + (1|ha_id_number) + (1|year), 
                family = binomial, data = ha_sub)
```

## Random effects

```{r}
m_surv2 <- glmer(surv ~ log_shts + habitat + density_0_10 + density_10_20 + (1|year), 
                family = binomial, data = ha_sub)
AICtab(m_surv, m_surv2)
```

Close to equivalent, so remove plant ID.  This makes sense, as plants only die once!

```{r}
m_surv3 <- glm(surv ~ log_shts + habitat + density_0_10 + density_10_20, 
                family = binomial, data = ha_sub)
AICtab(m_surv2, m_surv3)
```
Can't remove year.

## Density dependence?

```{r}
Anova(m_surv2)
fixef(m_surv2)
```

Marginal effects on survival.

# Flowering probability

```{r}
ggplot(ha_sub, aes(infl)) + geom_histogram()
```
Make a binary column

```{r}
ha_sub <- 
  ha_sub %>% 
  mutate(flwr = as.integer(infl>0), .before = infl)

#the way suvival is currently coded, a plant can flower and then not survive in the same year, so no need to filter out dead plants.
ha_sub %>% filter(surv == 0 & flwr == 1)
```

```{r}
m_flwr <- glmer(flwr ~ log_shts + habitat + density_0_10 + density_10_20 + (1|ha_id_number) + (1|year),
                family = binomial, data = ha_sub)
```

## Random effects

```{r}
m_flwr2 <- glmer(flwr ~ log_shts + habitat + density_0_10 + density_10_20 + (1|year),
                 family = binomial, data = ha_sub)
AICtab(m_flwr, m_flwr2)
```
Can't remove plant ID.


```{r}
m_flwr3 <- glmer(flwr ~ log_shts + habitat + density_0_10 + density_10_20 + (1|ha_id_number),
                 family = binomial, data = ha_sub)
AICtab(m_flwr, m_flwr2, m_flwr3)
```

Can't remove year

## Density dependence?

```{r}
Anova(m_flwr)
fixef(m_flwr)
```

Ok, there's an effect, but oddly only past 20m.  Again, positive density dependence.

Probability of flowering increases with size and is lower in continuous forest

# Kernel approach

So it seems like there are effect of density at least out to 20m.  I'd like to take the approach in Teller et al. 2016, but the code is so convoluted that it is not adaptable. I want to start by trying to adapt the `dlnm` approach instead.

## Set up the crossbasis

```{r}
Q <-
  ha_sub %>%
  select(density_0_10:density_50_60) %>% 
  as.matrix()

L <-
  matrix(seq(5, 55, length.out = 6),
         nrow = nrow(Q), 
         ncol = 6,
         byrow = TRUE)
```

## GAM

```{r}
library(dlnm)
library(mgcv)

# Q_log <- log(Q+1)
g_growth <-
  gam(shts_next ~ s(log_shts) +
        habitat +
        s(Q, L,
          bs = "cb",
          k = c(5, 4),
          xt = list(bs = "cr")),
      family = gaussian(link = "log"),
      data = ha_sub,
      method = "REML")
```

## Predict

```{r}
x <- crosspred("Q", model = g_growth, cumul = TRUE)
summary(x)
```

## Plot crossbasis

### Contour plot

```{r}
plot.crosspred(x,
               ptype = "contour",
               xlab = "#shoots/100m^2",
               ylab = "distance (m)",
               cumul = FALSE)
```
So this shows negative density dependence that seems to be strongest at about 40-50 m away from the focal plant.

### Slices

We can also plot slices through the contour plot at different distances or different shoot densities

```{r}
plot.crosspred(x, ptype = "slice", var = 100, xlab = "distance (m)", main = "Effect of 100 shoots/100m^2")
plot.crosspred(x, ptype = "slice", var = 10, xlab = "distance (m)", main = "Effect of 10 shoots/100m^2")
```

### Cumulative

I think this shows the cumulative effect of density summed/integrated over all distances.  So, for example, a plant with about 30 shoots/100m^2 surrounding it out to the maximum distance (60m) would have the largest number of shoots, on average.

```{r}
plot(x, ptype = "overall", xlab = "density (shoots/100m^2)", cumul = TRUE)
```

There is no built-in function to get cumulative effects of density over all distances.

## Other shapes

It is odd that the strength of competition seems to be increasing with distance.  I'd like to be able to force the distance dimension to be monotonically decreasing as was done in Teller et al (I think?).  Teller does this *after* fitting a spline using `mk_dist_wts()`, which is a function that takes the spline coefficients, and predicted values from the spline, and transforms it into a non-negative, monotonic decreasing function.

You can override one of the dimensions of the cross basis with any custom function.


```{r}
#use arglag to override lag dimension of crossbasis, use argvar to override plant density dimension.
lin <- dlnm:::lin
xt <- list(bs = "cr", arglag = list(fun = "lin"))

g_growth <- 
  gam(shts_next ~ s(log_shts) +
        habitat +
        s(Q, L,
          bs = "cb",
          k = c(5, 4),
          fx = c(F, T), #turns off penalization for the lag dimension
          xt = xt),
      family = gaussian(link = "log"),
      data = ha_sub,
      gamma = 1.5)

gam.check(g_growth)
```

```{r}
x <- crosspred("Q", model = g_growth)
plot.crosspred(x, ptype = "contour", xlab = "#shoots/100m^2", ylab = "distance (m)")

plot.crosspred(x, ptype = "slice", var = 100)
plot.crosspred(x, ptype = "slice", var = 10)
```
Now the kernel is the same shape at every value of density.  However, this relationship doesn't make any sense.  Fewer knots?  More penalty?  Custom function?

```{r}
anova(g_growth)
```


# TODO: 

- ~~is density at 0 distance including the focal plant?  It shouldn't.~~
- Check number of inflorescences given flowered?
- ~~log-transform density (nah, not right now.  DOesn't help with convergence)~~
- ~~check that survival is coded right so that it is a function of `ht_prev`~~
- try negative binomial distribution for shoot number
- ~~Density should be total shoot number~~
- ~~Should actually be density in previous year~~
- ~~Shoots should be poisson distribution, not log-transformed?~~
- ~~incorporate 1-ha fragments and use habitat type as a predictor.~~
- Implement FLM approach to density dependence.
