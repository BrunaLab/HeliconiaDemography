---
title: "Density dependence"
author: "Eric R. Scott"
date: "2020-09-13"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
library(lme4)
library(bbmle)
library(car)
library(broom)
library(broom.mixed)
library(patchwork)
library(performance)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# Purpose

Start by looking for density dependence on growth, survival, and reproduction in continuous forests using the number of plants in the same grid-cell as a metric for density.

# Load Data

```{r data, echo=TRUE}
ha <- read_rds(here("analysis", "data", "derived_data", "ha_density.rds"))
ha
```

```{r}
ha <-
  ha %>% 
  group_by(ha_id_number) %>% 
  arrange(ha_id_number, year) %>% 
  ungroup() %>% 
  #scale year
  mutate(year_post = year - min(year))
```

Filter to just continuous forest

```{r}
ha_cf <- 
  ha %>% 
  filter(habitat == "CF") %>% 
  mutate(log_shts = log(shts),
         log_shts_next = log(shts_next))
```

Or filter to just 1-ha and cf

```{r}
ha_sub <-
  ha %>% 
  filter(habitat %in% c("CF", "1-ha")) %>% 
  mutate(log_shts = log(shts),
         log_shts_next = log(shts_next),
         habitat = as.factor(habitat))
```

Technically, the density data are only for 2006, 2007, and 2009, so I should really only use those three transition years.  This might still not be 100% correct.

```{r}
ha_sub_sub <-
  ha_sub %>% 
  filter(year %in% c(2006, 2007, 2009))
```


# General model structure

For each vital rate I'll include the number of shoots and habitat as fixed effects and plant ID and year as random effects.  I'm not including plot since there are few plots in each habitat type, and preliminary modeling shows the variance for plot is the lowest of those three random effects.

```{r}
ha_sub %>% 
  group_by(habitat) %>% 
  summarize(length(unique(plot)))
```

# Growth

For this I'm going to use shoot number. Very closely related to height, but better behaved distribution and not sensitive to plants being knocked over.

## Distribution

Number of shoots is discrete, but not *really* count data.  I'll try a poisson distribution and a lognormal distribution.

```{r}
mpois <- glmer(shts_next ~ log_shts + habitat + shts_0_5 + shts_5_10 + (1|ha_id_number) + (1|year_post),
                family = poisson(link = "log"),
                data = ha_sub)

check_overdispersion(mpois) #actually underdispersed

mnorm <- glmer(shts_next ~ log_shts + habitat + shts_0_5 + shts_5_10 + (1|ha_id_number) + (1|year_post),
                family = gaussian(link = "log"),
                data = ha_sub)
```


```{r}
AICtab(mpois, mnorm)
compare_performance(mpois, mnorm, rank = TRUE)
```

Lognormal distribution fits best according to AIC, although poisson has lower RMSE.  I guess despite being discrete, this isn't really "count" data *per se*.  The lognormal model doesn't have problems with singularity that the poisson model has.  Both have problems with heteroscedasticity.  I'll go with log-normal.

```{r}
m_growth <- mnorm
```

```{r}
x <- check_heteroscedasticity(m_growth)
plot(x)
```

## Random effects

Plant ID:

```{r}
m_growth2 <- update(m_growth, .~. - (1|ha_id_number))
AICtab(m_growth, m_growth2)
```

Can't remove plant ID

Year:

```{r}
m_growth3 <- update(m_growth, .~. - (1|year_post))
AICtab(m_growth, m_growth2, m_growth3)
```
Can't remove year

## Does density matter beyond immediate surroundings?

```{r}
Anova(m_growth)
fixef(m_growth)
```

Positive density dependence at 0--5 meters

Same for 3-year subset?

```{r}
mgrowth_sub <- update(m_growth, data = ha_sub_sub)
Anova(mgrowth_sub)
```

No longer significant.

# Survival

Pre-reproductive census, so plants live/die in same year as `shts` and `ht`

```{r}
m_surv <- glmer(surv ~ log_shts + habitat + shts_0_5 + shts_5_10 + (1|ha_id_number) + (1|year_post), 
                family = binomial, data = ha_sub)
```

## Random effects

Plant ID:

```{r}
m_surv2 <- update(m_surv, .~. - (1|ha_id_number))
AICtab(m_surv, m_surv2)
```

Close to equivalent, so remove plant ID.  This makes sense, as plants only die once!

Year: 

```{r}
m_surv3 <- glm(surv ~ log_shts + habitat + shts_0_5 + shts_5_10, 
                family = binomial, data = ha_sub)
AICtab(m_surv2, m_surv3)
```
Can't remove year.

## Density dependence?

```{r}
Anova(m_surv2)
fixef(m_surv2)
```

Positive density dependence for survival.


Does this hold for the 3-year subset?

```{r}
m_surv2_sub <- update(m_surv2, data = ha_sub_sub)
Anova(m_surv2_sub)
fixef(m_surv2_sub)
```

Yes, nearly identical coefs.

# Flowering probability

```{r}
ggplot(ha_sub, aes(infl)) + geom_histogram()
```
Make a binary column

```{r}
ha_sub <- 
  ha_sub %>% 
  mutate(flwr = as.integer(infl > 0), .before = infl)

#the way suvival is currently coded, a plant can flower and then not survive in the same year, so no need to filter out dead plants.
ha_sub %>% filter(surv == 0 & flwr == 1)
```

```{r}
m_flwr <- glmer(flwr ~ log_shts + habitat + shts_0_5 + shts_5_10 + (1|ha_id_number) + (1|year_post),
                family = binomial, data = ha_sub)
```

## Random effects

Plant ID:

```{r}
m_flwr2 <- update(m_flwr, .~. - (1|ha_id_number))
AICtab(m_flwr, m_flwr2)
```
Can't remove plant ID.

Year:

```{r}
m_flwr3 <- update(m_flwr, .~. - (1|year_post))
AICtab(m_flwr, m_flwr2, m_flwr3)
```

Can't remove year

## Density dependence?

```{r}
Anova(m_flwr)
fixef(m_flwr)
```

Ok, there's an effect, but oddly only at the further distance.  Again, positive density dependence.

Probability of flowering increases with size and is lower in continuous forest

No flowering data for 2006, 2007, and 2009.  These models won't run if the data are subset to only include these years.

# Kernel approach

**Not working yet**

So it seems like there are effect of density at least out to 20m.  I'd like to take the approach in Teller et al. 2016, but the code is so convoluted that it is not adaptable. I want to start by trying to adapt the `dlnm` approach instead.

## Set up the crossbasis

```{r eval=FALSE}
Q <-
  ha_sub %>%
  select(shts_0_0.5:shts_4.5_5) %>%
  as.matrix()

L <-
  matrix(seq(0.25, 4.75, by = 0.5), #use midpoint of r1 and r2
         nrow = nrow(Q),
         ncol = ncol(Q),
         byrow = TRUE)
```

## GAM

```{r eval=FALSE}
library(dlnm)
library(mgcv)

# Q_log <- log(Q+1)
g_growth <-
  gam(shts_next ~ s(log_shts) +
        habitat +
        s(Q, L,
          bs = "cb",
          # k = c(10, 10),
          xt = list(bs = "cr")) +
        s(year_post, bs = "re"),
      family = gaussian(link = "log"),
      data = ha_sub,
      method = "REML")
gam.check(g_growth)
anova(g_growth)
```

Marginally significant effect of conspecific density on growth

```{r eval=FALSE}
g_surv <-
  gam(surv ~ s(log_shts) +
        habitat +
        s(Q, L,
          bs = "cb",
          # k = c(10, 10),
          xt = list(bs = "cr")) +
        s(year_post, bs = "re"),
      family = binomial,
      data = ha_sub,
      method = "REML")
gam.check(g_surv)
anova(g_surv)
```
Marginally significant effect of density on survival


## Predict

Growth:
```{r eval=FALSE}
hist(Q)
pred_growth <- crosspred("Q", model = g_growth, cumul = TRUE, cen = mean(Q, na.rm = T), from = 0, to = 8)
pred_surv <- crosspred("Q", model = g_surv, cumul = TRUE, cen = mean(Q, na.rm = T), from = 0, to = 8)
# 
# summary(pred_growth)
```

## Plot Growth

```{r}
plot.crosspred(pred_growth,
               ptype = "contour",
               xlab = "#shoots/m^2",
               ylab = "distance (m)",
               cumul = FALSE,
               main = "Relative to mean competition")
```
Non-monotonic density dependence that decays steeply beyond 1m

### Slices

We can also plot slices through the contour plot at different distances or different shoot densities

```{r eval=FALSE}
plot.crosspred(pred_growth, ptype = "slice", var = 0.2, xlab = "distance (m)", main = "0.2 shoots/m^2", ylim = c(0.9,1.1))
plot.crosspred(pred_growth, ptype = "slice", var = 1, xlab = "distance (m)", main = "1 shoots/m^2", ylim = c(0.9,1.1))
plot.crosspred(pred_growth, ptype = "slice", var = 2, xlab = "distance (m)", main = "2 shoots/m^2", ylim = c(0.9,1.1))
plot.crosspred(pred_growth, ptype = "slice", var = 8, xlab = "distance (m)", main = "8 shoots/m^2", ylim = c(0.9,1.1))
```

```{r}
plot.crosspred(pred_growth, ptype = "slice", lag = 0.25, xlab = "density (shoots/m^2)", main = "0.25m", ylim = c(0.9,1.1))
plot.crosspred(pred_growth, ptype = "slice", lag = 1.25, xlab = "density (shoots/m^2)", main = "1.25m", ylim = c(0.9,1.1))
plot.crosspred(pred_growth, ptype = "slice", lag = 3.25, xlab = "density (shoots/m^2)", main = "3.25m", ylim = c(0.9,1.1))
plot.crosspred(pred_growth, ptype = "slice", lag = 4.25, xlab = "density (shoots/m^2)", main = "4.25m", ylim = c(0.9,1.1))
```

## Plot Survival

```{r}
plot.crosspred(pred_surv,
               ptype = "contour",
               xlab = "#shoots/m^2",
               ylab = "distance (m)",
               cumul = FALSE,
               main = "Relative to mean competition")
```
Postive density dependence that drops off steeply after 1m

## Other shapes

It is odd that the strength of competition seems to be increasing with distance.  I'd like to be able to force the distance dimension to be monotonically decreasing as was done in Teller et al (I think?).  Teller does this *after* fitting a spline using `mk_dist_wts()`, which is a function that takes the spline coefficients, and predicted values from the spline, and transforms it into a non-negative, monotonic decreasing function.

You can override one of the dimensions of the cross basis with any custom function.


```{r eval=FALSE}
#use arglag to override lag dimension of crossbasis, use argvar to override plant density dimension.
lin <- dlnm:::lin
xt <- list(bs = "cr", arglag = list(fun = "lin"))

g_growth <- 
  gam(shts_next ~ s(log_shts) +
        habitat +
        s(Q, L,
          bs = "cb",
          k = c(5, 4),
          fx = c(F, T), #turns off penalization for the lag dimension
          xt = xt),
      family = gaussian(link = "log"),
      data = ha_sub,
      gamma = 1.5)

gam.check(g_growth)
```

```{r eval=FALSE}
x <- crosspred("Q", model = g_growth)
plot.crosspred(x, ptype = "contour", xlab = "#shoots/100m^2", ylab = "distance (m)")

plot.crosspred(x, ptype = "slice", var = 100)
plot.crosspred(x, ptype = "slice", var = 10)
```
Now the kernel is the same shape at every value of density.  However, this relationship doesn't make any sense.  Fewer knots?  More penalty?  Custom function?

```{r eval=FALSE}
anova(g_growth)
```


# TODO: 

- ~~is density at 0 distance including the focal plant?  It shouldn't.~~
- Check number of inflorescences given flowered?
- ~~log-transform density (nah, not right now.  DOesn't help with convergence)~~
- ~~check that survival is coded right so that it is a function of `ht_prev`~~
- try negative binomial distribution for shoot number
- ~~Density should be total shoot number~~
- ~~Should actually be density in previous year~~
- ~~Shoots should be poisson distribution, not log-transformed?~~
- ~~incorporate 1-ha fragments and use habitat type as a predictor.~~
- Implement FLM approach to density dependence.
