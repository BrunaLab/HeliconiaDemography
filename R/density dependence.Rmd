---
title: "Density dependence"
author: "Eric R. Scott"
date: "2020-09-13"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
library(lme4)
library(bbmle)
library(car)
library(broom)
library(broom.mixed)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# Purpose

Start by looking for density dependence on growth, survival, and reproduction in continuous forests using the number of plants in the same grid-cell as a metric for density.

# Load Data

```{r data, echo=TRUE}
ha <- read_rds(here("analysis", "data", "derived_data", "ha_density.rds"))
ha
```
Filter to just continuous forest
```{r}
ha_cf <- 
  ha %>% 
  filter(habitat == "CF") %>% 
  mutate(log_ht = log(ht),
         log_ht_prev = log(ht_prev))
```

I don't know what a height of 0 means...

```{r}
ha_cf <- ha_cf %>% filter(ht > 0, ht_prev > 0)
```


# Growth

```{r}
m <- lmer(log_ht ~ log_ht_prev + density_0_10 + (1|year) + (1|plot), data = ha_cf)
summary(m)
m2 <- lmer(log_ht ~ log_ht_prev + density_0_10 + (1|year), data = ha_cf)
m3 <- lmer(log_ht ~ log_ht_prev + density_0_10 + (1|plot), data = ha_cf)
m4 <- lm(log_ht ~ log_ht_prev + density_0_10, data = ha_cf)
AICtab(m, m2, m3, m4)
```

keep both random effects, possibly remove random effect of plot.

```{r}
m <- lmer(log_ht ~ log_ht_prev + density_0_10 + (1|year) + (1|plot), data = ha_cf)
Anova(m)
```

Density matters?

```{r}
augment(m) %>% 
  ggplot(aes(.resid)) +
  geom_histogram()
```

residuals look leptokurtic.

```{r}
augment(m) %>% 
  ggplot(aes(sample = .resid)) +
  geom_qq() + geom_qq_line()
```

Try scaled T distribution

```{r}
library(mgcv)
library(gamm4)
m <- gamm4(log_ht ~ log_ht_prev + density_0_10, random = ~ (1|year) + (1|plot), family = scat, data = ha_cf)
m <- gam(log_ht ~ log_ht_prev + density_0_10, family = scat, data = ha_cf)
coef(m)
augment(m) %>% 
  ggplot(aes(.resid)) +
  geom_histogram()

augment(m) %>% 
  ggplot(aes(sample = .resid)) +
  geom_qq() + geom_qq_line()
```

Maybe something like a gamma distribution on un-transformed values?  Or use shoots..

```{r}
m <- lmer(log(shts) ~ log(shts_prev) + density_0_10 + (1|year) + (1|plot), data = ha_cf)
Anova(m)
augment(m) %>% 
  ggplot(aes(.resid)) +
  geom_histogram()

augment(m) %>% 
  ggplot(aes(sample = .resid)) +
  geom_qq() + geom_qq_line()
```
Ok, yeah.  That's a good reason to use # of shoots maybe?

```{r}
Anova(m)
```

Density matters!

```{r}
m <- lmer(log(shts) ~ log(shts_prev) * density_0_10 + (1|year) + (1|plot), data = ha_cf)
fixef(m)
Anova(m)
```

Interaction doesn't! (bless)

```{r}
m <- lmer(log(shts) ~ log(shts_prev) + density_0_10 + density_10_20 + density_20_30 + (1|year) + (1|plot), data = ha_cf)
fixef(m)
Anova(m)
```

Ah, density further away matters as well.  Collinearity, probably, so don't trust p-values!


Ok, gotta do GAMs I guess!