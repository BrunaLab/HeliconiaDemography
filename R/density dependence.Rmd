---
title: "Density dependence"
author: "Eric R. Scott"
date: "2020-09-13"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
library(lme4)
library(bbmle)
library(car)
library(broom)
library(broom.mixed)
library(patchwork)
library(performance)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# Purpose

Start by looking for density dependence on growth, survival, and reproduction in continuous forests using the number of plants in the same grid-cell as a metric for density.

# Load Data

```{r data, echo=TRUE}
ha <- read_rds(here("analysis", "data", "derived_data", "ha_density.rds"))
ha
```
Actually interested in density in the previous year

```{r}
ha <-
  ha %>% 
  group_by(ha_id_number) %>% 
  arrange(ha_id_number, year) %>% 
  # mutate(across(starts_with("density"), lag, .names = "prev_{col}")) %>%
  mutate(across(starts_with("density"), lag)) %>% 
  ungroup() %>% 
  # filter(!is.na(prev_density_0_10)) %>% 
  #scale year
  mutate(year_post = year - min(year))
```

Filter to just continuous forest

```{r}
ha_cf <- 
  ha %>% 
  filter(habitat == "CF") %>% 
  mutate(log_shts = log(shts),
         log_shts_prev = log(shts_prev))

```

I don't know what a height of 0 means...
Height of 0 probably means it was knocked over, or very small, or dead.


# Growth

For this I'm going to use shoot number. Very closely related to height, but better behaved distribution and not sensitive to plants being knocked over.

## Distribution

Number of shoots is discrete, but not *really* count data.  I'll try a poisson distribution and a lognormal distribution.

```{r}
mpois <- glm(shts ~ log_shts_prev + density_0_10 + density_10_20,
             family = poisson(link = "log"),
             data = ha_cf)
lm <- lm(shts ~ log_shts_prev + density_0_10 + density_10_20,
         data = ha_cf)
mnorm <- glm(shts ~ log_shts_prev + density_0_10 + density_10_20,
             family = gaussian(link = "log"),
             data = ha_cf)
mpois2 <- glmer(shts ~ log_shts_prev + density_0_10 + density_10_20 + (1|ha_id_number) + (1|year_post) + (1|plot),
                family = poisson(link = "log"),
                data = ha_cf)

check_overdispersion(mpois2) #actually underdispersed

mnorm2 <- glmer(shts ~ log_shts_prev + density_0_10 + density_10_20 + (1|ha_id_number) + (1|year_post) + (1|plot),
                family = gaussian(link = "log"),
                data = ha_cf)

AICtab(mpois, mnorm, lm, mpois2, mnorm2)
compare_performance(mpois, mnorm, mpois2, mnorm2, rank = TRUE)
```

Lognormal distribution fits best according to AIC, although poisson has lower RMSE.  I guess despite being discrete, this isn't really "count" data *per se*.  The lognormal model doesn't problems with singularity that the poisson model has.  Both have problems with heteroscedasticity.

```{r}
check_convergence(mnorm2)
check_singularity(mpois2)
check_singularity(mnorm2)
x<-check_heteroscedasticity(mnorm2)
plot(x)
```

## Random effects

```{r}
mnorm3 <- glmer(shts ~ log_shts_prev * density_0_10 + (1|ha_id_number) + (1|year_post),
               family = gaussian(link = "log"),
               data = ha_cf)

AICtab(mnorm2, mnorm3)
```

Can't remove plot ID.

```{r}
mnorm4 <- glmer(shts ~ log_shts_prev * density_0_10 + (1|year_post) + (1|plot),
               family = gaussian(link = "log"),
               data = ha_cf)
AICtab(mnorm2, mnorm4)
```

Can't remove plant ID

```{r}
mnorm5 <- glmer(shts ~ log_shts_prev * density_0_10 + (1|ha_id_number) + (1|plot),
               family = gaussian(link = "log"),
               data = ha_cf)
AICtab(mnorm2, mnorm3, mnorm4, mnorm5)
```

## Does density matter beyond immediate surroundings?

```{r}
Anova(mnorm2)
```


Apparently not! Weird! It is highly significant when I was accidentally modeling density in the same year. This is not due to removing rows from the first year either.  This is somewhat concerning!

# Survival

Should this be a function of `log_shts` or `log_shts_prev`?  Think about how you've coded survival.

```{r}
m_surv <- glmer(surv ~ log_shts + density_0_10 + density_10_20 + (1|plot) + (1|ha_id_number) + (1|year), 
                family = binomial, data = ha_cf)
```

## Random effects

```{r}
m_surv2 <- glmer(surv ~ log_shts + density_0_10 + density_10_20 + (1|plot) + (1|year), 
                family = binomial, data = ha_cf)
AICtab(m_surv, m_surv2)
```
Can remove plant ID
```{r}
m_surv3 <- glmer(surv ~ log_shts + density_0_10 + density_10_20 + (1|year), 
                family = binomial, data = ha_cf)
AICtab(m_surv2, m_surv3)
```
Can't remove plot

```{r}
m_surv4 <- glmer(surv ~ log_shts + density_0_10 + density_10_20 + (1|plot), 
                family = binomial, data = ha_cf)
AICtab(m_surv2, m_surv4)
```
Can't remove year.

## Density dependence?

```{r}
Anova(m_surv2)
fixef(m_surv2) %>% plogis()
```

Marginal, and only immediate grid cell.  Density has positive affect on survival.  So, probably just good patches.

# Flowering probability

```{r}
ggplot(ha_cf, aes(infl)) + geom_histogram()
```
Make a binary column

```{r}
ha_cf <- 
  ha_cf %>% 
  mutate(flwr = as.integer(infl>0), .before = infl)

#the way suvival is currently coded, a plant can flower and then not survive in the same year, so no need to filter out dead plants.
ha_cf %>% filter(surv == 0)
```

```{r}
m_flwr <- glmer(flwr ~ log_shts_prev + density_0_10 + density_10_20 + (1|ha_id_number) + (1|plot) + (1|year), family = binomial, data = ha_cf)
```

## Random effects

```{r}
m_flwr2 <- glmer(flwr ~ log_shts_prev + density_0_10 + density_10_20 + (1|ha_id_number) + (1|year), family = binomial, data = ha_cf)
AICtab(m_flwr, m_flwr2)
```
can get rid of plot ID

```{r}
m_flwr3 <- glmer(flwr ~ log_shts_prev + density_0_10 + density_10_20 + (1|year), family = binomial, data = ha_cf)
AICtab(m_flwr, m_flwr2, m_flwr3)
```
keep plant ID

```{r}
m_flwr4 <- glmer(flwr ~ log_shts_prev + density_0_10 + density_10_20 + (1|ha_id_number), family = binomial, data = ha_cf)
AICtab(m_flwr, m_flwr2, m_flwr3, m_flwr4)
```

keep year

## Density dependence?

```{r}
Anova(m_flwr2)
fixef(m_flwr2) %>% plogis()
```

Ok, there's an effect, but oddly only past 20m.  Again, positive density dependence.

# TODO: 

- Check number of inflorescencesa given flowered?
- check that survival is coded right so that it is a function of `ht_prev`
- try negative binomial distribution for shoot number
- ~~Density should be total shoot number~~
- ~~Should actually be density in previous year~~
- ~~Shoots should be poisson distribution, not log-transformed?~~
- incorporate 1-ha fragments and use habitat type as a predictor.
- Implement FLM approach to density dependence.
