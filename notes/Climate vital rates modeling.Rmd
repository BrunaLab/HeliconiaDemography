---
title: "Drought effects on vital rates"
author: "Eric R. Scott"
date: "Date Initiated"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(janitor)
library(conflicted)
library(lubridate)
library(equatiomatic)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# Goal

Here's what needs to happen.  One script needs to calculate demographic rates for each transition (year) and plot combination and use those to get a lambda for each transition.  Rows would be year:plot combinations.

A second script needs to put SPEI values in a wide format with rows = years and cols = months starting at whatever month the census was done in (I think February).  So the colnames would be like:

feb, jan, dec, nov, oct, sep, aug, jul, jun, may, apr, mar

A third script would combine these datasets and implement the DLNLM (gasparini) / FLM (teller) GAM approach.





# Purpose

Begin to play around with modeling effects of drought on vital rates

# Load Data

```{r data, echo=TRUE}
precip <- read_csv(here("analysis", "data", "raw_data", "mon_precip_spi_imputed.csv"))
demog <- read_csv(here("analysis", "data", "raw_data", "Ha_survey_with_Zombies.csv"), col_names = TRUE,
               cols(plot = col_character(),
                    bdffp_reserve_no = col_character(),
                    shts = col_integer(),
                    year = col_integer(),
                    infl = col_integer(),
                    tag_number = col_character(),
                    HA_ID_Number = col_character())) %>% 
  clean_names()
min(demog$year)
max(demog$year)
```


# Wrangling

Need to match up demography with climate in some way.  As a preliminary pass, I'll calculate average SPI/SPEI and total precip for the growing season (MONTHS?) for each year and match the rain gauge sites to the demographic plots.

```{r}
unique(demog$ranch)
unique(demog$bdffp_reserve_no)
demog %>% filter(bdffp_reserve_no == "1202")
unique(precip$site)
```

km41 = 1501
km37 = ??
florestal = 1301
cabo frio = 3402
Porto Alegre = 3114
Colosso = 1104, 1202
Dimona = 2206, 2108, 2107

colosso_clust = 1301, 3402, 1104, 1202

```{r}
demog <- 
  demog %>% 
  mutate(site = case_when(
    bdffp_reserve_no == "1501" ~ "km_clust",
    bdffp_reserve_no == "3114" ~ "porto_alegre",
    bdffp_reserve_no %in% c("1301", "3402", "1104", "1202") ~ "colosso_clust",
    bdffp_reserve_no %in% c("2206", "2108", "2107") ~ "dimona"
  ))
```

Aggregate precip data by growing season so just one value per year.

Flowering season =  jan - april
Fruits ripening = may - june
Dry season = june - dec

```{r}
ggplot(precip, aes(x = month(date, label = TRUE), y = precip_tot)) + 
  geom_violin(draw_quantiles = .5)
```
```{r}
flwr <-
  precip %>% 
  mutate(month = month(date),
         year = year(date)) %>% 
  filter(month %in% c(1:4)) %>% 
  group_by(year, site) %>% 
  summarize(spi_flwr = mean(spi),
            spei_flwr = mean(spei),
            precip_flwr = sum(precip_tot))

fruit <-
  precip %>% 
  mutate(month = month(date),
         year = year(date)) %>% 
  filter(month %in% c(5:6)) %>% 
  group_by(year, site) %>% 
  summarize(spi_fruit = mean(spi),
            spei_fruit = mean(spei),
            precip_fruit = sum(precip_tot))

dry <-
  precip %>% 
  mutate(month = month(date),
         year = year(date)) %>% 
  filter(month %in% c(7:12)) %>% 
  group_by(year, site) %>% 
  summarize(spi_dry = mean(spi, na.rm = TRUE),
            spei_dry = mean(spei, na.rm = TRUE),
            precip_dry = sum(precip_tot))
wet <-
  precip %>% 
  mutate(month = month(date),
         year = year(date)) %>% 
  filter(month %in% c(1:5)) %>% 
  group_by(year, site) %>% 
  summarize(spi_wet = mean(spi, na.rm = TRUE),
            spei_wet = mean(spei, na.rm = TRUE),
            precip_wet = sum(precip_tot))

precip <- full_join(flwr, fruit,by = c("year", "site")) %>% full_join(dry, by = c("year", "site")) %>% full_join(wet, by = c("year", "site"))
```
join to demography data

```{r}
full <- left_join(demog, precip, by = c("year", "site"))
```

# Analysis

Ok, let's start with something simple like growth.  Census happen in late Jan or Feb, so change in height would be predicted by previous year's rainy season.

```{r}
full <- full %>% 
  group_by(ha_id_number) %>% 
  arrange(ha_id_number, year) %>% 
  mutate(ht_prev = lag(ht))
```

```{r}
m <- lm(ht ~ ht_prev*spi_wet, data = full)
summary(m)
anova(m)
extract_eq(m, use_coefs = TRUE)
```
$$
\operatorname{ht} = 5.77 + 0.87(\operatorname{ht\_prev}) - 0.14(\operatorname{spi\_wet}) + 0.01(\operatorname{ht\_prev} \times \operatorname{spi\_wet}) + \epsilon
$$

- higher SPI in the wet season (wetter) = less growth.
- positive interaction term means larger plants (more/less?) impacted by spi in the wet season
