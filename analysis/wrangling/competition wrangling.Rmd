---
title: "Competition"
author: "Eric R. Scott"
date: "2020-09-09"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(conflicted)
library(glue)
library(car)
library(skimr)
library(furrr)
library(janitor)

library(HeliconiaDemography) #load functions in this compendium

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
```

*Last compiled: `r Sys.Date()`*

# TODO:
 - move main function to .R file and document
 
# Summary

In order to test for density dependence, we used data from three surveys where exact coordinates (to the nearest 0.1m) of each plant relative to the plot were recorded. THe 2009 survey was to assess the effects of safe-site limitation on recruitment (Bruna et al. 2010) and the 2006 and 2007 surveys were for ____ (unpublished data). For each plot and year, we calculated the density of conspecific shoots in annuli at varying distances from focal plants, as in Teller et al. (date). Density was calculated for 5 annuli ranging from an inner radius of 0m and an outer radius of 0.5m (i.e. a circle of radius 0.5m) to an inner radius of 4.5m and and outer radius of 5m. If an annulus intersected with the edge of the plot, the density for that particular plant and annulus was considered as a missing value.  Conspecific density was estimated as the number of *H. acuminata* shoots per m^2^. We used the three transition years for which we had density data to model the effects of conspecific density on survival, growth, and reproduction of *H. acuminata* (in a separate .Rmd file).

# Load Data

```{r data, echo=TRUE}
# demographic data
ha <- read_rds(here("analysis", "data", "derived_data", "ha_survey.rds"))
# data from previous study: Uriarte M, Bruna EM, Rubim P, et al (2010) Effects
# of forest fragmentation on the seedling recruitment of a tropical herb:
# assessing seed vs. safe-site limitation. Ecology 91:1317â€“1328.
# https://doi.org/10.1890/09-0785.1

coords_0607 <-
  read.table(here("analysis", "data", "raw_data", "adults0607_light.txt")) %>%
  as_tibble() %>%
  clean_names()
```


`ha` contains x and y coords for each plant from 2009 *within each grid cell*.  `coords` contains x and y coordinates for each plant in 2006 and 2007 relative to the entire plot.  I need to join these data sources and offset the coordinates in the `ha` dataset correctly.

# Join data

Getting things to match up:

```{r}
coords_0607 <- 
  coords_0607 %>% 
  select(year = yr, plot = site, tag_number, row, column, plot_x, plot_y, x, y) %>% 
  mutate(plot = case_when(
    plot == "Cabo Frio" ~ "CaboFrio-CF",
    plot == "Dimona CF" ~ "Dimona-CF",
    plot == "Florestal" ~ "Florestal-CF",
    plot == "PA-CF" ~ "PortoAlegre-CF",
    TRUE ~ plot
  )) 
# filter(coords_0607, is.na(x))
```

```{r}
coords_09 <-
  ha %>% 
  filter(year == 2009, !is.na(x_09), !is.na(y_09))
# filter(coords_09, is.na(x_09))
```

Adjust x and y coords to be for entire plot and not just within row/col cell

```{r}
coord_adj <-
  bind_rows(
  expand_grid(
    tibble(row = LETTERS[1:5],
           plot_y = 5:1),
    tibble(column = 1:10,
           plot_x = 1:10)
  ) %>% add_column(plot = "2107"),
  
  expand_grid(
    tibble(row = LETTERS[1:5],
           plot_y = 1:5),
    tibble(column = 1:10,
           plot_x = 10:1)
  ) %>% add_column(plot = "2108"),
  
  expand_grid(
    tibble(row = LETTERS[1:5],
           plot_y = 1:5),
    tibble(column = 1:10,
           plot_x = 1:10)
  ) %>% add_column(plot = "Dimona-CF"),
  
  expand_grid(
    tibble(row = LETTERS[1:5],
           plot_y = 5:1),
    tibble(column = 1:10,
           plot_x = 1:10)
  ) %>% add_column(plot = "5753"),

  expand_grid(
    tibble(row = LETTERS[1:5],
           plot_y = 1:5),
    tibble(column = 1:10,
           plot_x = 10:1)
  ) %>% add_column(plot = "PortoAlegre-CF"),

  expand_grid(
    tibble(row = LETTERS[1:5],
           plot_y = 1:5),
    tibble(column = 1:10,
           plot_x = 1:10)
  ) %>% add_column(plot = "CaboFrio-CF"),

  expand_grid(
    tibble(row = LETTERS[1:5],
           plot_y = 1:5),
    tibble(column = 1:10,
           plot_x = 10:1)
  ) %>% add_column(plot = "5751"),

  expand_grid(
    tibble(row = LETTERS[1:5],
           plot_y = 1:5),
    tibble(column = 1:10,
           plot_x = 10:1)
  ) %>% add_column(plot = "Florestal-CF"),

  expand_grid(
    tibble(row = LETTERS[1:10],
           plot_y = 10:1),
    tibble(column = 6:10,
           plot_x = 5:1)
  ) %>% add_column(plot = "5750"),

  expand_grid(
    tibble(row = LETTERS[1:5],
           plot_y = 1:5),
    tibble(column = 1:10,
           plot_x = 1:10)
  ) %>% add_column(plot = "5756")
)
```


Get the `plot_x` and `plot_y` variables into the 2009 data to adjust the coordinates correctly.

```{r}
coords_09.2 <- left_join(coords_09, coord_adj, by = c("plot", "row", "column"))
```

There are still plants with row/column combinations that I wouldn't expect:

```{r}
coords_09.2 %>% filter(is.na(plot_x)) %>% 
  select(plot, row, column, ha_id_number)
```
Now, use the plot_x and plot_y variables to correctly offset the x and y coords from 2009.

```{r}
coords_09.3 <- 
  coords_09.2 %>% 
  mutate(x_adj = x_09 + ((plot_x - 1) * 10),
         y_adj = y_09 + ((plot_y - 1) * 10),
         .after = y_09)
```

# Bind rows to combine data

```{r}
ha_coords <-
  bind_rows(
  coords_09.3 %>% 
  select(year, plot, tag_number, row, column, x = x_adj, y = y_adj),
  coords_0607 %>% select(-plot_x, -plot_y)
)
ha_coords
```


# Join to demography data 

To model the effect of density, I'm only going to use the subset of plants that I have coordinates for.

```{r}
ha_xy <- right_join(ha %>% select(-x_09, -y_09), ha_coords, by = c("plot", "row", "column", "tag_number", "year"))
```

What percentage of plants have coordinates?

```{r}
full_join(ha %>% select(-x_09, -y_09),
          ha_coords,
          by = c("plot", "row", "column", "tag_number", "year")) %>% 
  group_by(ha_id_number) %>% 
  summarize(has_coord = any(!is.na(x))) %>%  #true if there is a non-NA value for at least one year
  summarize(percent_with_coords = sum(has_coord)/n())
```


# Calculate density

Now the challenge is to calculate the density of surrounding shoots for every focal plant at different distances.


## Proof of concept

Start with single plot

```{r}
y1p1 <- ha_xy %>% 
  filter(year == first(year),
         plot == first(plot))
y1p1
```

```{r}
# df <- y1p1
# L = 0
# U = 10
# by = 0.5
add_density_cols <- function(df, L, U, by, na_edges = TRUE, per_area = TRUE) {
  
  eu_dist <- function(p1, p2) {
    sqrt(sum((p1 - p2)^2))
  }
    
  d <- seq(L, U, by = by)

  df_out <- 
    future_map_dfr(1:nrow(df), function(r) { #loop through rows/plants
      #get coordinates for that plant
      focal_plant <- t(df[r, c("x", "y")])
      # focal_plant <- c(0,0)
      
      if (na_edges) {
        #don't do calculations for rings that go outside the plot
        edge_dist <- min(c(focal_plant, c(100, 50) - focal_plant))
        d2 <- d[which(d < edge_dist)]
      } else {
        d2 <- d
      }
      
      #calculate distance to every other plant
      focal_df <-
        df %>%
        rowwise() %>%
        mutate(dist = eu_dist(focal_plant, c(x, y))) %>% 
        ungroup()
      
      # If plant is near edge, return NAs
      
      #get total number of shoots at every ring
      if (length(d2) > 1) {
          future_map2_dfc(lag(d2)[-1], d2[-1],
                        ~ transmute(
                          focal_df,
                          !!glue("shts_{.x}_{.y}") :=
                            shts * (dist > .x & dist <= .y)
                        )
        ) %>% 
          #excludes focal plant with dist == 0
          summarize(across(everything(), ~sum(., na.rm = TRUE)), .groups = "drop")
        
      } else {
        # if all the rings go outside the plot, then return an empty row
        tibble_row()
      }
    })
  
  if (per_area) {
    # Divide by areas of donuts to get shoots/m^2
    d3 <- d[1:(ncol(df_out) + 1)] #in case largest radii are outside of plot for every plant
    A <- pi * (d3[-1]^2 - lag(d3)[-1]^2) #area of donut
    df_out <- map2_dfc(df_out, A, ~.x/.y) #divide each column by each area
  }

  df_out <- bind_cols(df, df_out) #join to original data
  return(df_out)
}


add_density_cols(y1p1, L = 0, U = 5, by = 0.5)

```


```{r}
plan(multiprocess)
```

## Apply to entire dataset

```{r}
ha_density <-
  ha_xy %>% 
  group_by(plot, year) %>% 
  group_split() %>% 
  # head() %>% #test with 6 df to see how long it will take.
  future_map(~{
    add_density_cols(.x, L = 0, U = 5, by = 0.5)
  }) %>% 
  future_map(~{
    add_density_cols(.x, L = 0, U = 1, by = 1) #first meter seems most important
  }) %>% 
  bind_rows()
beepr::beep(4)
```


# Write to file

```{r}
write_rds(ha_density, here("analysis", "data", "derived_data", "ha_density.rds"))
```

