---
title: "FLM for growth as function of SPEI"
author: "Eric R. Scott"
date: "Date Initiated"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
library(tidyverse)
library(here)
library(mgcv)
library(dlnm)
library(bbmle)
library(lubridate)
library(glue)
library(patchwork)
# library(sf)
library(tsibble)
library(broom)
library(gratia)
library(latex2exp)

library(conflicted)
conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("slice", "dplyr")

library(HeliconiaDemography) #load functions in this compendium
# devtools::load_all()
```


*Last compiled: `r Sys.Date()`*

# TODO:

- ~~Switch measure of plant size to shoots * height~~
- ~~Change lag to 36 months (3 years)~~
- Produce ridge plot
- Heatmap for growth should be ∆size
- try select = TRUE (after you understand it better? blog about it first)

# Purpose

Take a crack at modeling vital rates as a function of previous height and lagged, non-linear, SPEI.

# Load Data


```{r}
demog_full <- read_rds(here("analysis", "data", "derived_data", "ha_spei_combined.rds"))
```

## Tidy

There are plants with 0 shoots and 0 ht.  I will remove those, as having no above ground biomass is really not a size, but a different category.
There's also a couple of plants that are probably data entry errors in height.

```{r}
demog_full <-
  demog_full %>% 
  filter(ht < 200 | is.na(ht), ht_prev < 200 | is.na(ht_prev)) %>%
  filter(
    # having no aboveground biomass is possible, but categorically different than just being small. Exclude plants with 0 shoots or 0 height
    shts_prev > 0,
    ht_prev > 0,
    #for survival data, must include plants with NA for shts and height (i.e. dead plants)
    shts > 0 | is.na(shts), 
    ht > 0 | is.na(ht)
  ) %>%
  mutate(size = shts*ht, size_prev = shts_prev * ht_prev, log_size = log(size), log_size_prev = log(size_prev))
```


`gam` wants factors!

```{r}
demog_full <-
  demog_full %>% 
  mutate(across(c(ranch, bdffp_reserve_no, plot, habitat, ha_id_number), as.factor)) %>% 
  mutate(year_fac = as.factor(year))
# View(demog_full)
```


# Splitting up data

Because I can't model interactions with DLNMs, I can either include factors like habitat as predictors (different intercepts, same functional form, same data) or fit separate models (potentially different functional forms, but not using all the data).

```{r}
demog_post <- 
  demog_full %>% 
  filter(code_notes != "sdlg (1)" | is.na(code_notes))

demog_post_cf <-
  demog_post %>% 
  filter(habitat == "CF")

demog_post_1ha <-
  demog_post %>% 
  filter(habitat == "1-ha")
```


# Speed up models with bam()

I'm going to start fitting these with `bam()` to speed things up.  This sets up the paralellization.  CAUTION: you may need to change these settings for your machine.

```{r}
library(parallel)
ncores <- detectCores()
cl <- makeForkCluster(ncores - 2)
```

# Survival
`surv` is 1 in `year`s when a plant is alive and 0 in the first `year` when the plant is dead.  These GAMs model the survival of a plant (over the past year) as a function of size in the previous census and SPEI values starting at february of the current year going back 36 months.
## Fit GAMs

```{r}
s_post_cf <-
  bam(surv ~ 
        s(log_size_prev, bs = "cr") +
        s(plot, bs = "re") + #random intercept
        # s(plot, log_size_prev, bs = "re") + #random slope
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_cf,
      method = "REML",
      select = TRUE,
      cluster = cl)
```


```{r}
# appraise(s_post_cf)
#quantile residuals are better with discrete response variable.
library(statmod)
#histogram
plot(density(qresid(s_post_cf)))
#QQ plot
qqnorm(qresid(s_post_cf)); qqline(qresid(s_post_cf))
#Fitted vs. residuals
scatter.smooth(predict(s_post_cf, type = "response"), qresid(s_post_cf), col = "grey")
```

```{r}
summary(s_post_cf)
```

```{r}
s_post_1ha <-
  bam(surv ~ 
        s(log_size_prev, bs = "cr") +
        s(plot, bs = "re") +
        # s(plot, log_size_prev, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_1ha,
      method = "REML",
      select = TRUE,
      cluster = cl)
```
```{r}
#histogram
plot(density(qresid(s_post_1ha)))
#QQ plot
qqnorm(qresid(s_post_1ha)); qqline(qresid(s_post_1ha))
#Fitted vs. residuals
scatter.smooth(predict(s_post_1ha, type = "response"), qresid(s_post_1ha), col = "grey")
```

```{r}
summary(s_post_1ha)
```

## Covariate plots

Plot smooth for size

```{r}
s_1ha_eval1 <-
  smooth_estimates(s_post_1ha, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~plogis(.x + coef(s_post_1ha)[1])))

ggplot(s_1ha_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  geom_rug(data = model.frame(s_post_1ha)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(survival)", title = "1-ha fragments")
ggsave(here("analysis", "figures", "surv_1ha_size.png"))
```

```{r}
s_cf_eval1 <-
  smooth_estimates(s_post_cf, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~plogis(.x + coef(s_post_cf)[1])))

ggplot(s_cf_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  geom_rug(data = model.frame(s_post_cf)) + 
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(survival)", title = "Continuous forest")
ggsave(here("analysis", "figures", "surv_cf_size.png"))
```

Combine and plot together

```{r}
bind_rows("1-ha" = s_1ha_eval1, "CF" = s_cf_eval1, .id = "habitat") %>% 
  ggplot(aes(x = log_size_prev, color = habitat)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, color = NULL, fill = habitat), alpha = 0.25) +
  geom_rug(data = bind_rows(
    "1-ha" = model.frame(s_post_1ha),
    "CF" = model.frame(s_post_cf), 
    .id = "habitat"),
    color = "black") +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(survival)")
ggsave(here("analysis", "figures", "surv_both_size.png"))
```

Emilio suggested plotting curves from all 1-ha plots just to visualize the variation. But the random effect of plot is not significant, so there is actually very little variation among plots in the model.

```{r}
new_data <-
  tidyr::expand(model.frame(s_post_1ha),
                nesting(plot),
                log_size_prev = seq(min(log_size_prev), max(log_size_prev), length.out = 50),
                spei_history = mean(spei_history), L = L)
m1pred <- bind_cols(new_data,
          as.data.frame(predict(s_post_1ha, newdata = new_data, se.fit = TRUE, type = "response")))
ggplot(m1pred, aes(x = log_size_prev, y = fit, group = plot)) + geom_line()
```

The wide confidence intervals are probably due to lower sample size at this size of plant.

## Crossbasis plot

### Setup for all crossbasis plots
Ok, I want to add a lil strip on the bottom that shows dry and wet seasons.  Wet = November-may, dry = june-october.

```{r}
wet_xmaxs = c(3, 15, 27, 36)
wet_xmins = c(0, 8, 20, 32)
dry_xmaxs = c(8, 20, 32)
dry_xmins = c(3, 15, 27)
df <- tibble(x = 0:36)
season_bar <- 
  ggplot(df, aes(x = x, y = 1)) +
  annotate(geom = "rect", xmin = wet_xmins, xmax = wet_xmaxs, ymin = 0.975, ymax = 1.025, fill = "black") +
  annotate(geom = "rect", xmin = dry_xmins, xmax = dry_xmaxs, ymin = 0.975, ymax = 1.025, fill = "white") +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  theme_void()
```


```{r}
breaks <- seq(0,36, by = 2)
```

### Get plot data
`dist` isn't working yet in `smooth_estimates`, but that's ok because I don't need CI for these plots (yet).

```{r}
s_1ha_eval <-
  evaluate_smooth(s_post_1ha, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = plogis(est + coef(s_post_1ha)[1]))
s_cf_eval <-
  evaluate_smooth(s_post_cf, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = plogis(est + coef(s_post_cf)[1]))

surv_lims <- c(min(s_1ha_eval$est, s_cf_eval$est, na.rm = TRUE),
                  max(s_1ha_eval$est, s_cf_eval$est, na.rm = TRUE))
```


### 1ha

```{r}
s_1ha_rotated <-
  ggplot(s_1ha_eval, aes(y = spei_history, x = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.002) +
  geom_hline(aes(yintercept = 0), color = "grey", linetype = 2) +
  scale_fill_viridis_c("P(survival)", option = "viridis", limits = surv_lims) +
  scale_x_continuous(
    "lag (months before census)",
    breaks = breaks,
    expand = c(0, 0)
  ) +
  scale_y_continuous(TeX("SPEI_3_"), expand = expansion(mult = c(0.025, 0)))+ #leave room for season bar at bottom
  labs(title = "1ha fragments") +
  theme_bw() +
  annotation_custom(grob = ggplotGrob(season_bar), ymin = -Inf, ymax = min(s_cf_eval$spei_history), xmin = -Inf, xmax = Inf) +
  NULL
```

### CF

```{r}
s_cf_rotated <-
  ggplot(s_cf_eval, aes(y = spei_history, x = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.002) +
  geom_hline(aes(yintercept = 0), color = "grey", linetype = 2) +
  scale_fill_viridis_c("P(survival)", option = "viridis", limits = surv_lims) +
  scale_x_continuous(
    "lag (months)",
    breaks = breaks,
    expand = c(0, 0)
  )+
  scale_y_continuous(TeX("SPEI_3_"), expand = expansion(mult = c(0.025, 0))) +
  labs(title = "Continuous Forest") +
  theme_bw() +
  annotation_custom(grob = ggplotGrob(season_bar), ymin = -Inf, ymax = min(s_cf_eval$spei_history), xmin = -Inf, xmax = Inf) +
  NULL

```

### Combine

```{r}
(s_cf_rotated + theme(axis.title.x = element_blank())) / 
  (s_1ha_rotated) + 
  plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = "a", tag_suffix = ")") & 
  labs(title = NULL) #remove plot titles
ggsave(here("analysis", "figures", "surv_both_spei.png"), width = 7, height = 5)
```

### Difference
Try plotting a raster of the difference between CF and 1-ha

```{r}
s_diff_rotated <- 
  bind_cols(
  s_cf_eval %>% rename_with(.fn = ~glue("cf_{.}")),
  s_1ha_eval %>% rename_with(.fn = ~glue("frag_{.}"))
  ) %>%
  mutate(diff = cf_est - frag_est) %>% 
  ggplot(aes(x = cf_L, y = cf_spei_history, fill = diff, z = diff)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.002) +
  geom_hline(aes(yintercept = 0), color = "grey", linetype = 2) +
  scale_fill_viridis_c("∆Survival (CF – 1ha)", option = "viridis") +
  scale_x_continuous(
    "lag (months before census)",
    breaks = breaks,
    expand = c(0, 0)
  )+
  scale_y_continuous(TeX("SPEI_3_"), expand = expansion(mult = c(0.025, 0))) +
  labs(title = "CF – 1-ha") +
  theme_bw() +
  annotation_custom(grob = ggplotGrob(season_bar), ymin = -Inf, ymax = min(s_cf_eval$spei_history), xmin = -Inf, xmax = Inf) +
  NULL
ggsave(here("analysis", "figures", "surv_diff_spei.png"),plot = s_diff_rotated, width = 7, height = 2.5)
```


# Growth
For mature plants that are alive...

```{r}
demog2_post_cf <- demog_post_cf %>% filter(surv == 1, !is.na(log_size))
demog2_post_1ha <- demog_post_1ha %>% filter(surv == 1, !is.na(log_size))
```


## Fit GAMs

Fit the GAM with crossbasis smooth for lagged drought.
Using a scaled-t family distribution because residuals were leptokurtic with a gaussian.
Preliminary modeling showed that if year is included as random effect it is concurve with SPEI history (which would mean biased p-values and coefficients).

The transformed response and identity link is actually better than a log-link, according to Ellner, Childs and Rees.

```{r}
g_post_cf <-
  bam(log_size ~ 
        s(log_size_prev, bs = "cr") + 
        s(plot, bs = "re") + #random effect of plot on intercept
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #unimodal-ish response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      # family = gaussian(link = "identity"),
      family = scat(link = "identity"), #like leptokurtic gaussian.
      data = demog2_post_cf,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

Inspect the GAM

```{r}
AIC(g_post_cf)
appraise(g_post_cf)
```

AIC for... 
Gaussian: ~40909.27. looks leptokurtic
scaled t: ~37284.47.  Waaay better

```{r}
summary(g_post_cf)
```

Remember, R-sq is probably so high because size this year is a very good predictor of size next year.


```{r}
g_post_1ha <-
  bam(log_size ~ 
        s(log_size_prev, bs = "cr") +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #unimodal response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      family = scat(link = "identity"), #like leptokurtic gaussian.
      data = demog2_post_1ha,
      select = TRUE,
      method = "REML",
      cluster = cl)
```

```{r}
appraise(g_post_1ha)
```

```{r}
summary(g_post_1ha)
```

## Covariate plots


```{r}
g_1ha_eval1 <-
  smooth_estimates(g_post_1ha, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~.x + coef(s_post_1ha)[1]))

ggplot(g_1ha_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  # geom_abline(slope = 1, linetype = 2, color = "red") +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  geom_rug(data = model.frame(g_post_1ha)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = TeX("$log(size_{t+1})"), title = "1-ha fragments")
ggsave(here("analysis", "figures", "growth_1ha_size.png"))
```
```{r}
g_cf_eval1 <-
  smooth_estimates(g_post_cf, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~.x + coef(s_post_cf)[1]))

ggplot(g_cf_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  # geom_abline(slope = 1, linetype = 2, color = "red") +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  geom_rug(data = model.frame(g_post_cf)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = TeX("$log(size_{t+1})"), title = "Continuous forest")
ggsave(here("analysis", "figures", "growth_cf_size.png"))
```

Both together

```{r}
bind_rows("1-ha" = g_1ha_eval1, "CF" = g_cf_eval1, .id = "habitat") %>% 
  ggplot(aes(x = log_size_prev)) +
  geom_line(aes(y = est, color = habitat)) +
  geom_abline(slope = 1, linetype = 2, color = "red") +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = habitat), alpha = 0.25) +
  geom_rug(data = bind_rows(
    "1-ha" = model.frame(g_post_1ha),
    "CF" = model.frame(g_post_cf),
    .id = "habitat")) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = TeX("$log(size_{t+1})"))
ggsave(here("analysis", "figures", "growth_both_size.png"))
```



## Crossbasis plot

### Get plot data
`dist` isn't working yet in `smooth_estimates`, but that's ok because I don't need CI for these plots (yet).

```{r}
g_1ha_eval <-
  evaluate_smooth(g_post_1ha, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = est + coef(g_post_1ha)[1])
g_cf_eval <-
  evaluate_smooth(g_post_cf, smooth = "spei_history", dist = 0.1)  %>% 
  mutate(est = est + coef(g_post_cf)[1])

grow_lims <- c(min(g_1ha_eval$est, g_cf_eval$est, na.rm = TRUE),
               max(g_1ha_eval$est, g_cf_eval$est, na.rm = TRUE))
```

### 1ha

```{r}
g_1ha_rotated <-
  ggplot(g_1ha_eval, aes(y = spei_history, x = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.05) +
  geom_hline(aes(yintercept = 0), color = "grey", linetype = 2) +
  scale_fill_viridis_c(TeX("$log(size_{t+1})$"), option = "viridis", limits = grow_lims) +
  scale_x_continuous(
    "lag (months before census)",
    breaks = breaks,
    expand = c(0, 0)
  )+
  scale_y_continuous(TeX("SPEI_3_"), expand = expansion(mult = c(0.025, 0)))+ #leave room for season bar at bottom
  labs(title = "1ha fragments") +
  theme_bw() +
  annotation_custom(grob = ggplotGrob(season_bar), ymin = -Inf, ymax = min(s_cf_eval$spei_history), xmin = -Inf, xmax = Inf) +
  NULL
```

### CF

```{r}
g_cf_rotated <-
  ggplot(g_cf_eval, aes(y = spei_history, x = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.05) +
  geom_hline(aes(yintercept = 0), color = "grey", linetype = 2) +
  scale_fill_viridis_c(TeX("$log(size_{t+1})$"), option = "viridis", limits = grow_lims) +
  scale_x_continuous(
    "lag (months before census)",
    breaks = breaks,
    expand = c(0, 0)
  )+
  scale_y_continuous(TeX("SPEI_3_"), expand = expansion(mult = c(0.025, 0)))+ #leave room for season bar at bottom
  labs(title = "Continuous forest") +
  theme_bw() +
  annotation_custom(grob = ggplotGrob(season_bar), ymin = -Inf, ymax = min(s_cf_eval$spei_history), xmin = -Inf, xmax = Inf) +
  NULL
```

### Combine
combine
```{r}
(g_cf_rotated + theme(axis.title.x = element_blank())) / 
  (g_1ha_rotated) + 
  plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = "a", tag_suffix = ")") & 
  labs(title = NULL) #remove plot titles
ggsave(here("analysis", "figures", "growth_both_spei.png"), width = 7, height = 5)
```
### Difference

```{r}
g_diff_rotated <- 
  bind_cols(
  g_cf_eval %>% rename_with(.fn = ~glue("cf_{.}")),
  g_1ha_eval %>% rename_with(.fn = ~glue("frag_{.}"))
  ) %>%
  mutate(diff = cf_est - frag_est) %>% filter(diff == max(diff, na.rm = TRUE))
  ggplot(aes(x = cf_L, y = cf_spei_history, fill = diff, z = diff)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.05) +
  geom_hline(aes(yintercept = 0), color = "grey", linetype = 2) +
  scale_fill_viridis_c(TeX("$\\Delta log(size_{t+1})$ (CF – 1ha)"), option = "viridis") +
  scale_x_continuous(
    "lag (months before census)",
    breaks = breaks,
    expand = c(0, 0)
  )+
  scale_y_continuous(TeX("SPEI_3_"), expand = expansion(mult = c(0.025, 0))) +
  labs(title = "CF – 1-ha") +
  theme_bw() +
  annotation_custom(grob = ggplotGrob(season_bar), ymin = -Inf, ymax = min(s_cf_eval$spei_history), xmin = -Inf, xmax = Inf) +
  NULL
ggsave(here("analysis", "figures", "growth_diff_spei.png"),plot = g_diff_rotated, width = 7, height = 2.5)
```


# Flowering Probability

## Fit GAMs

```{r}
x <- demog_post$flwr
sum(x, na.rm = TRUE) / length(x)
```

Around 5 percent of plants flowered.

```{r}
f_post_cf <-
  bam(flwr ~ 
        s(log_size_prev, bs = "cr") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35), 
          xt = list(bs = "cr")),
      family = binomial,
      data = demog2_post_cf,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

Doesn't converge with random effect of year

```{r}
#histogram
plot(density(qresid(f_post_cf)))
#QQ plot
qqnorm(qresid(f_post_cf)); qqline(qresid(f_post_cf))
#Fitted vs. residuals
scatter.smooth(predict(f_post_cf, type = "response"), qresid(f_post_cf), col = "grey")
```

these residuals are troubling

```{r}
summary(f_post_cf)
```



```{r}
f_post_1ha <-
  bam(flwr ~ 
        s(log_size_prev, bs = "cr") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),
          xt = list(bs = "cr")),
      family = binomial,
      data = demog2_post_1ha,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

```{r}
#histogram
plot(density(qresid(f_post_1ha)))
#QQ plot
qqnorm(qresid(f_post_1ha)); qqline(qresid(f_post_1ha))
#Fitted vs. residuals
scatter.smooth(predict(f_post_1ha, type = "response"), qresid(f_post_1ha), col = "grey")
```

```{r}
summary(f_post_1ha)
```

```{r}
plogis(coef(f_post_1ha)[1])
plogis(coef(f_post_cf)[1])
```
Overall probability of flowering higher in continuous forest (0.008) compared to 1ha fragments (0.003)

## Covariate plots

Plot smooth for size

```{r}
f_1ha_eval1 <-
  smooth_estimates(f_post_1ha, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~plogis(.x + coef(f_post_1ha)[1])))

ggplot(f_1ha_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  # stat_summary_bin(geom = "point", fun = mean, aes(y = flwr), data = model.frame(f_post_1ha)) +
  geom_rug(data = model.frame(f_post_1ha)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(flowering)", title = "1-ha fragments")
ggsave(here("analysis", "figures", "flwr_1ha_size.png"))
```

```{r}
f_cf_eval1 <-
  smooth_estimates(f_post_cf, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~plogis(.x + coef(f_post_cf)[1])))

ggplot(f_cf_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  # stat_summary_bin(geom = "point", fun = mean, aes(y = flwr), data = model.frame(f_post_cf)) +
  geom_rug(data = model.frame(f_post_cf)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(flowering)", title = "Continuous forest")
ggsave(here("analysis", "figures", "flwr_cf_size.png"))
```

combine and plot

```{r}
bind_rows("1-ha" = f_1ha_eval1, "CF" = f_cf_eval1, .id = "habitat") %>% 
  ggplot(aes(x = log_size_prev)) +
  geom_line(aes(y = est, color = habitat)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = habitat), alpha = 0.25) +
  # stat_summary_bin(geom = "point", fun = mean, aes(y = flwr), data = model.frame(f_post_cf)) +
  geom_rug(data = bind_rows(
    "1-ha" = model.frame(f_post_1ha),
    "CF" = model.frame(f_post_cf),
    .id = "habitat")) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(flowering)")
ggsave(here("analysis", "figures", "flwr_both_size.png"))
```
```{r paged.print=FALSE}
demog_full %>% filter(ht < 1)
demog_full %>% 
  # filter(log_size > 7) %>%
  filter(shts >= 4) %>% 
  group_by(habitat) %>% 
  summarise(flower_prob = mean(flwr, na.rm = TRUE))

coef(f_post_1ha)[1] %>% plogis()
```

Opposite of what plot shows.

## Crossbasis plot
### Get plot data
`dist` isn't working yet in `smooth_estimates`, but that's ok because I don't need CI for these plots (yet).

```{r}
f_1ha_eval <-
  evaluate_smooth(f_post_1ha, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = plogis(est + coef(f_post_1ha)[1]))
f_cf_eval <-
  evaluate_smooth(f_post_cf, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = plogis(est + coef(f_post_cf)[1]))

flwr_lims <- c(min(f_1ha_eval$est, f_cf_eval$est, na.rm = TRUE),
               max(f_1ha_eval$est, f_cf_eval$est, na.rm = TRUE))
```

### 1ha

```{r}
f_1ha_rotated <-
  ggplot(f_1ha_eval, aes(y = spei_history, x = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.001) +
  geom_hline(aes(yintercept = 0), color = "grey", linetype = 2) +
  scale_fill_viridis_c("P(flowering)", option = "viridis", limits = flwr_lims) +
  scale_x_continuous(
    "lag (months before census)",
    breaks = breaks,
    expand = c(0, 0)
  )+
  scale_y_continuous(TeX("SPEI_3_"), expand = expansion(mult = c(0.025, 0)))+ #leave room for season bar at bottom
  labs(title = "1ha fragments") +
  theme_bw() +
  annotation_custom(grob = ggplotGrob(season_bar), ymin = -Inf, ymax = min(s_cf_eval$spei_history), xmin = -Inf, xmax = Inf) +
  NULL
```

### CF
```{r}
f_cf_rotated <-
  ggplot(f_cf_eval, aes(y = spei_history, x = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.001) +
  geom_hline(aes(yintercept = 0), color = "grey", linetype = 2) +
  scale_fill_viridis_c("P(flowering)", option = "viridis", limits = flwr_lims) +
  scale_x_continuous(
    "lag (months before census)",
    breaks = breaks,
    expand = c(0, 0)
  )+
  scale_y_continuous(TeX("SPEI_3_"), expand = expansion(mult = c(0.025, 0)))+ #leave room for season bar at bottom
  labs(title = "Continuous forest") +
  theme_bw() +
  annotation_custom(grob = ggplotGrob(season_bar), ymin = -Inf, ymax = min(s_cf_eval$spei_history), xmin = -Inf, xmax = Inf) +
  NULL
```
### Combine
combine
`
```{r}
  (f_cf_rotated + theme(axis.title.x = element_blank())) / 
  (f_1ha_rotated) + 
  plot_layout(guides = "collect") + 
  plot_annotation(tag_levels = "a", tag_suffix = ")") & 
  labs(title = NULL) #remove plot titles
ggsave(here("analysis", "figures", "flwr_both_spei.png"), width = 7, height = 5)
```
### Difference

```{r}
f_diff_rotated <- 
  bind_cols(
  f_cf_eval %>% rename_with(.fn = ~glue("cf_{.}")),
  f_1ha_eval %>% rename_with(.fn = ~glue("frag_{.}"))
  ) %>%
  mutate(diff = cf_est - frag_est) %>% 
  ggplot(aes(x = cf_L, y = cf_spei_history, fill = diff, z = diff)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.001) +
  geom_hline(aes(yintercept = 0), color = "grey", linetype = 2) +
  scale_fill_viridis_c("∆Flowering (CF – 1ha)", option = "viridis") +
  scale_x_continuous(
    "lag (months before census)",
    breaks = breaks,
    expand = c(0, 0)
  )+
  scale_y_continuous(TeX("SPEI_3_"), expand = expansion(mult = c(0.025, 0))) +
  labs(title = "CF – 1-ha") +
  theme_bw() +
  annotation_custom(grob = ggplotGrob(season_bar), ymin = -Inf, ymax = min(s_cf_eval$spei_history), xmin = -Inf, xmax = Inf) +
  NULL
ggsave(here("analysis", "figures", "flwr_diff_spei.png"),plot = f_diff_rotated, width = 7, height = 2.5)
```

