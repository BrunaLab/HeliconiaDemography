---
title: "FLM for growth as function of SPEI"
author: "Eric R. Scott"
date: "Date Initiated"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
library(tidyverse)
library(here)
library(mgcv)
library(dlnm)
library(bbmle)
library(lubridate)
library(glue)
library(patchwork)
library(sf)
library(tsibble)
library(broom)
library(gratia)
library(latex2exp)

library(conflicted)
conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("slice", "dplyr")

library(HeliconiaDemography) #load functions in this compendium
# devtools::load_all()
```

```{r}
#define plotting themes
theme_talk <- theme_bw() + theme(text = element_text(size = 18))
```

*Last compiled: `r Sys.Date()`*

# TODO:

- ~~Switch measure of plant size to shoots * height~~
- ~~Change lag to 36 months (3 years)~~
- Produce ridge plot
- Heatmap for growth should be ∆size
- try select = TRUE (after you understand it better? blog about it first)

# Purpose

Take a crack at modeling vital rates as a function of previous height and lagged, non-linear, SPEI.

# Load Data

```{r data, echo=TRUE}
xa <- read_rds(here("analysis", "data", "derived_data", "xa_spei_lags.rds"))
demog <-
  read_csv(
    here("analysis", "data", "derived_data", "ha_survey.csv"),
    col_names = TRUE,
    cols(plot = col_character(),
         bdffp_reserve_no = col_character())
  )
plot_coords <- read_csv(here("analysis", "data", "raw_data", "plot_coords.csv"))
```

# Join data sets

## Prep precip data

Get only rows for february (the month of the census), and year for joining

```{r}
xa2 <- 
  xa %>%
  filter(month(yearmonth) == 2) %>% 
  mutate(year = year(yearmonth), .after =yearmonth) %>% 
  separate(latlon, into = c("lat", "lon"), sep = "_")
xa2
```

Figure out which sites correspond to which grid cells.  The `xa` lat lon are the centers of grid cells that are 0.25º^2

```{r}
unique(xa2$lat)
mean(c(-2.25, -2.5))
```

So, from -2.25 to -2.5

```{r}
unique(xa2$lon)
mean(c(-59.5, -59.75))
mean(c(-59.75, -60)) # Florestal-CF, 5752, 5751, 5750, 5756, CaboFrio-CF
mean(c(-60, -60.25)) # 2206, 2108, 2107, Dimona-CF, 5753, PortoAlegre-CF
```

```{r}
plot_coords
```

```{r}
demog2 <-
  demog %>% 
  mutate(lon = case_when(
    plot %in% c("Florestal-CF", "5752", "5751", "5750", "5756", "CaboFrio-CF") ~ "-59.875",
    plot %in% c("2206", "2108", "2107", "Dimona-CF", "5753", "PortoAlegre-CF") ~ "-60.125",
    TRUE ~ NA_character_
  ), .before = plot)
demog_full <- 
  left_join(demog2, xa2, by = c("lon", "year")) %>% 
  select(-lon, -lat, -yearmonth)
```

## Tidy

There are plants with 0 shoots and 0 ht.  I will remove those, as having no above ground biomass is really not a size, but a different category.
There's also a couple of plants that are probably data entry errors in height.

```{r}
demog_full <-
  demog_full %>% 
  filter(ht < 200 | is.na(ht), ht_prev < 200 | is.na(ht_prev)) %>%
  filter(
    # having no aboveground biomass is possible, but categorically different than just being small. Exclude plants with 0 shoots or 0 height
    shts_prev > 0,
    ht_prev > 0,
    #for survival data, must include plants with NA for shts and height (i.e. dead plants)
    shts > 0 | is.na(shts), 
    ht > 0 | is.na(ht)
  ) %>%
  mutate(size = shts*ht, size_prev = shts_prev * ht_prev, log_size = log(size), log_size_prev = log(size_prev))
```


`gam` wants factors!

```{r}
demog_full <-
  demog_full %>% 
  mutate(across(c(ranch, bdffp_reserve_no, plot, habitat, ha_id_number), as.factor)) %>% 
  mutate(year_fac = as.factor(year))
# View(demog_full)
```


# Splitting up data

Because I can't model interactions with DLNMs, I can either include factors like habitat as predictors (different intercepts, same functional form, same data) or fit separate models (potentially different functional forms, but not using all the data).

```{r}
demog_post <- 
  demog_full %>% 
  filter(code_notes != "sdlg (1)" | is.na(code_notes))

demog_post_cf <-
  demog_post %>% 
  filter(habitat == "CF")

demog_post_1ha <-
  demog_post %>% 
  filter(habitat == "1-ha")

demog_sdlg <- 
  demog_full %>% 
  filter(code_notes == "sdlg (1)")

demog_sdlg_cf <- 
  demog_sdlg %>% 
  filter(habitat == "CF")

demog_sdlg_1ha <- 
  demog_sdlg %>% 
  filter(habitat == "1-ha")
```

# Inspect raw data

```{r}
demog_plotdf <-  
  demog_post %>% 
  filter(habitat !="10-ha") %>% 
  select(ranch, bdffp_reserve_no, plot, habitat, year, ht, shts, size, surv, flwr) %>% 
  mutate(date = paste(year, "-02-01") %>% ymd(),
         yearmonth = yearmonth(date))
```

## SPEI

```{r}
dates <- range(demog_post$year) %>% paste0(., "-02-01") %>% ymd()
census_dates <- min(demog_post$year)[1]:max(demog_post$year) %>% paste(., "-02-01") %>% ymd()

spei <-
  xa %>%
  select(latlon, yearmonth, spei) %>%
  filter(!is.na(spei)) %>% 
  ggplot(aes(x = yearmonth, y = spei)) + 
  geom_line(aes(group = latlon), alpha = 0.2) +
  stat_summary(geom = "line", fun = "mean") +
  scale_y_continuous("SPEI", expand = expansion(mult = c(0, 0.05), add = 0)) +
  scale_x_yearmonth("Date", limits = dates, breaks = census_dates, date_minor_breaks ="1 month", expand = expansion(mult = 0.02)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

spei <- annotate_spei(spei)
spei
```
```{r}
demog_post %>% filter(spei_history[,36] > 2) %>% pull(year) %>% unique()
demog_post %>% filter(year == min(year)) %>% filter(surv == 0)
```

## Survival

```{r}
demog_post %>% ggplot(aes(x = surv)) + geom_bar() + facet_wrap(~habitat)
```

```{r}
demog_post %>% 
  group_by(habitat) %>% 
  summarize(surv = sum(surv, na.rm = TRUE) / n())
```

Survival nearly identical for 1 ha and CF.

### Timeseries

```{r}
survival <-
  demog_plotdf %>%  
  ggplot(aes(x = yearmonth, y = surv, color = habitat)) +
  stat_summary(geom = "line", fun = "mean", fun.args = list(na.rm = TRUE)) +
  stat_summary(geom = "pointrange", fatten = 1) +
  scale_x_yearmonth(limits = dates, breaks = census_dates, date_minor_breaks ="1 month", expand = expansion(mult = 0.02)) +
  scale_y_continuous("P(survived)") +
  theme_bw() +
  theme(axis.text.x = element_blank(), axis.title.x = element_blank(), axis.ticks.x = element_blank(), panel.grid.minor.x = element_blank())
survival
# (survival / spei) 
```
Looks like survival went down year after 2003 drought and during 2007 drought.

## Size / growth

```{r}
demog_post %>% ggplot(aes(x = habitat, y = log_size)) + geom_boxplot()
```
```{r}
demog_post %>% 
  group_by(habitat) %>% 
  summarize(size = mean(size, na.rm = TRUE),
            shts = mean(shts, na.rm = TRUE),
            ht = mean(ht, na.rm = TRUE))
```

### Timeseries

```{r}
size <-
  demog_plotdf %>% 
  ggplot(aes(x = yearmonth, y = size, color = habitat)) +
  stat_summary(geom = "line", fun = "mean", fun.args = list(na.rm = TRUE)) +
  stat_summary(geom = "pointrange", fatten = 1) +
  scale_x_yearmonth(limits = dates, breaks = census_dates, date_minor_breaks ="1 month", expand = expansion(mult = 0.02)) +
  scale_y_continuous("Size") +
  theme_bw() +
  theme(axis.text.x = element_blank(), axis.title.x = element_blank(), axis.ticks.x = element_blank(), panel.grid.minor.x = element_blank())
size
# size/survival/spei
```
Average plant size shrank in 2003 drought, but not 2007 drought

## Flowering

```{r}
demog_post %>% ggplot(aes(x = flwr)) + geom_bar() + facet_wrap(~habitat)
```
### Timeseries

```{r}
flowering <-
  demog_plotdf %>% 
  ggplot(aes(x = yearmonth, y = flwr, color = habitat)) + 
  stat_summary(geom = "line", fun = "mean") +
  stat_summary(geom = "pointrange", fatten = 1) +
  scale_x_yearmonth(limits = dates, breaks = census_dates, date_minor_breaks ="1 month", expand = expansion(mult = 0.02)) +
  scale_y_continuous("P(flowering)") +
  theme_bw() +
  theme(axis.text.x = element_blank(), axis.title.x = element_blank(), axis.ticks.x = element_blank(), panel.grid.minor.x = element_blank())
flowering
```
```{r}
demog_plotdf %>% filter(year == 2003) %>% group_by(habitat) %>% summarize(flwr = mean(flwr, na.rm = TRUE))
```


```{r}
size/survival/flowering/spei +
  plot_layout(guides = "collect") &
  theme(plot.margin = margin(2,1,1,1)) &
  guides(col = guide_legend(title = "Habitat"))
ggsave(here("analysis", "figures", "eda.png"), height = 7, width = 10)
```



# Speed up models with bam()

I'm going to start fitting these with `bam()` to speed things up.  This sets up the paralellization.  CAUTION: you may need to change these settings for your machine.

```{r}
library(parallel)
ncores <- detectCores()
cl <- makeForkCluster(ncores - 2)
```

# Survival
`surv` is 1 in `year`s when a plant is alive and 0 in the first `year` when the plant is dead.  These GAMs model the survival of a plant (over the past year) as a function of size in the previous census and SPEI values starting at february of the current year going back 36 months.
## Fit GAMs

```{r}
s_post_cf <-
  bam(surv ~ 
        s(log_size_prev, bs = "cr") +
        # s(year) +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_cf,
      method = "REML",
      select = TRUE,
      cluster = cl)
```


```{r}
# gam.check(s_post_cf) #not sure what to expect from any of these plots
appraise(s_post_cf)
# concurvity(s_post_cf, full = FALSE)
```

```{r}
summary(s_post_cf)
```

```{r}
s_post_1ha <-
  bam(surv ~ 
        s(log_size_prev, bs = "cr") +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_1ha,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

```{r}
summary(s_post_1ha)
```

## Covariate plots

Plot smooth for size

```{r}
s_1ha_eval1 <-
  smooth_estimates(s_post_1ha, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~plogis(.x + coef(s_post_1ha)[1])))

ggplot(s_1ha_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  geom_rug(data = model.frame(s_post_1ha)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(survival)", title = "1-ha fragments")
ggsave(here("analysis", "figures", "surv_1ha_size.png"))
```

```{r}
s_cf_eval1 <-
  smooth_estimates(s_post_cf, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~plogis(.x + coef(s_post_cf)[1])))

ggplot(s_cf_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  geom_rug(data = model.frame(s_post_cf)) + 
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(survival)", title = "Continuous forest")
ggsave(here("analysis", "figures", "surv_cf_size.png"))
```

## Crossbasis plot

`dist` isn't working yet in `smooth_estimates`, but that's ok because I don't need CI for these plots (yet).

```{r}
s_1ha_eval <-
  evaluate_smooth(s_post_1ha, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = plogis(est + coef(s_post_1ha)[1]))
s_cf_eval <-
  evaluate_smooth(s_post_cf, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = plogis(est + coef(s_post_cf)[1]))

surv_lims <- c(min(s_1ha_eval$est, s_cf_eval$est, na.rm = TRUE),
                  max(s_1ha_eval$est, s_cf_eval$est, na.rm = TRUE))
```

TODO: It would be *very cool* if the colors could be the same, but the limits on the scale bar could be different.

```{r}
ggplot(s_1ha_eval, aes(x = spei_history, y = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.002) +
  scale_fill_viridis_c("P(survival)", option = "magma", limits = surv_lims) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  labs(title = "1ha fragments") +
  theme_bw()
ggsave(here("analysis", "figures", "surv_1ha_spei.png"))
```
```{r}
ggplot(s_cf_eval, aes(x = spei_history, y = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.002) +
  scale_fill_viridis_c("P(survival)", option = "magma", limits = surv_lims) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  labs(title = "Continuous forest") +
  theme_bw()
ggsave(here("analysis", "figures", "surv_cf_spei.png"))
```


# Growth
For mature plants that are alive...

```{r}
demog2_post_cf <- demog_post_cf %>% filter(surv == 1, !is.na(log_size))
demog2_post_1ha <- demog_post_1ha %>% filter(surv == 1, !is.na(log_size))
```


## Fit GAMs

Fit the GAM with crossbasis smooth for lagged drought.
Using a scaled-t family distribution because residuals were leptokurtic with a gaussian.
Preliminary modeling showed that if year is included as random effect it is concurve with SPEI history (which would mean biased p-values and coefficients).

The transformed response and identity link is actually better than a log-link, according to Ellner, Childs and Rees.

```{r}
g_post_cf <-
  bam(log_size ~ 
        s(log_size_prev, bs = "cr") + 
        # s(year_fac, bs = "re") + 
        s(plot, bs = "re") + #random effect of plot
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #unimodal-ish response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      # family = gaussian(link = "identity"),
      family = scat(link = "identity"), #like leptokurtic gaussian.
      data = demog2_post_cf,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

Inspect the GAM

```{r}
AIC(g_post_cf)
appraise(g_post_cf)
```

AIC for... 
Gaussian: ~40909.27. looks leptokurtic
scaled t: ~37284.47.  Waaay better

```{r}
summary(g_post_cf)
```

Remember, R-sq is probably so high because size this year is a very good predictor of size next year.


```{r}
g_post_1ha <-
  bam(log_size ~ 
        s(log_size_prev, bs = "cr") +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #unimodal response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      family = scat(link = "identity"), #like leptokurtic gaussian.
      data = demog2_post_1ha,
      select = TRUE,
      method = "REML",
      cluster = cl)
```

```{r}
appraise(g_post_1ha)
```

```{r}
summary(g_post_1ha)
```

## Covariate plots


```{r}
g_1ha_eval1 <-
  smooth_estimates(g_post_1ha, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~.x + coef(s_post_1ha)[1]))

ggplot(g_1ha_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  # geom_abline(slope = 1, linetype = 2, color = "red") +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  geom_rug(data = model.frame(g_post_1ha)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = TeX("$log(size_{t+1})"), title = "1-ha fragments")
ggsave(here("analysis", "figures", "growth_1ha_size.png"))
```
```{r}
g_cf_eval1 <-
  smooth_estimates(g_post_cf, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~.x + coef(s_post_cf)[1]))

ggplot(g_cf_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  # geom_abline(slope = 1, linetype = 2, color = "red") +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  geom_rug(data = model.frame(g_post_cf)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = TeX("$log(size_{t+1})"), title = "Continuous forest")
ggsave(here("analysis", "figures", "growth_cf_size.png"))
```

## Crossbasis plot
`dist` isn't working yet in `smooth_estimates`, but that's ok because I don't need CI for these plots (yet).

```{r}
g_1ha_eval <-
  evaluate_smooth(g_post_1ha, smooth = "spei_history", dist = 0.1) #%>% 
  # mutate(est = est + coef(g_post_1ha)[1])
g_cf_eval <-
  evaluate_smooth(g_post_cf, smooth = "spei_history", dist = 0.1) # %>% 
  # mutate(est = est + coef(g_post_cf)[1])

grow_lims <- c(min(g_1ha_eval$est, g_cf_eval$est, na.rm = TRUE),
               max(g_1ha_eval$est, g_cf_eval$est, na.rm = TRUE))
```


```{r}
ggplot(g_1ha_eval, aes(x = spei_history, y = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.1) +
  scale_fill_viridis_c("∆Size (?)", option = "magma", limits = grow_lims) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  labs(title = "1ha fragments") +
  theme_bw()
ggsave(here("analysis", "figures", "growth_1ha_spei.png"))
```
```{r}
ggplot(g_cf_eval, aes(x = spei_history, y = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.1) +
  scale_fill_viridis_c("∆Size (?)", option = "magma", limits = grow_lims) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  labs(title = "Continuous forest") +
  theme_bw()
ggsave(here("analysis", "figures", "growth_cf_spei.png"))
```

# Flowering Probability

## Fit GAMs

```{r}
x <- demog_post$flwr
sum(x, na.rm = TRUE) / length(x)
```

Around 5 percent of plants flowered.

```{r}
f_post_cf <-
  bam(flwr ~ 
        s(log_size_prev, bs = "cr") +
        # s(year_fac, bs = "re") + 
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog2_post_cf,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

Doesn't converge with random effect of year

```{r}
appraise(f_post_cf)
# concurvity(f_post_cf, full = FALSE)
```

these residuals are troubling

```{r}
summary(f_post_cf)
```

This model changes **drastically** depending on whether year is included as a random effect.  Does that mean ther random effect is important? Or is it because it is collinear / concurve with SPEI history?

```{r}
f_post_1ha <-
  bam(flwr ~ 
        s(log_size_prev, bs = "cr") +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog2_post_1ha,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

```{r}
appraise(f_post_1ha)
```

```{r}
summary(f_post_1ha)
```


## Covariate plots

Plot smooth for size

```{r}
f_1ha_eval1 <-
  smooth_estimates(f_post_1ha, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~plogis(.x + coef(f_post_1ha)[1])))

ggplot(f_1ha_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  # stat_summary_bin(geom = "point", fun = mean, aes(y = flwr), data = model.frame(f_post_1ha)) +
  geom_rug(data = model.frame(f_post_1ha)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(flowering)", title = "1-ha fragments")
ggsave(here("analysis", "figures", "flwr_1ha_size.png"))
```

```{r}
f_cf_eval1 <-
  smooth_estimates(f_post_cf, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~plogis(.x + coef(f_post_cf)[1])))

ggplot(f_cf_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  # stat_summary_bin(geom = "point", fun = mean, aes(y = flwr), data = model.frame(f_post_cf)) +
  geom_rug(data = model.frame(f_post_cf)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(flowering)", title = "Continuous forest")
ggsave(here("analysis", "figures", "flwr_cf_size.png"))
```


## Crossbasis plot

`dist` isn't working yet in `smooth_estimates`, but that's ok because I don't need CI for these plots (yet).

```{r}
f_1ha_eval <-
  evaluate_smooth(f_post_1ha, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = plogis(est + coef(f_post_1ha)[1]))
f_cf_eval <-
  evaluate_smooth(f_post_cf, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = plogis(est + coef(f_post_cf)[1]))

flwr_lims <- c(min(f_1ha_eval$est, f_cf_eval$est, na.rm = TRUE),
               max(f_1ha_eval$est, f_cf_eval$est, na.rm = TRUE))
```


```{r}
ggplot(f_1ha_eval, aes(x = spei_history, y = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.001) +
  scale_fill_viridis_c("P(flowering)", option = "magma", limits = flwr_lims) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  labs(title = "1ha fragments") +
  theme_bw()
ggsave(here("analysis", "figures", "flwr_1ha_spei.png"))
```
```{r}
ggplot(f_cf_eval, aes(x = spei_history, y = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.001) +
  scale_fill_viridis_c("P(flowering)", option = "magma", limits = flwr_lims) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  labs(title = "Continuous forest") +
  theme_bw()
ggsave(here("analysis", "figures", "flwr_cf_spei.png"))
```

# Plots
## Growth

### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r eval=FALSE}
pred_g_post_cf  <- cb_margeff(g_post_cf, Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
pred_g_post_1ha <- cb_margeff(g_post_1ha, Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
```

Calculate growth as change from year t to year t+1

```{r eval=FALSE}
mean_size # size in year t for fitted values

pred_g_post_cf <- 
  pred_g_post_cf %>% 
  mutate(e_fitted = exp(fitted),
         d_fitted = e_fitted - mean_size)

pred_g_post_1ha <-
  pred_g_post_1ha %>% 
  mutate(e_fitted = exp(fitted),
         d_fitted = e_fitted - mean_size)
```

Shared color bar limits so scales can be combined.

```{r eval=FALSE}
shoot_lim <- c(min(pred_g_post_1ha$d_fitted, pred_g_post_cf$d_fitted),
               max(pred_g_post_1ha$d_fitted, pred_g_post_cf$d_fitted))
```

### Plots

```{r eval=FALSE}
p_growth_cf <-
  pred_g_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = d_fitted, fill = d_fitted)) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c(TeX("$\\Delta$ size"), option = "A", limits = shoot_lim) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_growth_cf
ggsave(here("analysis", "figures", "growth_cf_spei.png"), p_growth_cf)
```

```{r eval=FALSE}
p_growth_1ha <-
  pred_g_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = d_fitted, fill = d_fitted)) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c(TeX("$\\Delta$ size"), option = "A", limits = shoot_lim) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_growth_1ha
ggsave(here("analysis", "figures", "growth_1ha_spei.png"), p_growth_1ha)
```



## Survival



### Get plot data

```{r eval=FALSE}
# use mean size plant across both habitats so plots are comparable
ref_data <-
  demog_post %>%
  dplyr::summarize(log_size_prev = log(mean(size_prev, na.rm = TRUE)),  #log of mean size, not mean of log_size
                   year_fac = "newyear",
                   plot = "newlevel")

mean_size <- exp(ref_data$log_size_prev)
```

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r eval=FALSE}
pred_s_post_cf  <- cb_margeff(s_post_cf,  Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
pred_s_post_1ha <- cb_margeff(s_post_1ha, Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
```

Shared color bar limits so scales can be combined.

```{r eval=FALSE}
surv_lim <- c(min(pred_s_post_1ha$fitted, pred_s_post_cf$fitted),
              max(pred_s_post_1ha$fitted, pred_s_post_cf$fitted))
# plogis(surv_lim)
```

### Plots


```{r eval=FALSE}
p_surv_cf <-
  pred_s_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_surv_cf
ggsave(here("analysis", "figures", "surv_cf_spei.png"), p_surv_cf)
```

```{r eval=FALSE}
p_surv_1ha <-
  pred_s_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_surv_1ha
ggsave(here("analysis", "figures", "surv_1ha_spei.png"), p_surv_1ha)
```


## Flowering
### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r eval=FALSE}
pred_f_post_cf  <- cb_margeff(f_post_cf,  Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
pred_f_post_1ha <- cb_margeff(f_post_1ha, Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
```

Shared color bar limits so scales can be combined.

```{r eval=FALSE}
flowered_lim <- c(min(pred_f_post_1ha$fitted, pred_f_post_cf$fitted),
                  max(pred_f_post_1ha$fitted, pred_f_post_cf$fitted))
plogis(flowered_lim)
```

### Plots

```{r eval=FALSE}
p_flowered_cf <-
  pred_f_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_flowered_cf
ggsave(here("analysis", "figures", "flwr_cf_spei.png"), p_flowered_cf)
```



```{r eval=FALSE}
p_flowered_1ha <-
  pred_f_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_flowered_1ha
ggsave(here("analysis", "figures", "flwr_1ha_spei.png"), p_flowered_1ha)
```
very similar to growth



