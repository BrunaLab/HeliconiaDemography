---
title: "FLM for growth as function of SPEI"
author: "Eric R. Scott"
date: "Date Initiated"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
library(tidyverse)
library(here)
library(mgcv)
library(dlnm)
library(bbmle)
library(lubridate)
library(glue)
library(patchwork)
# library(sf)
library(tsibble)
library(broom)
library(gratia)
library(latex2exp)

library(conflicted)
conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("slice", "dplyr")

library(HeliconiaDemography) #load functions in this compendium
# devtools::load_all()
```


*Last compiled: `r Sys.Date()`*

# TODO:

- ~~Switch measure of plant size to shoots * height~~
- ~~Change lag to 36 months (3 years)~~
- Produce ridge plot
- Heatmap for growth should be ∆size
- try select = TRUE (after you understand it better? blog about it first)

# Purpose

Take a crack at modeling vital rates as a function of previous height and lagged, non-linear, SPEI.

# Load Data


```{r}
demog_full <- read_rds(here("analysis", "data", "derived_data", "ha_spei_combined.rds"))
```

## Tidy

There are plants with 0 shoots and 0 ht.  I will remove those, as having no above ground biomass is really not a size, but a different category.
There's also a couple of plants that are probably data entry errors in height.

```{r}
demog_full <-
  demog_full %>% 
  filter(ht < 200 | is.na(ht), ht_prev < 200 | is.na(ht_prev)) %>%
  filter(
    # having no aboveground biomass is possible, but categorically different than just being small. Exclude plants with 0 shoots or 0 height
    shts_prev > 0,
    ht_prev > 0,
    #for survival data, must include plants with NA for shts and height (i.e. dead plants)
    shts > 0 | is.na(shts), 
    ht > 0 | is.na(ht)
  ) %>%
  mutate(size = shts*ht, size_prev = shts_prev * ht_prev, log_size = log(size), log_size_prev = log(size_prev))
```


`gam` wants factors!

```{r}
demog_full <-
  demog_full %>% 
  mutate(across(c(ranch, bdffp_reserve_no, plot, habitat, ha_id_number), as.factor)) %>% 
  mutate(year_fac = as.factor(year))
# View(demog_full)
```


# Splitting up data

Because I can't model interactions with DLNMs, I can either include factors like habitat as predictors (different intercepts, same functional form, same data) or fit separate models (potentially different functional forms, but not using all the data).

```{r}
demog_post <- 
  demog_full %>% 
  filter(code_notes != "sdlg (1)" | is.na(code_notes))

demog_post_cf <-
  demog_post %>% 
  filter(habitat == "CF")

demog_post_1ha <-
  demog_post %>% 
  filter(habitat == "1-ha")

demog_sdlg <- 
  demog_full %>% 
  filter(code_notes == "sdlg (1)")

demog_sdlg_cf <- 
  demog_sdlg %>% 
  filter(habitat == "CF")

demog_sdlg_1ha <- 
  demog_sdlg %>% 
  filter(habitat == "1-ha")
```


# Speed up models with bam()

I'm going to start fitting these with `bam()` to speed things up.  This sets up the paralellization.  CAUTION: you may need to change these settings for your machine.

```{r}
library(parallel)
ncores <- detectCores()
cl <- makeForkCluster(ncores - 2)
```

# Survival
`surv` is 1 in `year`s when a plant is alive and 0 in the first `year` when the plant is dead.  These GAMs model the survival of a plant (over the past year) as a function of size in the previous census and SPEI values starting at february of the current year going back 36 months.
## Fit GAMs

```{r}
s_post_cf <-
  bam(surv ~ 
        s(log_size_prev, bs = "cr") +
        # s(year) +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_cf,
      method = "REML",
      select = TRUE,
      cluster = cl)
```


```{r}
# gam.check(s_post_cf) #not sure what to expect from any of these plots
appraise(s_post_cf)
# concurvity(s_post_cf, full = FALSE)
```

```{r}
summary(s_post_cf)
```

```{r}
s_post_1ha <-
  bam(surv ~ 
        s(log_size_prev, bs = "cr") +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_1ha,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

```{r}
summary(s_post_1ha)
```

## Covariate plots

Plot smooth for size

```{r}
s_1ha_eval1 <-
  smooth_estimates(s_post_1ha, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~plogis(.x + coef(s_post_1ha)[1])))

ggplot(s_1ha_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  geom_rug(data = model.frame(s_post_1ha)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(survival)", title = "1-ha fragments")
ggsave(here("analysis", "figures", "surv_1ha_size.png"))
```

```{r}
s_cf_eval1 <-
  smooth_estimates(s_post_cf, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~plogis(.x + coef(s_post_cf)[1])))

ggplot(s_cf_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  geom_rug(data = model.frame(s_post_cf)) + 
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(survival)", title = "Continuous forest")
ggsave(here("analysis", "figures", "surv_cf_size.png"))
```

Combine and plot together

```{r}
bind_rows("1-ha" = s_1ha_eval1, "CF" = s_cf_eval1, .id = "habitat") %>% 
  ggplot(aes(x = log_size_prev, color = habitat)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, color = NULL, fill = habitat), alpha = 0.25) +
  geom_rug(data = bind_rows(
    "1-ha" = model.frame(s_post_1ha),
    "CF" = model.frame(s_post_cf), 
    .id = "habitat"),
    color = "black") +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(survival)")
ggsave(here("analysis", "figures", "surv_both_size.png"))
```



## Crossbasis plot

`dist` isn't working yet in `smooth_estimates`, but that's ok because I don't need CI for these plots (yet).

```{r}
s_1ha_eval <-
  evaluate_smooth(s_post_1ha, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = plogis(est + coef(s_post_1ha)[1]))
s_cf_eval <-
  evaluate_smooth(s_post_cf, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = plogis(est + coef(s_post_cf)[1]))

surv_lims <- c(min(s_1ha_eval$est, s_cf_eval$est, na.rm = TRUE),
                  max(s_1ha_eval$est, s_cf_eval$est, na.rm = TRUE))
```

TODO: It would be *very cool* if the colors could be the same, but the limits on the scale bar could be different.

```{r}
s_1ha_cbplot <-
  ggplot(s_1ha_eval, aes(x = spei_history, y = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.002) +
  scale_fill_viridis_c("P(survival)", option = "magma", limits = surv_lims) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  labs(title = "1ha fragments") +
  theme_bw()
ggsave(here("analysis", "figures", "surv_1ha_spei.png"), s_1ha_cbplot)
```
```{r}
s_cf_cbplot <- 
  ggplot(s_cf_eval, aes(x = spei_history, y = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.002) +
  scale_fill_viridis_c("P(survival)", option = "magma", limits = surv_lims) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  labs(title = "Continuous forest") +
  theme_bw()
ggsave(here("analysis", "figures", "surv_cf_spei.png"), s_cf_cbplot)
```

combine
```{r}
s_1ha_cbplot + s_cf_cbplot + plot_layout(guides = "collect") + plot_annotation(tag_levels = "a", tag_suffix = ")")
ggsave(here("analysis", "figures", "surv_both_spei.png"), width = 10, height = 5)
```


# Growth
For mature plants that are alive...

```{r}
demog2_post_cf <- demog_post_cf %>% filter(surv == 1, !is.na(log_size))
demog2_post_1ha <- demog_post_1ha %>% filter(surv == 1, !is.na(log_size))
```


## Fit GAMs

Fit the GAM with crossbasis smooth for lagged drought.
Using a scaled-t family distribution because residuals were leptokurtic with a gaussian.
Preliminary modeling showed that if year is included as random effect it is concurve with SPEI history (which would mean biased p-values and coefficients).

The transformed response and identity link is actually better than a log-link, according to Ellner, Childs and Rees.

```{r}
g_post_cf <-
  bam(log_size ~ 
        s(log_size_prev, bs = "cr") + 
        # s(year_fac, bs = "re") + 
        s(plot, bs = "re") + #random effect of plot
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #unimodal-ish response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      # family = gaussian(link = "identity"),
      family = scat(link = "identity"), #like leptokurtic gaussian.
      data = demog2_post_cf,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

Inspect the GAM

```{r}
AIC(g_post_cf)
appraise(g_post_cf)
```

AIC for... 
Gaussian: ~40909.27. looks leptokurtic
scaled t: ~37284.47.  Waaay better

```{r}
summary(g_post_cf)
```

Remember, R-sq is probably so high because size this year is a very good predictor of size next year.


```{r}
g_post_1ha <-
  bam(log_size ~ 
        s(log_size_prev, bs = "cr") +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #unimodal response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      family = scat(link = "identity"), #like leptokurtic gaussian.
      data = demog2_post_1ha,
      select = TRUE,
      method = "REML",
      cluster = cl)
```

```{r}
appraise(g_post_1ha)
```

```{r}
summary(g_post_1ha)
```

## Covariate plots


```{r}
g_1ha_eval1 <-
  smooth_estimates(g_post_1ha, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~.x + coef(s_post_1ha)[1]))

ggplot(g_1ha_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  # geom_abline(slope = 1, linetype = 2, color = "red") +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  geom_rug(data = model.frame(g_post_1ha)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = TeX("$log(size_{t+1})"), title = "1-ha fragments")
ggsave(here("analysis", "figures", "growth_1ha_size.png"))
```
```{r}
g_cf_eval1 <-
  smooth_estimates(g_post_cf, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~.x + coef(s_post_cf)[1]))

ggplot(g_cf_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  # geom_abline(slope = 1, linetype = 2, color = "red") +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  geom_rug(data = model.frame(g_post_cf)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = TeX("$log(size_{t+1})"), title = "Continuous forest")
ggsave(here("analysis", "figures", "growth_cf_size.png"))
```

Both together

```{r}
bind_rows("1-ha" = g_1ha_eval1, "CF" = g_cf_eval1, .id = "habitat") %>% 
  ggplot(aes(x = log_size_prev)) +
  geom_line(aes(y = est, color = habitat)) +
  geom_abline(slope = 1, linetype = 2, color = "red") +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = habitat), alpha = 0.25) +
  geom_rug(data = bind_rows(
    "1-ha" = model.frame(g_post_1ha),
    "CF" = model.frame(g_post_cf),
    .id = "habitat")) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = TeX("$log(size_{t+1})"))
ggsave(here("analysis", "figures", "growth_both_size.png"))
```



## Crossbasis plot
`dist` isn't working yet in `smooth_estimates`, but that's ok because I don't need CI for these plots (yet).

```{r}
g_1ha_eval <-
  evaluate_smooth(g_post_1ha, smooth = "spei_history", dist = 0.1) #%>% 
  # mutate(est = est + coef(g_post_1ha)[1])
g_cf_eval <-
  evaluate_smooth(g_post_cf, smooth = "spei_history", dist = 0.1) # %>% 
  # mutate(est = est + coef(g_post_cf)[1])

grow_lims <- c(min(g_1ha_eval$est, g_cf_eval$est, na.rm = TRUE),
               max(g_1ha_eval$est, g_cf_eval$est, na.rm = TRUE))
```


```{r}
g_1ha_cbplot <- 
  ggplot(g_1ha_eval, aes(x = spei_history, y = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.1) +
  scale_fill_viridis_c("∆log(size) (?)", option = "magma", limits = grow_lims) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  labs(title = "1ha fragments") +
  theme_bw()
ggsave(here("analysis", "figures", "growth_1ha_spei.png"), g_1ha_cbplot)
```

```{r}
g_cf_cbplot <-
  ggplot(g_cf_eval, aes(x = spei_history, y = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.1) +
  scale_fill_viridis_c("∆log(size) (?)", option = "magma", limits = grow_lims) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  labs(title = "Continuous forest") +
  theme_bw()
ggsave(here("analysis", "figures", "growth_cf_spei.png"), g_cf_cbplot)
```

combine

```{r}
g_1ha_cbplot + g_cf_cbplot + plot_layout(guides = "collect") + plot_annotation(tag_levels = "a", tag_suffix = ")")
ggsave(here("analysis", "figures", "growth_both_spei.png"), width = 10, height = 5)
```


# Flowering Probability

## Fit GAMs

```{r}
x <- demog_post$flwr
sum(x, na.rm = TRUE) / length(x)
```

Around 5 percent of plants flowered.

```{r}
f_post_cf <-
  bam(flwr ~ 
        s(log_size_prev, bs = "cr") +
        # s(year_fac, bs = "re") + 
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog2_post_cf,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

Doesn't converge with random effect of year

```{r}
appraise(f_post_cf)
# concurvity(f_post_cf, full = FALSE)
```

these residuals are troubling

```{r}
summary(f_post_cf)
```

This model changes **drastically** depending on whether year is included as a random effect.  Does that mean ther random effect is important? Or is it because it is collinear / concurve with SPEI history?

```{r}
f_post_1ha <-
  bam(flwr ~ 
        s(log_size_prev, bs = "cr") +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog2_post_1ha,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

```{r}
appraise(f_post_1ha)
```

```{r}
summary(f_post_1ha)
```


## Covariate plots

Plot smooth for size

```{r}
f_1ha_eval1 <-
  smooth_estimates(f_post_1ha, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~plogis(.x + coef(f_post_1ha)[1])))

ggplot(f_1ha_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  # stat_summary_bin(geom = "point", fun = mean, aes(y = flwr), data = model.frame(f_post_1ha)) +
  geom_rug(data = model.frame(f_post_1ha)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(flowering)", title = "1-ha fragments")
ggsave(here("analysis", "figures", "flwr_1ha_size.png"))
```

```{r}
f_cf_eval1 <-
  smooth_estimates(f_post_cf, smooth = "log_size_prev", unconditional = TRUE) %>% 
  add_confint() %>% 
  mutate(across(c(est, lower_ci, upper_ci), ~plogis(.x + coef(f_post_cf)[1])))

ggplot(f_cf_eval1, aes(x = log_size_prev)) +
  geom_line(aes(y = est)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.25) +
  # stat_summary_bin(geom = "point", fun = mean, aes(y = flwr), data = model.frame(f_post_cf)) +
  geom_rug(data = model.frame(f_post_cf)) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(flowering)", title = "Continuous forest")
ggsave(here("analysis", "figures", "flwr_cf_size.png"))
```

combine and plot

```{r}
bind_rows("1-ha" = f_1ha_eval1, "CF" = f_cf_eval1, .id = "habitat") %>% 
  ggplot(aes(x = log_size_prev)) +
  geom_line(aes(y = est, color = habitat)) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci, fill = habitat), alpha = 0.25) +
  # stat_summary_bin(geom = "point", fun = mean, aes(y = flwr), data = model.frame(f_post_cf)) +
  geom_rug(data = bind_rows(
    "1-ha" = model.frame(f_post_1ha),
    "CF" = model.frame(f_post_cf),
    .id = "habitat")) +
  theme_bw() +
  labs(x = TeX("$log(size_t)$"), y = "P(flowering)")
ggsave(here("analysis", "figures", "flwr_both_size.png"))
```

## Crossbasis plot

`dist` isn't working yet in `smooth_estimates`, but that's ok because I don't need CI for these plots (yet).

```{r}
f_1ha_eval <-
  evaluate_smooth(f_post_1ha, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = plogis(est + coef(f_post_1ha)[1]))
f_cf_eval <-
  evaluate_smooth(f_post_cf, smooth = "spei_history", dist = 0.1) %>% 
  mutate(est = plogis(est + coef(f_post_cf)[1]))

flwr_lims <- c(min(f_1ha_eval$est, f_cf_eval$est, na.rm = TRUE),
               max(f_1ha_eval$est, f_cf_eval$est, na.rm = TRUE))
```


```{r}
f_1ha_cbplot <- 
  ggplot(f_1ha_eval, aes(x = spei_history, y = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.001) +
  scale_fill_viridis_c("P(flowering)", option = "magma", limits = flwr_lims) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  labs(title = "1-ha fragments") +
  theme_bw()
ggsave(here("analysis", "figures", "flwr_1ha_spei.png"), f_1ha_cbplot)
```
```{r}
f_cf_cbplot <- 
  ggplot(f_cf_eval, aes(x = spei_history, y = L, fill = est, z = est)) +
  geom_raster() +
  geom_contour(color = "black", binwidth = 0.001) +
  scale_fill_viridis_c("P(flowering)", option = "magma", limits = flwr_lims) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  labs(title = "Continuous forest") +
  theme_bw()
ggsave(here("analysis", "figures", "flwr_cf_spei.png"), f_cf_cbplot)
```

combine
```{r}
f_1ha_cbplot + f_cf_cbplot + plot_layout(guides = "collect") + plot_annotation(tag_levels = "a", tag_suffix = ")")
ggsave(here("analysis", "figures", "flwr_both_spei.png"), width = 10, height = 5)
```


# Predict Plots
## Growth

### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r eval=FALSE}
pred_g_post_cf  <- cb_margeff(g_post_cf, Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
pred_g_post_1ha <- cb_margeff(g_post_1ha, Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
```

Calculate growth as change from year t to year t+1

```{r eval=FALSE}
mean_size # size in year t for fitted values

pred_g_post_cf <- 
  pred_g_post_cf %>% 
  mutate(e_fitted = exp(fitted),
         d_fitted = e_fitted - mean_size)

pred_g_post_1ha <-
  pred_g_post_1ha %>% 
  mutate(e_fitted = exp(fitted),
         d_fitted = e_fitted - mean_size)
```

Shared color bar limits so scales can be combined.

```{r eval=FALSE}
shoot_lim <- c(min(pred_g_post_1ha$d_fitted, pred_g_post_cf$d_fitted),
               max(pred_g_post_1ha$d_fitted, pred_g_post_cf$d_fitted))
```

### Plots

```{r eval=FALSE}
p_growth_cf <-
  pred_g_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = d_fitted, fill = d_fitted)) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c(TeX("$\\Delta$ size"), option = "A", limits = shoot_lim) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_growth_cf
ggsave(here("analysis", "figures", "growth_cf_spei.png"), p_growth_cf)
```

```{r eval=FALSE}
p_growth_1ha <-
  pred_g_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = d_fitted, fill = d_fitted)) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c(TeX("$\\Delta$ size"), option = "A", limits = shoot_lim) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_growth_1ha
ggsave(here("analysis", "figures", "growth_1ha_spei.png"), p_growth_1ha)
```



## Survival



### Get plot data

```{r eval=FALSE}
# use mean size plant across both habitats so plots are comparable
ref_data <-
  demog_post %>%
  dplyr::summarize(log_size_prev = log(mean(size_prev, na.rm = TRUE)),  #log of mean size, not mean of log_size
                   year_fac = "newyear",
                   plot = "newlevel")

mean_size <- exp(ref_data$log_size_prev)
```

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r eval=FALSE}
pred_s_post_cf  <- cb_margeff(s_post_cf,  Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
pred_s_post_1ha <- cb_margeff(s_post_1ha, Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
```

Shared color bar limits so scales can be combined.

```{r eval=FALSE}
surv_lim <- c(min(pred_s_post_1ha$fitted, pred_s_post_cf$fitted),
              max(pred_s_post_1ha$fitted, pred_s_post_cf$fitted))
# plogis(surv_lim)
```

### Plots


```{r eval=FALSE}
p_surv_cf <-
  pred_s_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_surv_cf
ggsave(here("analysis", "figures", "surv_cf_spei.png"), p_surv_cf)
```

```{r eval=FALSE}
p_surv_1ha <-
  pred_s_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_surv_1ha
ggsave(here("analysis", "figures", "surv_1ha_spei.png"), p_surv_1ha)
```


## Flowering
### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r eval=FALSE}
pred_f_post_cf  <- cb_margeff(f_post_cf,  Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
pred_f_post_1ha <- cb_margeff(f_post_1ha, Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
```

Shared color bar limits so scales can be combined.

```{r eval=FALSE}
flowered_lim <- c(min(pred_f_post_1ha$fitted, pred_f_post_cf$fitted),
                  max(pred_f_post_1ha$fitted, pred_f_post_cf$fitted))
plogis(flowered_lim)
```

### Plots

```{r eval=FALSE}
p_flowered_cf <-
  pred_f_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_flowered_cf
ggsave(here("analysis", "figures", "flwr_cf_spei.png"), p_flowered_cf)
```



```{r eval=FALSE}
p_flowered_1ha <-
  pred_f_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_flowered_1ha
ggsave(here("analysis", "figures", "flwr_1ha_spei.png"), p_flowered_1ha)
```
very similar to growth



