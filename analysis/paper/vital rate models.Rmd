---
title: "FLM for growth as function of SPEI"
author: "Eric R. Scott"
date: "Date Initiated"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
library(tidyverse)
library(here)
library(mgcv)
library(dlnm)
library(bbmle)
library(lubridate)
library(glue)
library(patchwork)
library(sf)
library(tsibble)
library(broom)

library(conflicted)
conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("slice", "dplyr")

# library(HeliconiaDemography) #load functions in this compendium
# devtools::load_all()
```

```{r}
#define plotting themes

theme_talk <- theme_bw() + theme(text = element_text(size = 18))
```


*Last compiled: `r Sys.Date()`*

# TODO:

- 
- ~~Remove seedlings from dataset, for now~~
- ~~Separate models for CF and fragment, for now~~
- Add model for probability of reproduction and other vital rates
- Model seedlings separately?
- Add random effects, interactions, other complexities
- Match SPEI data to demographic plots programtically by lat lon data


# Purpose

Take a crack at modeling vital rates as a function of previous height and lagged, non-linear, SPEI.

# Load Data

```{r data, echo=TRUE}
spei <- read_rds(here("analysis", "data", "derived_data", "spei_lags.rds"))
xa <- read_rds(here("analysis", "data", "derived_data", "xa_spei_lags.rds"))
demog <- read_rds(here("analysis", "data", "derived_data", "ha_survey.rds"))
plot_coords <- read_csv(here("analysis", "data", "raw_data", "plot_coords.csv"))
```

```{r}
length(unique(demog$ha_id_number))
range(demog$year)
2009-1998
```


# Join data sets

## Gridded data
Get only rows for february (the month of the census), and year for joining

```{r}
xa2 <- 
  xa %>%
  filter(month(yearmonth) == 2) %>% 
  mutate(year = year(yearmonth), .after =yearmonth) %>% 
  separate(latlon, into = c("lat", "lon"), sep = "_")
xa2
```

Now, for the demography data, get year and plot coords

```{r}
# demog$plot %>% unique() %>% sort()
# plot_coords$plot %>% unique() %>% sort()
demog <-
  right_join(plot_coords %>% select(plot, lon, lat),
             demog,
             by = "plot") %>% 
  select(-x_09, -y_09) #remove to avoid confusion since i'm not using here.
```

**TODO:**
Now join by year and whether plot is in grid cell or not.  Probably need to construct `sf` object for grid cells (knowing that the lat lon are the centers and the resolution is 0.25ยบ) and then use some `sf_` function to check if a point is inside of a grid cell.  See: https://stackoverflow.com/questions/59766153/left-join-based-on-closest-lat-lon-in-r



## Imputed data:

`demog$year` = `spei$census_year`

Getting site to match up will take more work.

```{r}
unique(demog$plot)
unique(demog$bdffp_reserve_no)
unique(spei$site)
```

km41 = 1501
km37 = ??
florestal = 1301, Florestal-CF
cabo frio = 3402, CaboFrio-CF
Porto Alegre = 3114, PortoAlegre-CF
Colosso = 1104, 1202
Dimona = 2206, 2108, 2107, Dimona-CF

colosso_clust = 1301, 3402, 1104, 1202, CaboFrio-CF, Florestal-CF


```{r}
demog <- 
  demog %>% 
  mutate(rain_site = case_when(
    bdffp_reserve_no %in% c("1301", "3402", "1104", "1202")      ~ "colosso_clust",
    plot %in% c("CaboFrio-CF", "Florestal-CF")                   ~ "colosso_clust",
    bdffp_reserve_no %in% c("2206", "2108", "2107")              ~ "dimona",
    plot == "Dimona-CF"                                          ~ "dimona",
    bdffp_reserve_no == "3114"                                   ~ "porto_alegre",
    plot == "PortoAlegre-CF"                                     ~ "porto_alegre",
    bdffp_reserve_no == "1501"                                   ~ "km_clust",
    TRUE ~ NA_character_
  ))
```

Get SPEI history only for census months (assuming all censuses done in February)

```{r}
spei_census <- 
  spei %>% 
  filter(month(yearmonth) == 2) %>% 
  mutate(year = year(yearmonth), .before = site) %>% 
  select(-yearmonth)
```

Join

```{r}
demog_full <-
  left_join(demog, spei_census, by = c("rain_site" = "site", "year")) %>% 
  mutate(log_shts = log(shts), .after = shts)

# demog_full %>% select(spei, spei_history)
```

`gam` wants factors!

```{r}
demog_full <-
  demog_full %>% 
  mutate(across(c(ranch, bdffp_reserve_no, plot, habitat, ha_id_number), as.factor)) %>% 
  mutate(flowered = as.numeric(infl > 0))
```

# Splitting up data

To simplify initial modeling attempts, I'll split the data into seedlings vs. post-seedlings and by habitat.  I'll build the Q and L matrixes describing exposure and lag for each subset.

```{r}
demog_post <- 
  demog_full %>% 
  filter(code_notes != "sdlg (1)" | is.na(code_notes))

demog_post_cf <-
  demog_post %>% 
  filter(habitat == "CF")

demog_post_1ha <-
  demog_post %>% 
  filter(habitat == "1-ha")

demog_sdlg <- 
  demog_full %>% 
  filter(code_notes == "sdlg (1)")

demog_sdlg_cf <- 
  demog_sdlg %>% 
  filter(habitat == "CF")

demog_sdlg_1ha <- 
  demog_sdlg %>% 
  filter(habitat == "1-ha")
```


## Growth

Start with no random effects

Using a scaled-t family distribution because residuals were leptokurtic with a gaussian.

### Fit GAMs

Fit the GAM with crossbasis smooth for lagged drought

```{r}
g_post_cf <-
  gam(shts_next ~ 
        s(log_shts) + #does this *need* to be log # shoots?
        # s(shts) +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = scat(link = "log"),
      data = demog_post_cf,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```


```{r}
gam.check(g_post_cf) #looks good
# summary(g_post_cf)
anova(g_post_cf)
```

```{r}
g_post_1ha <-
  gam(shts_next ~ 
        s(log_shts) +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = scat(link = "log"),
      data = demog_post_1ha,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```

```{r}
gam.check(g_post_1ha)
anova(g_post_1ha)
```

### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
# use mean size plant across both habitats so plots are comparable
ref_data <-
  demog_post %>%
  dplyr::summarize(log_shts = log(mean(shts, na.rm = TRUE))) #log of mean shoots, not mean of log_shts
# exp(1.032814) # 2.8 shoots
```


```{r}
pred_g_post_cf  <- cb_margeff(g_post_cf, Q = spei_history, L = L, ref_data = ref_data)
pred_g_post_1ha <- cb_margeff(g_post_1ha, Q = spei_history, L = L, ref_data = ref_data)
```

Lag labels

```{r}
# first column is February, the month of the census
labs <- c("Feb", "Jan", paste0(month(12:1, label = TRUE), " (y-1)"), paste0(month(12:2, label = TRUE), " (y-2)"))
```

Shared color bar limits so scales can be combined.

```{r}
shoot_lim <- c(min(pred_g_post_1ha$fitted, pred_g_post_cf$fitted),
               max(pred_g_post_1ha$fitted, pred_g_post_cf$fitted))
```

### Plots

**Raster plots:**

```{r}
p_growth_cf <-
  pred_g_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = exp(fitted), fill = exp(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous("lag (months)", breaks = 0:24, labels = labs, expand = c(0,0)) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("#shoots (t+1)", option = "A", limits = exp(shoot_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_growth_cf
```

```{r}
p_growth_1ha <-
  pred_g_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = exp(fitted), fill = exp(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous("lag (months)", breaks = 0:24, labels = labs, expand = c(0,0)) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("#shoots (t+1)", option = "A", limits = exp(shoot_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_growth_1ha
```


**Slice through time at severe drought**

```{r}
p_growth_cf_slice <-
  pred_g_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = exp(fitted))) +
  geom_ribbon(aes(
    ymin = exp(fitted - se.fit * 1.96),
    ymax = exp(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "Continuous Forest", y = "shoots (t+1)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_growth_cf_slice
```


```{r}
p_growth_1ha_slice <-
  pred_g_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = exp(fitted))) +
  geom_ribbon(aes(
    ymin = exp(fitted - se.fit * 1.96),
    ymax = exp(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "1-ha Fragments", y = "shoots (t+1)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_growth_1ha_slice
```


**Slice through individual months**

I find this less useful, but just shows that relationships are slightly quadratic at most complicated.  This would be more useful if there was a way to show which lines had "slopes" significantly different from 0 (i.e. don't totally overlap a flat line).

```{r}
plotdf <-
  pred_g_post_cf %>% 
  mutate(lag = round(lag)) %>% 
  group_by(x, lag) %>% 
  summarize(across(everything(),  mean))


foo <- function(x) {
  d <- 1:25
  names(d)<-labs
  x <- as.numeric(x)
  # s <- glue("lag {x} ({names(d[x])})")
  s <- names(d[x])
  return(s)
}

p_growth_cf_months <-
  plotdf %>% 
  ggplot(aes(x = x, y = exp(fitted))) +
  geom_ribbon(aes(
    ymin = exp(fitted - se.fit * 1.96),
    ymax = exp(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("SPEI3") +
  scale_y_continuous("shoots (t+1)") +
  facet_wrap(~lag, labeller = as_labeller(foo)) +
  theme_bw()
```

## Survival

### Fit GAMs

```{r}
s_post_cf <-
  gam(surv ~ 
        s(log_shts) +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_cf,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")
anova(s_post_cf)
```


```{r}
s_post_1ha <-
  gam(surv ~ 
        s(log_shts) +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_1ha,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")
anova(s_post_1ha)
```


### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
pred_s_post_cf  <- cb_margeff(s_post_cf,  Q = spei_history, L = L, ref_data = ref_data)
pred_s_post_1ha <- cb_margeff(s_post_1ha, Q = spei_history, L = L, ref_data = ref_data)
```

Shared color bar limits so scales can be combined.

```{r}
surv_lim <- c(min(pred_s_post_1ha$fitted, pred_s_post_cf$fitted),
              max(pred_s_post_1ha$fitted, pred_s_post_cf$fitted))
# plogis(surv_lim)
```

### Plots

**Raster plots:**

```{r}
p_surv_cf <-
  pred_s_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous("lag (months)", breaks = 0:24, labels = labs, expand = c(0,0)) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_surv_cf
```

```{r}
p_surv_1ha <-
  pred_s_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous("lag (months)", breaks = 0:24, labels = labs, expand = c(0,0)) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_surv_1ha
```


**Slice through time at severe drought**

```{r}
p_surv_cf_slice <-
  pred_s_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "Continuous Forest", y = "P(survival)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# p_surv_cf_slice
```


```{r}
p_surv_1ha_slice <-
  pred_s_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "1-ha Fragments", y = "P(survival)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# p_surv_1ha_slice
```

## Flowering Probability

### Fit GAMs

```{r}
f_post_cf <-
  gam(flowered ~ 
        s(log_shts) +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_cf,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")
anova(f_post_cf)
```


```{r}
f_post_1ha <-
  gam(flowered ~ 
        s(log_shts) +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_1ha,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")
anova(f_post_1ha)
```


### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
pred_f_post_cf  <- cb_margeff(f_post_cf,  Q = spei_history, L = L, ref_data = ref_data)
pred_f_post_1ha <- cb_margeff(f_post_1ha, Q = spei_history, L = L, ref_data = ref_data)
```

Shared color bar limits so scales can be combined.

```{r}
flowered_lim <- c(min(pred_f_post_1ha$fitted, pred_f_post_cf$fitted),
                  max(pred_f_post_1ha$fitted, pred_f_post_cf$fitted))
# plogis(flowered_lim)
```

### Plots

**Raster plots:**

```{r}
p_flowered_cf <-
  pred_f_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous("lag (months)", breaks = 0:24, labels = labs, expand = c(0,0)) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_flowered_cf
```

```{r}
p_flowered_1ha <-
  pred_f_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous("lag (months)", breaks = 0:24, labels = labs, expand = c(0,0)) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_flowered_1ha
```


**Slice through time at severe drought**

```{r}
p_flowered_cf_slice <-
  pred_f_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "Continuous Forest", y = "P(flowering)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# p_surv_cf_slice
```


```{r}
p_flowered_1ha_slice <-
  pred_f_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "1-ha Fragments", y = "P(flowering)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# p_surv_1ha_slice
```

# Results

## Growth


```{r include=FALSE}
Q <- demog_post$spei_history
L <- demog_post$L

newdata_cf <- 
  tibble(
    log_shts = log(
      seq(min(demog_post_cf$shts, na.rm = TRUE),
          max(demog_post_cf$shts, na.rm = TRUE),
          length.out = 50)
    ),
    spei_history = matrix(mean(Q), ncol = ncol(Q), nrow = 50),
    L = L[1:50, ]
  )

newdata_1ha <- 
  tibble(
    log_shts = log(
      seq(min(demog_post_1ha$shts, na.rm = TRUE),
          max(demog_post_1ha$shts, na.rm = TRUE),
          length.out = 50)
    ),
    spei_history = matrix(mean(Q), ncol = ncol(Q), nrow = 50),
    L = L[1:50, ]
  )

g_cf <- augment(g_post_cf, newdata = newdata_cf, type.predict = "link", se_fit = TRUE)
g_1ha <- augment(g_post_1ha, newdata = newdata_1ha, type.predict = "link", se_fit = TRUE)

g_df <-
  bind_rows(
    "CF" = select(g_cf, log_shts, .fitted, .se.fit),
    "1-ha" = select(g_1ha, log_shts, .fitted, .se.fit),
    .id = "habitat"
  )
```


```{r}
p_growth_shoots <-
  ggplot(g_df, aes(x = exp(log_shts), y = exp(.fitted))) +
  geom_jitter(data = demog_full %>% filter(habitat %in% c("1-ha", "CF")),
              aes(x = shts, y = shts_next), alpha = 0.1) +
  geom_line(color = "blue") +
  geom_ribbon(aes(ymin = exp(.fitted - .se.fit * 1.96),
                  ymax = exp(.fitted + .se.fit * 1.96)),
              alpha = 0.2,
              fill = "blue") +
  labs(x = "size (#shoots)", y = "size (t + 1)") +
  facet_wrap(~habitat) +
  theme_talk
p_growth_shoots
ggsave(here("growth_shoots.png"), p_growth_shoots, width = 10, height = 5)
```
Plants don't grow much.

```{r}
anova(g_post_cf)
anova(g_post_1ha)
```

There's a significant effect of lagged drought on number of shoots in the next year.

```{r}
p_growth_spei <-
  (p_growth_cf | p_growth_1ha) +
  plot_annotation(title = "Effect of drought on growth of average sized plant (~2.8 shoots)") +
  plot_layout(guides = "collect") & theme_talk
p_growth_spei
ggsave(here("growth_spei.png"), p_growth_spei, height = 7, width = 14)
```

It looks like drought in October is bad for growth in fragments, but drought in June and July is much worse for plants in continuous forest.

Reminder that these are still fit with two different models and that `predict()` is using different climate histories (`spei_history`).  Might not be entirely comparable?  Different penalties to the smooths make these hard to compare as well.


Here's a slice through SPEI = -1.5 (severe drought)

```{r}
(p_growth_cf_slice + theme(axis.text.x = element_blank())) /
  p_growth_1ha_slice +
  plot_annotation(title = "Effect of severe drought (SPEI = -1.5) on average sized plant (~2.8 shoots)")
ggsave(here("growth slice.png"))
```

Again, you can see that drought immediately preceding the census (Jan of that year) and in the previous October are bad for growth, but dry Decembers and Septembers are good for growth.

## Survival

```{r include=FALSE}
s_cf <- plot.gam(s_post_cf, shift = coef(s_post_cf)[1])
s_1ha <- plot.gam(s_post_1ha, shift = coef(s_post_1ha)[1])

s_df <-
  bind_rows(
    "CF" = s_cf[[1]][c("x", "fit", "se")] %>% 
      bind_cols(),
    "1-ha" = s_1ha[[1]][c("x", "fit", "se")] %>% 
      bind_cols(),
    .id = "habitat"
  )


s_cf <-  augment(s_post_cf, newdata = newdata_cf, type.predict = "link", se_fit = TRUE)
s_1ha <- augment(s_post_1ha, newdata = newdata_1ha, type.predict = "link", se_fit = TRUE)

s_df <-
  bind_rows(
    "CF" = select(s_cf, log_shts, .fitted, .se.fit),
    "1-ha" = select(s_1ha, log_shts, .fitted, .se.fit),
    .id = "habitat"
  )

```

I'm not 100% sure this is correct since it's not done with `predict()`

```{r}
p_surv_shoots <-
  ggplot(s_df, aes(x = exp(log_shts), y = plogis(.fitted))) +
  geom_line() +
  geom_ribbon(aes(ymin = plogis(.fitted - .se.fit * 1.96),
                  ymax = plogis(.fitted + .se.fit * 1.96)),
              alpha = 0.2) +
  labs(x = "size (#shoots)", y = "P(survival)") +
  facet_wrap(~habitat) +
  stat_summary_bin(data = demog_post %>% filter(habitat %in% c("1-ha", "CF")),
                   geom = "point",
                   fun = mean,
                   bins = 20,
                   aes(y = surv, x = shts)) +
  theme_talk
ggsave(here("surv_shoots.png"), p_surv_shoots, width = 10, height = 5)
```


```{r}
anova(s_post_cf)
anova(s_post_1ha)
```

Drought also has a significant effect on survival in both habitat types.

```{r}
p_surv_spei <- 
  (p_surv_cf|p_surv_1ha) + 
  plot_annotation(title = "Effect of drought on survival") +
  plot_layout(guides = "collect") & theme_talk
ggsave(here("surv_spei.png"), p_surv_spei, width = 14, height = 7)
```

The surface for 1-ha fragments is basically flat except for a slight *negative* effect of recent wet weather on survival.  In continuous forest, drought in the previous February and March has a negative impact on survival.  Wet conditions or very dry conditions in the previous AugustโOctober have a positive effect on survival.


Here's a slice through SPEI = -1.5 (severe drought)

```{r}
((p_surv_cf_slice + theme(axis.text.x = element_blank())) / p_surv_1ha_slice) +
  plot_annotation(title = "Effect of severe drought (SPEI = -1.5)")
ggsave(here("survival slice.png"))
```


## Flowering

```{r include=FALSE}
f_cf <-  augment(f_post_cf,  newdata = newdata_cf,  type.predict = "link", se_fit = TRUE)
f_1ha <- augment(f_post_1ha, newdata = newdata_1ha, type.predict = "link", se_fit = TRUE)
f_df <-
  bind_rows(
    "CF" = select(f_cf, log_shts, .fitted, .se.fit),
    "1-ha" = select(f_1ha, log_shts, .fitted, .se.fit),
    .id = "habitat"
  )
```


```{r}
p_flowered_shoots <-
  ggplot(f_df, aes(x = exp(log_shts), y = plogis(.fitted))) +
  facet_wrap(~habitat) +
  geom_line() +
  geom_ribbon(aes(ymin = plogis(.fitted - .se.fit * 1.96),
                  ymax = plogis(.fitted + .se.fit * 1.96)),
              alpha = 0.2) +
  labs(x = "size (#shoots)", y = "P(flowering)") +
  stat_summary_bin(data = bind_rows(demog_post_1ha, demog_post_cf),
                   geom = "point",
                   fun = ~mean(., na.rm = TRUE),
                   bins = 20,
                   aes(y = flowered, x = shts)) +
  theme_talk
p_flowered_shoots
ggsave(here("flowering_shoots.png"), p_flowered_shoots, width = 10, height = 5)
```
So something weird is going on with the continuous forest data.  All I know is that if I do everything the same, but take the crossbasis smooth out of the GAM, then it looks right:

```{r}
flowergam <-
  gam(flowered ~ s(log_shts),
      family = binomial,
      data = demog_post_cf,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")

augment(flowergam, newdata = newdata_cf) %>% 
  ggplot(aes(x = exp(log_shts), y = plogis(.fitted))) +
  geom_line() +
  stat_summary_bin(geom = "point",
                   data = demog_post_cf %>% filter(!is.na(flowered)),
                   aes(x = exp(log_shts), y = flowered),
                   fun = mean,
                   bins = 20) 
```


```{r}
p_flowered_spei <- 
  (p_flowered_cf|p_flowered_1ha) + 
  plot_annotation(title = "Effect of drought on flowering") +
  plot_layout(guides = "collect") & theme_talk
ggsave(here("flowering_spei.png"), p_flowered_spei, width = 14, height = 7)
```

The surface for 1-ha fragments is basically flat except for a slight *negative* effect of recent wet weather on survival.  In continuous forest, drought in the previous February and March has a negative impact on survival.  Wet conditions or very dry conditions in the previous AugustโOctober have a positive effect on survival.


Here's a slice through SPEI = -1.5 (severe drought)

```{r}
((p_flowered_cf_slice + theme(axis.text.x = element_blank())) / p_flowered_1ha_slice) +
  plot_annotation(title = "Effect of severe drought (SPEI = -1.5)")
ggsave(here("flowering slice.png"))
```