---
title: "FLM for growth as function of SPEI"
author: "Eric R. Scott"
date: "Date Initiated"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
library(tidyverse)
library(here)
library(mgcv)
library(dlnm)
library(bbmle)
library(lubridate)
library(glue)
library(patchwork)
library(sf)
library(tsibble)
library(broom)
library(gratia)

library(conflicted)
conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("slice", "dplyr")

library(HeliconiaDemography) #load functions in this compendium
# devtools::load_all()
```

```{r}
#define plotting themes
theme_talk <- theme_bw() + theme(text = element_text(size = 18))
```


*Last compiled: `r Sys.Date()`*

# TODO:

- Switch measure of plant size to shoots * height
- ~~Change lag to 36 months (3 years)~~
- Produce ridge plot


# Purpose

Take a crack at modeling vital rates as a function of previous height and lagged, non-linear, SPEI.

# Load Data

```{r data, echo=TRUE}
xa <- read_rds(here("analysis", "data", "derived_data", "xa_spei_lags.rds"))
demog <-
  read_csv(
    here("analysis", "data", "derived_data", "ha_survey.csv"),
    col_names = TRUE,
    cols(plot = col_character(),
         bdffp_reserve_no = col_character())
  )
plot_coords <- read_csv(here("analysis", "data", "raw_data", "plot_coords.csv"))
```

# Join data sets

## Prep precip data
Get only rows for february (the month of the census), and year for joining

```{r}
xa2 <- 
  xa %>%
  filter(month(yearmonth) == 2) %>% 
  mutate(year = year(yearmonth), .after =yearmonth) %>% 
  separate(latlon, into = c("lat", "lon"), sep = "_")
xa2
```

Figure out which sites correspond to which grid cells.  The `xa` lat lon are the centers of grid cells that are 0.25º^2

```{r}
unique(xa2$lat)
mean(c(-2.25, -2.5))
```
So, from -2.25 to -2.5


```{r}
unique(xa2$lon)
mean(c(-59.5, -59.75))
mean(c(-59.75, -60)) # Florestal-CF, 5752, 5751, 5750, 5756, CaboFrio-CF
mean(c(-60, -60.25)) # 2206, 2108, 2107, Dimona-CF, 5753, PortoAlegre-CF
```


```{r}
plot_coords
```

```{r}
demog2 <-
  demog %>% 
  mutate(lon = case_when(
    plot %in% c("Florestal-CF", "5752", "5751", "5750", "5756", "CaboFrio-CF") ~ "-59.875",
    plot %in% c("2206", "2108", "2107", "Dimona-CF", "5753", "PortoAlegre-CF") ~ "-60.125",
    TRUE ~ NA_character_
  ), .before = plot)
demog_full <- 
  left_join(demog2, xa2, by = c("lon", "year")) %>% 
  select(-lon, -lat, -yearmonth)
```

## Tidy

There are plants with 0 shoots and 0 ht.  I will remove those, as having no above ground biomass is really not a size, but a different category.
There's also a couple of plants that are probably data entry errors in height.

```{r}
demog_full <-
  demog_full %>% 
  filter(ht < 200, ht_next < 200) %>% 
  filter(shts > 0, shts_next > 0, ht > 0, ht_next > 0) %>% 
  mutate(size = shts*ht, size_next = shts_next*ht_next, log_size = log(size), log_size_next = log(size_next))
```

`gam` wants factors!

```{r}
demog_full <-
  demog_full %>% 
  mutate(across(c(ranch, bdffp_reserve_no, plot, habitat, ha_id_number), as.factor))
# View(demog_full)
```


# Splitting up data

Because I can't model interactions with DLNMs, I can either include factors like habitat as predictors (different intercepts, same functional form, same data) or fit separate models (potentially different functional forms, but not using all the data).

```{r}
demog_post <- 
  demog_full %>% 
  filter(code_notes != "sdlg (1)" | is.na(code_notes))

demog_post_cf <-
  demog_post %>% 
  filter(habitat == "CF")

demog_post_1ha <-
  demog_post %>% 
  filter(habitat == "1-ha")

demog_sdlg <- 
  demog_full %>% 
  filter(code_notes == "sdlg (1)")

demog_sdlg_cf <- 
  demog_sdlg %>% 
  filter(habitat == "CF")

demog_sdlg_1ha <- 
  demog_sdlg %>% 
  filter(habitat == "1-ha")
```


# Growth

Start with no random effects

Using a scaled-t family distribution because residuals were leptokurtic with a gaussian.

## Fit GAMs

Fit the GAM with crossbasis smooth for lagged drought

```{r}
g_post_cf <-
  gam(log_size_next ~ 
        s(log_size) + 
        s(plot, bs = "re") + #random effect of plot
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #unimodal-ish response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      # family = gaussian(link = "identity"),
      family = scat(link = "identity"), #like leptokurtic gaussian.
      data = demog_post_cf,
      # gamma = 1.2, #I maybe need to optimize this with cross-validation?
      method = "REML")
```

Inspect the GAM

```{r}
AIC(g_post_cf)

appraise(g_post_cf)
```

AIC for... 
Gaussian: 40909.27. looks leptokurtic
scaled t: 37284.47.  Waaay better


```{r}
plot(g_post_cf, select = 1, main = "select = FALSE")
```

Hmm. Make sure this doesn't predict negative sizes.

```{r}
summary(g_post_cf)
```


Remember, R-sq is probably so high because size this year is a very good predictor of size next year.

```{r}
g_post_1ha <-
  gam(log_size_next ~ 
        s(log_size) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #unimodal response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      family = scat(link = "identity"), #like leptokurtic gaussian.
      data = demog_post_1ha,
      # gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```

```{r}
appraise(g_post_1ha)
```


```{r}
summary(g_post_1ha)
```

```{r}
plot(g_post_1ha, select = 1)
```

## Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
# use mean size plant across both habitats so plots are comparable
ref_data <-
  demog_post %>%
  dplyr::summarize(log_size = log(mean(size, na.rm = TRUE)),  #log of mean size, not mean of log_size
                   plot = "newlevel")
# exp(1.032814) # 2.8 shoots
mean_size <- round(exp(ref_data$log_size), 1)
```


```{r}
pred_g_post_cf  <- cb_margeff(g_post_cf, Q = spei_history, L = L, ref_data = ref_data)
pred_g_post_1ha <- cb_margeff(g_post_1ha, Q = spei_history, L = L, ref_data = ref_data)
```

Shared color bar limits so scales can be combined.

```{r}
shoot_lim <- c(min(pred_g_post_1ha$fitted, pred_g_post_cf$fitted),
               max(pred_g_post_1ha$fitted, pred_g_post_cf$fitted))
```

## Plots

**Raster plots:**

```{r}
p_growth_cf <-
  pred_g_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = exp(fitted), fill = exp(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("#shoots (t+1)", option = "A", limits = exp(shoot_lim)) +
  labs(title = "Continuous Forest",
       caption = glue("Predicted values for average sized plant ({mean_size} shoots)")) +
  theme_bw()
p_growth_cf
```

```{r}
p_growth_1ha <-
  pred_g_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = exp(fitted), fill = exp(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("#shoots (t+1)", option = "A", limits = exp(shoot_lim)) +
  labs(title = "1-ha Fragments",
       caption = glue("Predicted values for average sized plant ({mean_size} shoots)")) +
  theme_bw()
p_growth_1ha
```


**Slice through time at severe drought**

```{r}
p_growth_cf_slice <-
  pred_g_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = exp(fitted))) +
  geom_ribbon(aes(
    ymin = exp(fitted - se.fit * 1.96),
    ymax = exp(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:36) +
  labs(title = "Continuous Forest", y = "shoots (t+1)") +
  theme_linedraw()
p_growth_cf_slice
```


```{r}
p_growth_1ha_slice <-
  pred_g_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = exp(fitted))) +
  geom_ribbon(aes(
    ymin = exp(fitted - se.fit * 1.96),
    ymax = exp(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:36) +
  labs(title = "1-ha Fragments", y = "shoots (t+1)") +
  theme_linedraw()
p_growth_1ha_slice
```


**Slice through individual months**

I find this less useful, but just shows that relationships are slightly quadratic at most complicated.  This would be more useful if there was a way to show which lines had "slopes" significantly different from 0 (i.e. don't totally overlap a flat line).

```{r}
#TODO: replace with ridge plot
plotdf <-
  pred_g_post_cf %>% 
  mutate(lag = round(lag)) %>% 
  group_by(x, lag) %>% 
  summarize(across(everything(),  mean))

foo <- function(x) {
  x <- as.numeric(x)
  mon <- month(ymd("2020-2-01") - months(x), label = TRUE)
  l <- glue("lag={x} ({mon})")
  return(l)
}

p_growth_cf_months <-
  plotdf %>% 
  ggplot(aes(x = x, y = exp(fitted))) +
  geom_ribbon(aes(
    ymin = exp(fitted - se.fit * 1.96),
    ymax = exp(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("SPEI3") +
  scale_y_continuous("shoots (t+1)") +
  facet_wrap(~lag, labeller = as_labeller(foo)) +
  theme_bw()
p_growth_cf_months
```

# Survival

## Fit GAMs

```{r}
s_post_cf <-
  gam(surv ~ 
        s(log_size) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_cf,
      # gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```
```{r}
# gam.check(s_post_cf) #not sure what to expect from any of these plots
appraise(s_post_cf, method = "simulate")
```
```{r}
summary(s_post_cf)
```
wow, not significant!

```{r}
s_post_1ha <-
  gam(surv ~ 
        s(log_size) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_1ha,
      # gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```
```{r}
summary(s_post_1ha)
```
not significant!  I should try select=TRUE here.

## Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
pred_s_post_cf  <- cb_margeff(s_post_cf,  Q = spei_history, L = L, ref_data = ref_data)
pred_s_post_1ha <- cb_margeff(s_post_1ha, Q = spei_history, L = L, ref_data = ref_data)
```

Shared color bar limits so scales can be combined.

```{r}
surv_lim <- c(min(pred_s_post_1ha$fitted, pred_s_post_cf$fitted),
              max(pred_s_post_1ha$fitted, pred_s_post_cf$fitted))
# plogis(surv_lim)
```

## Plots

These are not significant, so probably don't need to actually make these plots.  I'm mostly just curious what a non-significant crossbasis function looks like.

```{r}
p_surv_cf <-
  pred_s_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "Continuous Forest",
       caption = glue("Predicted values for average sized plant ({mean_size} shoots)")) +
  theme_bw()
p_surv_cf
```

```{r}
p_surv_1ha <-
  pred_s_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "1-ha Fragments",
       caption = glue("Predicted values for average sized plant ({mean_size} shoots)")) +
  theme_bw()
p_surv_1ha
```


**Slice through time at severe drought**

```{r}
p_surv_cf_slice <-
  pred_s_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:36) +
  labs(title = "Continuous Forest", y = "P(survival)") +
  theme_linedraw()
p_surv_cf_slice
```


```{r}
p_surv_1ha_slice <-
  pred_s_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:36) +
  labs(title = "1-ha Fragments", y = "P(survival)") +
  theme_linedraw()
p_surv_1ha_slice
```

# Flowering Probability

## Fit GAMs

```{r}
x <- demog_post_cf$flwr
sum(x, na.rm = TRUE) / length(x)
```

Around 0.05 percent of plants flowered.

```{r}
f_post_cf <-
  gam(flwr ~ 
        s(log_size) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_cf,
      # gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```

```{r}
appraise(f_post_cf)
```


```{r}
summary(f_post_cf)
```

```{r}
plot(f_post_cf, select = 1, trans = plogis)
```

Plants with exp(3) = 20 shoots have close to a 100% chance of flowering.

```{r}
f_post_1ha <-
  gam(flwr ~ 
        s(log_size) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_1ha,
      # gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```

```{r}
appraise(f_post_1ha)
```


```{r}
summary(f_post_1ha)
```

```{r}
plot(f_post_1ha, select = 1, trans = plogis)
```

## Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
pred_f_post_cf  <- cb_margeff(f_post_cf,  Q = spei_history, L = L, ref_data = ref_data)
pred_f_post_1ha <- cb_margeff(f_post_1ha, Q = spei_history, L = L, ref_data = ref_data)
```

Shared color bar limits so scales can be combined.

```{r}
flowered_lim <- c(min(pred_f_post_1ha$fitted, pred_f_post_cf$fitted),
                  max(pred_f_post_1ha$fitted, pred_f_post_cf$fitted))
plogis(flowered_lim)
```

## Plots

```{r}
p_flowered_cf <-
  pred_f_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_flowered_cf
```



```{r}
p_flowered_1ha <-
  pred_f_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_flowered_1ha
```
very similar to growth

**Slice through time at severe drought**

```{r}
p_flowered_cf_slice <-
  pred_f_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:36) +
  labs(title = "Continuous Forest", y = "P(flowering)") +
  theme_linedraw() 
p_flowered_cf_slice
```


```{r}
p_flowered_1ha_slice <-
  pred_f_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:36) +
  labs(title = "1-ha Fragments", y = "P(flowering)") +
  theme_linedraw()
p_flowered_1ha_slice
```

# Plots
## Growth
```{r}
p_growth_spei <-
  (p_growth_cf | p_growth_1ha) +
  plot_annotation(title = "Effect of drought on growth of average sized plant (~2.8 shoots)") +
  plot_layout(guides = "collect") & theme_talk & labs(caption = "")
p_growth_spei
ggsave(here("analysis", "figures", "growth_spei.png"), p_growth_spei, height = 7, width = 14)
```

It looks like drought in September/October is bad for growth.

Reminder that these are still fit with two different models and might not be entirely comparable.  Different penalties to the smooths make these hard to compare as well.


Here's a slice through SPEI = -1.5 (severe drought)

```{r}
(p_growth_cf_slice + theme(axis.text.x = element_blank())) /
  p_growth_1ha_slice +
  plot_annotation(title = "Effect of severe drought (SPEI = -1.5) on average sized plant (~2.8 shoots)")
ggsave(here("analysis", "figures", "growth slice.png"))
```

Again, you can see that drought immediately preceding the census (Jan of that year) and in the previous October are bad for growth, but dry Decembers and Septembers are good for growth.

## Survival

These aren't significant.

```{r}
p_surv_spei <- 
  (p_surv_cf|p_surv_1ha) + 
  plot_annotation(title = "Effect of drought on survival") +
  plot_layout(guides = "collect") & theme_talk & labs(caption="")
p_surv_spei
ggsave(here("analysis", "figures", "surv_spei.png"), p_surv_spei, width = 14, height = 7)
```

The surface for 1-ha fragments is basically flat except for a slight *negative* effect of recent wet weather on survival.  In continuous forest, wet conditions or very dry conditions in the previous August–October have a positive effect on survival.


Here's a slice through SPEI = -1.5 (severe drought)

```{r}
((p_surv_cf_slice + theme(axis.text.x = element_blank())) / p_surv_1ha_slice) +
  plot_annotation(title = "Effect of severe drought (SPEI = -1.5)")
ggsave(here("analysis", "figures", "survival slice.png"))
```
Pretty flat.

## Flowering

```{r}
p_flowered_spei <- 
  (p_flowered_cf|p_flowered_1ha) + 
  plot_annotation(title = "Effect of drought on flowering") +
  plot_layout(guides = "collect") & theme_talk & labs(caption = "")
p_flowered_spei
ggsave(here("analysis", "figures", "flowering_spei.png"), p_flowered_spei, width = 14, height = 7)
```

The surface for continuous forest is perfectly flat (did I do something wrong with the color scale?) and for 1-ha fragments there is a strange (anomalous?) negative effect of high SPEI (wet conditions) in the summer 2 years ago.


Here's a slice through SPEI = -1.5 (severe drought)

```{r}
((p_flowered_cf_slice + theme(axis.text.x = element_blank())) / p_flowered_1ha_slice) +
  plot_annotation(title = "Effect of severe drought (SPEI = -1.5)")
ggsave(here("analysis", "figures", "flowering slice.png"))
```

