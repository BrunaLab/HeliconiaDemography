---
title: "FLM for growth as function of SPEI"
author: "Eric R. Scott"
date: "Date Initiated"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
library(tidyverse)
library(here)
library(mgcv)
library(dlnm)
library(bbmle)
library(lubridate)
library(glue)
library(patchwork)
library(sf)
library(tsibble)
library(broom)
library(gratia)
library(latex2exp)

library(conflicted)
conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("slice", "dplyr")

library(HeliconiaDemography) #load functions in this compendium
# devtools::load_all()
```

```{r}
#define plotting themes
theme_talk <- theme_bw() + theme(text = element_text(size = 18))
```

*Last compiled: `r Sys.Date()`*

# TODO:

- ~~Switch measure of plant size to shoots * height~~
- ~~Change lag to 36 months (3 years)~~
- Produce ridge plot
- Heatmap for growth should be ∆size
- try select = TRUE (after you understand it better? blog about it first)

# Purpose

Take a crack at modeling vital rates as a function of previous height and lagged, non-linear, SPEI.

# Load Data

```{r data, echo=TRUE}
xa <- read_rds(here("analysis", "data", "derived_data", "xa_spei_lags.rds"))
demog <-
  read_csv(
    here("analysis", "data", "derived_data", "ha_survey.csv"),
    col_names = TRUE,
    cols(plot = col_character(),
         bdffp_reserve_no = col_character())
  )
plot_coords <- read_csv(here("analysis", "data", "raw_data", "plot_coords.csv"))
```

# Join data sets

## Prep precip data

Get only rows for february (the month of the census), and year for joining

```{r}
xa2 <- 
  xa %>%
  filter(month(yearmonth) == 2) %>% 
  mutate(year = year(yearmonth), .after =yearmonth) %>% 
  separate(latlon, into = c("lat", "lon"), sep = "_")
xa2
```

Figure out which sites correspond to which grid cells.  The `xa` lat lon are the centers of grid cells that are 0.25º^2

```{r}
unique(xa2$lat)
mean(c(-2.25, -2.5))
```

So, from -2.25 to -2.5

```{r}
unique(xa2$lon)
mean(c(-59.5, -59.75))
mean(c(-59.75, -60)) # Florestal-CF, 5752, 5751, 5750, 5756, CaboFrio-CF
mean(c(-60, -60.25)) # 2206, 2108, 2107, Dimona-CF, 5753, PortoAlegre-CF
```

```{r}
plot_coords
```

```{r}
demog2 <-
  demog %>% 
  mutate(lon = case_when(
    plot %in% c("Florestal-CF", "5752", "5751", "5750", "5756", "CaboFrio-CF") ~ "-59.875",
    plot %in% c("2206", "2108", "2107", "Dimona-CF", "5753", "PortoAlegre-CF") ~ "-60.125",
    TRUE ~ NA_character_
  ), .before = plot)
demog_full <- 
  left_join(demog2, xa2, by = c("lon", "year")) %>% 
  select(-lon, -lat, -yearmonth)
```

## Tidy

There are plants with 0 shoots and 0 ht.  I will remove those, as having no above ground biomass is really not a size, but a different category.
There's also a couple of plants that are probably data entry errors in height.

```{r}
demog_full <-
  demog_full %>% 
  filter(ht < 200 | is.na(ht), ht_prev < 200 | is.na(ht_prev)) %>%
  filter(
    # having no aboveground biomass is possible, but categorically different than just being small. Exclude plants with 0 shoots or 0 height
    shts_prev > 0,
    ht_prev > 0,
    #for survival data, must include plants with NA for shts and height (i.e. dead plants)
    shts > 0 | is.na(shts), 
    ht > 0 | is.na(ht)
  ) %>%
  mutate(size = shts*ht, size_prev = shts_prev * ht_prev, log_size = log(size), log_size_prev = log(size_prev))
```


`gam` wants factors!

```{r}
demog_full <-
  demog_full %>% 
  mutate(across(c(ranch, bdffp_reserve_no, plot, habitat, ha_id_number), as.factor)) %>% 
  mutate(year_fac = as.factor(year))
# View(demog_full)
```


# Splitting up data

Because I can't model interactions with DLNMs, I can either include factors like habitat as predictors (different intercepts, same functional form, same data) or fit separate models (potentially different functional forms, but not using all the data).

```{r}
demog_post <- 
  demog_full %>% 
  filter(code_notes != "sdlg (1)" | is.na(code_notes))

demog_post_cf <-
  demog_post %>% 
  filter(habitat == "CF")

demog_post_1ha <-
  demog_post %>% 
  filter(habitat == "1-ha")

demog_sdlg <- 
  demog_full %>% 
  filter(code_notes == "sdlg (1)")

demog_sdlg_cf <- 
  demog_sdlg %>% 
  filter(habitat == "CF")

demog_sdlg_1ha <- 
  demog_sdlg %>% 
  filter(habitat == "1-ha")
```

# Inspect raw data

```{r}
demog_post %>% ggplot(aes(x = surv)) + geom_bar() + facet_wrap(~habitat)
```
```{r}
demog_post %>% ggplot(aes(x = habitat, y = log_size)) + geom_boxplot()
```
```{r}
demog_post %>% ggplot(aes(x = flwr)) + geom_bar() + facet_wrap(~habitat)
```
# Speed up models with bam()

I'm going to start fitting these with `bam()` to speed things up.  This sets up the paralellization.  CAUTION: you may need to change these settings for your machine.

```{r}
library(parallel)
ncores <- detectCores()
cl <- makeForkCluster(ncores - 2)
```

# Survival
`surv` is 1 in `year`s when a plant is alive and 0 in the first `year` when the plant is dead.  These GAMs model the survival of a plant (over the past year) as a function of size in the previous census and SPEI values starting at february of the current year going back 36 months.
## Fit GAMs

```{r}
s_post_cf <-
  bam(surv ~ 
        s(log_size_prev) +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_cf,
      method = "REML",
      select = TRUE,
      cluster = cl)
```


```{r}
# gam.check(s_post_cf) #not sure what to expect from any of these plots
appraise(s_post_cf)
```

```{r}
summary(s_post_cf)
```

```{r}
draw(s_post_cf)
```

```{r}
s_post_1ha <-
  bam(surv ~ 
        s(log_size_prev) +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_1ha,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

```{r}
summary(s_post_1ha)
```


```{r}
draw(s_post_1ha)
```

## Covariate plots

Effect of size with all else held average.

```{r}
sr <- range(demog_post_cf$log_size_prev)

newdata_covar_cf <- 
  tibble(log_size_prev = seq(sr[1], sr[2], length.out = 100),
         plot = "newplot",
         year_fac = "newyear", 
         spei_history = mean(demog_post_cf$spei_history),
         L = demog_post_cf$L[1:100, ])
```


```{r}
out <- augment(s_post_cf, newdata = newdata_covar_cf, se_fit = TRUE)

covar_s_cf <-
  ggplot(out, aes(x = exp(log_size_prev), y = plogis(.fitted))) + 
  stat_summary_bin(geom = "point", fun = mean, aes(y = surv), data = demog_post_cf) +
  geom_ribbon(aes(ymin = plogis(.fitted - .se.fit * 1.96), ymax = plogis(.fitted + .se.fit * 1.96)), alpha = 0.3) +
  geom_line(color = "blue") +
  labs(x = TeX("size_t_"), y = "P(survival)") +
  theme_linedraw()

covar_s_cf
ggsave(here("analysis", "figures", "surv_cf_size.png"), covar_s_cf)
```


```{r}
sr <- range(demog_post_1ha$log_size_prev)
newdata_covar_1ha <- 
  tibble(log_size_prev = seq(sr[1], sr[2], length.out = 100),
         plot = "newplot",
         year_fac = "newyear",
         spei_history = mean(demog_post_1ha$spei_history),
         L = demog_post_cf$L[1:100, ])

out <- augment(s_post_1ha, newdata = newdata_covar_1ha, se_fit = TRUE)

covar_s_1ha <-
  ggplot(out, aes(x = exp(log_size_prev), y = plogis(.fitted))) + 
  stat_summary_bin(geom = "point", fun = mean, aes(y = surv), data = demog_post_1ha) +
  geom_ribbon(aes(ymin = plogis(.fitted - .se.fit * 1.96), ymax = plogis(.fitted + .se.fit * 1.96)), alpha = 0.3) +
  geom_line(color = "blue") +
  labs(x = TeX("size_t_"), y = "P(survival)") +
  theme_linedraw()

covar_s_1ha
ggsave(here("analysis", "figures", "surv_1ha_size.png"), covar_s_1ha)
```

## Get plot data

```{r}
# use mean size plant across both habitats so plots are comparable
ref_data <-
  demog_post %>%
  dplyr::summarize(log_size_prev = log(mean(size_prev, na.rm = TRUE)),  #log of mean size, not mean of log_size
                   year_fac = "newyear",
                   plot = "newlevel")

mean_size <- exp(ref_data$log_size_prev)
```

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
pred_s_post_cf  <- cb_margeff(s_post_cf,  Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
pred_s_post_1ha <- cb_margeff(s_post_1ha, Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
```

Shared color bar limits so scales can be combined.

```{r}
surv_lim <- c(min(pred_s_post_1ha$fitted, pred_s_post_cf$fitted),
              max(pred_s_post_1ha$fitted, pred_s_post_cf$fitted))
# plogis(surv_lim)
```

## Plots

```{r}
#mean survival
x <- demog_post$surv
sum(x, na.rm = TRUE) / length(x)
```

```{r}
p_surv_cf <-
  pred_s_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_surv_cf
ggsave(here("analysis", "figures", "surv_cf_spei.png"), p_surv_cf)
```

```{r}
p_surv_1ha <-
  pred_s_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_surv_1ha
ggsave(here("analysis", "figures", "surv_1ha_spei.png"), p_surv_1ha)
```


**Slice through time at severe drought**

```{r}
p_surv_cf_slice <-
  pred_s_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:36) +
  labs(title = "Continuous Forest", y = "P(survival)") +
  theme_linedraw()
p_surv_cf_slice
```


```{r}
p_surv_1ha_slice <-
  pred_s_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:36) +
  labs(title = "1-ha Fragments", y = "P(survival)") +
  theme_linedraw()
p_surv_1ha_slice
```

# Growth
For mature plants that are alive...

```{r}
demog2_post_cf <- demog_post_cf %>% filter(surv == 1, !is.na(log_size))
demog2_post_1ha <- demog_post_1ha %>% filter(surv == 1, !is.na(log_size))
```


## Fit GAMs

Fit the GAM with crossbasis smooth for lagged drought.
Using a scaled-t family distribution because residuals were leptokurtic with a gaussian.
Preliminary modeling showed that if year is included as random effect it is concurve with SPEI history (which would mean biased p-values and coefficients).

The transformed response and identity link is actually better than a log-link, according to Ellner, Childs and Rees.

```{r}
g_post_cf <-
  bam(log_size ~ 
        s(log_size_prev) + 
        # s(year_fac, bs = "re") + 
        s(plot, bs = "re") + #random effect of plot
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #unimodal-ish response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      # family = gaussian(link = "identity"),
      family = scat(link = "identity"), #like leptokurtic gaussian.
      data = demog2_post_cf,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

Inspect the GAM

```{r}
AIC(g_post_cf)
appraise(g_post_cf)
```

AIC for... 
Gaussian: ~40909.27. looks leptokurtic
scaled t: ~37284.47.  Waaay better

```{r}
summary(g_post_cf)
```

Remember, R-sq is probably so high because size this year is a very good predictor of size next year.

```{r}
draw(g_post_cf)
```

```{r}
g_post_1ha <-
  bam(log_size ~ 
        s(log_size_prev) +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #unimodal response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      family = scat(link = "identity"), #like leptokurtic gaussian.
      data = demog2_post_1ha,
      select = TRUE,
      method = "REML",
      cluster = cl)
```

```{r}
appraise(g_post_1ha)
```

```{r}
summary(g_post_1ha)
```

```{r}
draw(g_post_1ha)
```

## Covariate plots

Effect of size with all else held average.

```{r}
out <- augment(g_post_cf, newdata = newdata_covar_cf, se_fit = TRUE)

covar_growth_cf <-
  ggplot(out, aes(x = exp(log_size_prev), y = exp(.fitted))) + 
  geom_point(data = demog_post_cf, aes(x = size_prev, y = size), alpha = 0.1) +
  geom_ribbon(aes(ymin = exp(.fitted - .se.fit * 1.96), ymax = exp(.fitted + .se.fit * 1.96)), alpha = 0.3) +
  geom_abline(slope = 1, linetype = 2, color = "red") +
  geom_line(color = "blue") +
  # geom_rug(data = demog_post_cf, aes(x = size, y = size_next), alpha = 0.25) +
  theme_linedraw() +
  labs(x = TeX("size_t_"), y = TeX("size_{t+1}_"))
covar_growth_cf
ggsave(here("analysis", "figures", "growth_cf_size.png"), covar_growth_cf)
```
```{r}
out %>%
  filter(exp(log_size_prev) > exp(.fitted)) %>% # shinking plants
  pull(log_size_prev) %>% min() %>% exp() #first size at which shrinking happens.
```

```{r}
out <- augment(g_post_1ha, newdata = newdata_covar_1ha, se_fit = TRUE)

covar_growth_1ha <-
  ggplot(out, aes(x = exp(log_size_prev), y = exp(.fitted))) + 
  geom_point(data = demog_post_1ha, aes(x = size_prev, y = size), alpha = 0.1) +
  geom_ribbon(aes(ymin = exp(.fitted - .se.fit * 1.96), ymax = exp(.fitted + .se.fit * 1.96)), alpha = 0.3) +
  geom_abline(slope = 1, linetype = 2, color = "red") +
  geom_line(color = "blue") +
  # geom_rug(data = demog_post_1ha, aes(x = size, y = size_next), alpha = 0.25) +
  theme_linedraw() +
  labs(x = TeX("size_t_"), y = TeX("size_{t+1}_"))

covar_growth_1ha
ggsave(here("analysis", "figures", "growth_1ha_size.png"), covar_growth_1ha)
```
```{r}
out %>%
  filter(exp(log_size_prev) > exp(.fitted)) %>% #shrinking plants
  pull(log_size_prev) %>% min() %>% exp() #smallest size where plants start shrinking
```

## Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
pred_g_post_cf  <- cb_margeff(g_post_cf, Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
pred_g_post_1ha <- cb_margeff(g_post_1ha, Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
```

Calculate growth as change from year t to year t+1

```{r}
mean_size # size in year t for fitted values

pred_g_post_cf <- 
  pred_g_post_cf %>% 
  mutate(e_fitted = exp(fitted),
         d_fitted = e_fitted - mean_size)

pred_g_post_1ha <-
  pred_g_post_1ha %>% 
  mutate(e_fitted = exp(fitted),
         d_fitted = e_fitted - mean_size)
```

Shared color bar limits so scales can be combined.

```{r}
shoot_lim <- c(min(pred_g_post_1ha$d_fitted, pred_g_post_cf$d_fitted),
               max(pred_g_post_1ha$d_fitted, pred_g_post_cf$d_fitted))
```

## Plots

```{r}
p_growth_cf <-
  pred_g_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = d_fitted, fill = d_fitted)) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c(TeX("$\\Delta$ size"), option = "A", limits = shoot_lim) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_growth_cf
ggsave(here("analysis", "figures", "growth_cf_spei.png"), p_growth_cf)
```

```{r}
p_growth_1ha <-
  pred_g_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = d_fitted, fill = d_fitted)) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) +
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c(TeX("$\\Delta$ size"), option = "A", limits = shoot_lim) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_growth_1ha
ggsave(here("analysis", "figures", "growth_1ha_spei.png"), p_growth_1ha)
```


**Slice through time at severe drought**

```{r}
# p_growth_cf_slice <-
#   pred_g_post_cf %>% 
#   filter(nearest(x, -1.50)) %>% 
#   ggplot(aes(x = lag, y = exp(fitted))) +
#   geom_ribbon(aes(
#     ymin = exp(fitted - se.fit * 1.96),
#     ymax = exp(fitted + se.fit * 1.96)
#   ), alpha = 0.3)+
#   geom_line() +
#   scale_x_continuous("lag(months)", breaks = 0:36) +
#   labs(title = "Continuous Forest", y = "shoots (t+1)") +
#   theme_linedraw()
# p_growth_cf_slice
```


```{r}
# p_growth_1ha_slice <-
#   pred_g_post_1ha %>% 
#   filter(nearest(x, -1.5)) %>% 
#   ggplot(aes(x = lag, y = exp(fitted))) +
#   geom_ribbon(aes(
#     ymin = exp(fitted - se.fit * 1.96),
#     ymax = exp(fitted + se.fit * 1.96)
#   ), alpha = 0.3)+
#   geom_line() +
#   scale_x_continuous("lag(months)", breaks = 0:36) +
#   labs(title = "1-ha Fragments", y = "shoots (t+1)") +
#   theme_linedraw()
# p_growth_1ha_slice
```


**Slice through individual months**
TODO: Change to ridge plots?

I find this less useful, but just shows that relationships are slightly quadratic at most complicated.  This would be more useful if there was a way to show which lines had "slopes" significantly different from 0 (i.e. don't totally overlap a flat line).

```{r}
# #TODO: replace with ridge plot
# plotdf <-
#   pred_g_post_cf %>% 
#   mutate(lag = round(lag)) %>% 
#   group_by(x, lag) %>% 
#   summarize(across(everything(),  mean))
# 
# foo <- function(x) {
#   x <- as.numeric(x)
#   mon <- month(ymd("2020-2-01") - months(x), label = TRUE)
#   l <- glue("lag={x} ({mon})")
#   return(l)
# }
# 
# p_growth_cf_months <-
#   plotdf %>% 
#   ggplot(aes(x = x, y = exp(fitted))) +
#   geom_ribbon(aes(
#     ymin = exp(fitted - se.fit * 1.96),
#     ymax = exp(fitted + se.fit * 1.96)
#   ), alpha = 0.3)+
#   geom_line() +
#   scale_x_continuous("SPEI3") +
#   scale_y_continuous("shoots (t+1)") +
#   facet_wrap(~lag, labeller = as_labeller(foo)) +
#   theme_bw()
# p_growth_cf_months
```



# Flowering Probability

## Fit GAMs

```{r}
x <- demog_post$flwr
sum(x, na.rm = TRUE) / length(x)
```

Around 5 percent of plants flowered.

```{r}
f_post_cf <-
  bam(flwr ~ 
        s(log_size_prev) +
        # s(year_fac, bs = "re") + 
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog2_post_cf,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

Doesn't converge with random effect of year

```{r}
appraise(f_post_cf)
# concurvity(f_post_cf, full = FALSE)
```

these residuals are troubling

```{r}
summary(f_post_cf)
```

```{r}
draw(f_post_cf)
```

This model changes **drastically** depending on whether year is included as a random effect.  Does that mean ther random effect is important? Or is it because it is collinear / concurve with SPEI history?

```{r}
f_post_1ha <-
  bam(flwr ~ 
        s(log_size_prev) +
        # s(year_fac, bs = "re") +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 35),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog2_post_1ha,
      method = "REML",
      select = TRUE,
      cluster = cl)
```

```{r}
appraise(f_post_1ha)
```

```{r}
summary(f_post_1ha)
```

```{r}
draw(f_post_1ha)
```

## Covariate plots

Effect of size with all else held average.

```{r}
out <- augment(f_post_cf, newdata = newdata_covar_cf, se_fit = TRUE)

covar_f_cf <-
  ggplot(out, aes(x = exp(log_size_prev), y = plogis(.fitted))) + 
  stat_summary_bin(geom = "point", fun = mean, aes(y = flwr), data = demog_post_cf) +
  geom_ribbon(aes(ymin = plogis(.fitted - .se.fit * 1.96), ymax = plogis(.fitted + .se.fit * 1.96)), alpha = 0.3) +
  geom_line(color = "blue") +
  labs(x = TeX("size_t_"), y = "P(flowering)") +
  theme_linedraw()

covar_f_cf
ggsave(here("analysis", "figures", "flwr_cf_size.png"), covar_f_cf)
```


```{r}
out <- augment(f_post_1ha, newdata = newdata_covar_1ha, se_fit = TRUE)

covar_f_1ha <-
  ggplot(out, aes(x = exp(log_size_prev), y = plogis(.fitted))) + 
  stat_summary_bin(geom = "point", fun = mean, aes(y = flwr), data = demog_post_1ha) +
  geom_ribbon(aes(ymin = plogis(.fitted - .se.fit * 1.96), ymax = plogis(.fitted + .se.fit * 1.96)), alpha = 0.3) +
  geom_line(color = "blue") +
  labs(x = TeX("size_t_"), y = "P(flowering)") +
  theme_linedraw()

covar_f_1ha
ggsave(here("analysis", "figures", "flwr_1ha_size.png"), covar_f_1ha)
```

## Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
pred_f_post_cf  <- cb_margeff(f_post_cf,  Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
pred_f_post_1ha <- cb_margeff(f_post_1ha, Q = spei_history, L = L, ref_data = ref_data, cluster = cl)
```

Shared color bar limits so scales can be combined.

```{r}
flowered_lim <- c(min(pred_f_post_1ha$fitted, pred_f_post_cf$fitted),
                  max(pred_f_post_1ha$fitted, pred_f_post_cf$fitted))
plogis(flowered_lim)
```

## Plots

```{r}
p_flowered_cf <-
  pred_f_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_flowered_cf
ggsave(here("analysis", "figures", "flwr_cf_spei.png"), p_flowered_cf)
```



```{r}
p_flowered_1ha <-
  pred_f_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:36, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "month",
      labels = month(ymd("2020-2-01") - months(0:36), label = TRUE))
  ) + 
  scale_x_continuous(TeX("SPEI_3_"), expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_flowered_1ha
ggsave(here("analysis", "figures", "flwr_1ha_spei.png"), p_flowered_1ha)
```
very similar to growth

**Slice through time at severe drought**

```{r}
p_flowered_cf_slice <-
  pred_f_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:36) +
  labs(title = "Continuous Forest", y = "P(flowering)") +
  theme_linedraw() 
p_flowered_cf_slice
```


```{r}
p_flowered_1ha_slice <-
  pred_f_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:36) +
  labs(title = "1-ha Fragments", y = "P(flowering)") +
  theme_linedraw()
p_flowered_1ha_slice
```

# Plots
## Growth
```{r}
p_growth_spei <-
  (p_growth_cf | p_growth_1ha) +
  plot_annotation(title = "Effect of drought on growth") +
  plot_layout(guides = "collect") & theme_talk & labs(caption = "")
p_growth_spei
# ggsave(here("analysis", "figures", "growth_spei.png"), p_growth_spei, height = 7, width = 14)
```

## Survival

These aren't significant.

```{r}
p_surv_spei <- 
  (p_surv_cf|p_surv_1ha) + 
  plot_annotation(title = "Effect of drought on survival") +
  plot_layout(guides = "collect") & theme_talk & labs(caption="")
p_surv_spei
# ggsave(here("analysis", "figures", "surv_spei.png"), p_surv_spei, width = 14, height = 7)
```


## Flowering

```{r}
p_flowered_spei <- 
  (p_flowered_cf|p_flowered_1ha) + 
  plot_annotation(title = "Effect of drought on flowering") +
  plot_layout(guides = "collect") & theme_talk & labs(caption = "")
p_flowered_spei
# ggsave(here("analysis", "figures", "flowering_spei.png"), p_flowered_spei, width = 14, height = 7)
```


