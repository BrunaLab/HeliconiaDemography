---
title: "FLM for growth as function of SPEI"
author: "Eric R. Scott"
date: "Date Initiated"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
library(tidyverse)
library(here)
library(mgcv)
library(dlnm)
library(bbmle)
library(lubridate)
library(glue)
library(patchwork)
library(sf)
library(tsibble)
library(broom)

library(conflicted)
conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("slice", "dplyr")

library(HeliconiaDemography) #load functions in this compendium
# devtools::load_all()
```

```{r}
#define plotting themes
theme_talk <- theme_bw() + theme(text = element_text(size = 18))
```


*Last compiled: `r Sys.Date()`*

# TODO:

- 
- ~~Remove seedlings from dataset, for now~~
- ~~Separate models for CF and fragment, for now~~
- Add model for probability of reproduction and other vital rates
- Model seedlings separately?
- Add random effects, interactions, other complexities
- Try integrative measure of size.  Some paper you read did some formula with height and leaf number. Plantago?

# Purpose

Take a crack at modeling vital rates as a function of previous height and lagged, non-linear, SPEI.

# Load Data

```{r data, echo=TRUE}
xa <- read_rds(here("analysis", "data", "derived_data", "xa_spei_lags.rds"))
demog <- read_rds(here("analysis", "data", "derived_data", "ha_survey.rds"))
plot_coords <- read_csv(here("analysis", "data", "raw_data", "plot_coords.csv"))
```

```{r}
length(unique(demog$ha_id_number))
range(demog$year)
2009-1998
```


# Join data sets

## Prep precip data
Get only rows for february (the month of the census), and year for joining

```{r}
xa2 <- 
  xa %>%
  filter(month(yearmonth) == 2) %>% 
  mutate(year = year(yearmonth), .after =yearmonth) %>% 
  separate(latlon, into = c("lat", "lon"), sep = "_")
xa2
```

Figure out which sites correspond to which grid cells.  The `xa` lat lon are the centers of grid cells that are 0.25º^2

```{r}
unique(xa2$lat)
mean(c(-2.25, -2.5))
```
So, from -2.25 to -2.5


```{r}
unique(xa2$lon)
mean(c(-59.5, -59.75))
mean(c(-59.75, -60)) # Florestal-CF, 5752, 5751, 5750, 5756, CaboFrio-CF
mean(c(-60, -60.25)) # 2206, 2108, 2107, Dimona-CF, 5753, PortoAlegre-CF
```


```{r}
plot_coords
```

```{r}
demog2 <-
  demog %>% 
  mutate(lon = case_when(
    plot %in% c("Florestal-CF", "5752", "5751", "5750", "5756", "CaboFrio-CF") ~ "-59.875",
    plot %in% c("2206", "2108", "2107", "Dimona-CF", "5753", "PortoAlegre-CF") ~ "-60.125",
    TRUE ~ NA_character_
  ), .before = plot)
demog_full <- 
  full_join(demog2, xa2, by = c("lon", "year")) %>% 
  select(-lon, -lat, -yearmonth)
```

## Tidy

```{r}
demog_full <-
  demog_full %>% 
  mutate(log_shts = log(shts), .after = shts) %>% 
  mutate(log_shts_next = log(shts_next), .after = shts_next)
```

`gam` wants factors!

```{r}
demog_full <-
  demog_full %>% 
  mutate(across(c(ranch, bdffp_reserve_no, plot, habitat, ha_id_number), as.factor)) %>% 
  mutate(flowered = as.numeric(infl > 0), .after = infl)
# View(demog_full)
```

# Splitting up data

Because I can't model interactions with DLNMs, I can either include factors like habitat as predictors (different intercepts, same functional form, same data) or fit separate models (potentially different functional forms, but not using all the data).

```{r}
demog_post <- 
  demog_full %>% 
  filter(code_notes != "sdlg (1)" | is.na(code_notes))

demog_post_cf <-
  demog_post %>% 
  filter(habitat == "CF")

demog_post_1ha <-
  demog_post %>% 
  filter(habitat == "1-ha")

demog_sdlg <- 
  demog_full %>% 
  filter(code_notes == "sdlg (1)")

demog_sdlg_cf <- 
  demog_sdlg %>% 
  filter(habitat == "CF")

demog_sdlg_1ha <- 
  demog_sdlg %>% 
  filter(habitat == "1-ha")
```


## Growth

Start with no random effects

Using a scaled-t family distribution because residuals were leptokurtic with a gaussian.

### Fit GAMs

Fit the GAM with crossbasis smooth for lagged drought

```{r}
g_post_cf <-
  gam(shts_next ~ 
        s(log_shts) + #does this *need* to be log # shoots?
        # s(year, bs = "re") + #random effect of year
        s(plot, bs = "re") + #random effect of plot
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #unimodal-ish response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      family = scat(link = "log"),
      data = demog_post_cf,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```

Inspect the GAM

```{r}
gam.check(g_post_cf) 
```

Suggests possibly more knots for s(log_shts), but it looks like a straight line to me

```{r}
plot(g_post_cf, pages=1)
```

```{r}
summary(g_post_cf)
```


Remember, R-sq is probably so high because size this year is a very good predictor of size next year.

```{r}
g_post_1ha <-
  gam(shts_next ~ 
        s(log_shts) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #unimodal response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      family = scat(link = "log"),
      data = demog_post_1ha,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```

```{r}
gam.check(g_post_1ha)
```

Looks great

```{r}
summary(g_post_1ha)
```

### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
# use mean size plant across both habitats so plots are comparable
ref_data <-
  demog_post %>%
  dplyr::summarize(log_shts = log(mean(shts, na.rm = TRUE)),  #log of mean shoots, not mean of log_shts
                   plot = "newlevel")
# exp(1.032814) # 2.8 shoots
```


```{r}
pred_g_post_cf  <- cb_margeff(g_post_cf, Q = spei_history, L = L, ref_data = ref_data)
pred_g_post_1ha <- cb_margeff(g_post_1ha, Q = spei_history, L = L, ref_data = ref_data)
```

Lag labels

```{r}
# first column is February, the month of the census
labs <- c("Feb", "Jan", paste0(month(12:1, label = TRUE), " (y-1)"), paste0(month(12:2, label = TRUE), " (y-2)"))
```

Shared color bar limits so scales can be combined.

```{r}
shoot_lim <- c(min(pred_g_post_1ha$fitted, pred_g_post_cf$fitted),
               max(pred_g_post_1ha$fitted, pred_g_post_cf$fitted))
```

### Plots

**Raster plots:**

```{r}
p_growth_cf <-
  pred_g_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = exp(fitted), fill = exp(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous("lag (months)", breaks = 0:24, labels = labs, expand = c(0,0)) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("#shoots (t+1)", option = "A", limits = exp(shoot_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_growth_cf
```

```{r}
p_growth_1ha <-
  pred_g_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = exp(fitted), fill = exp(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous("lag (months)", breaks = 0:24, labels = labs, expand = c(0,0)) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("#shoots (t+1)", option = "A", limits = exp(shoot_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_growth_1ha
```


**Slice through time at severe drought**

```{r}
p_growth_cf_slice <-
  pred_g_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = exp(fitted))) +
  geom_ribbon(aes(
    ymin = exp(fitted - se.fit * 1.96),
    ymax = exp(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "Continuous Forest", y = "shoots (t+1)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_growth_cf_slice
```


```{r}
p_growth_1ha_slice <-
  pred_g_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = exp(fitted))) +
  geom_ribbon(aes(
    ymin = exp(fitted - se.fit * 1.96),
    ymax = exp(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "1-ha Fragments", y = "shoots (t+1)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_growth_1ha_slice
```


**Slice through individual months**

I find this less useful, but just shows that relationships are slightly quadratic at most complicated.  This would be more useful if there was a way to show which lines had "slopes" significantly different from 0 (i.e. don't totally overlap a flat line).

```{r}
plotdf <-
  pred_g_post_cf %>% 
  mutate(lag = round(lag)) %>% 
  group_by(x, lag) %>% 
  summarize(across(everything(),  mean))


foo <- function(x) {
  d <- 1:25
  names(d)<-labs
  x <- as.numeric(x)
  # s <- glue("lag {x} ({names(d[x])})")
  s <- names(d[x])
  return(s)
}

p_growth_cf_months <-
  plotdf %>% 
  ggplot(aes(x = x, y = exp(fitted))) +
  geom_ribbon(aes(
    ymin = exp(fitted - se.fit * 1.96),
    ymax = exp(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("SPEI3") +
  scale_y_continuous("shoots (t+1)") +
  facet_wrap(~lag, labeller = as_labeller(foo)) +
  theme_bw()
```

## Survival

### Fit GAMs

```{r}
s_post_cf <-
  gam(surv ~ 
        s(log_shts) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_cf,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")
anova(s_post_cf)
```


```{r}
s_post_1ha <-
  gam(surv ~ 
        s(log_shts) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_1ha,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")
anova(s_post_1ha)
```


### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
pred_s_post_cf  <- cb_margeff(s_post_cf,  Q = spei_history, L = L, ref_data = ref_data)
pred_s_post_1ha <- cb_margeff(s_post_1ha, Q = spei_history, L = L, ref_data = ref_data)
```

Shared color bar limits so scales can be combined.

```{r}
surv_lim <- c(min(pred_s_post_1ha$fitted, pred_s_post_cf$fitted),
              max(pred_s_post_1ha$fitted, pred_s_post_cf$fitted))
# plogis(surv_lim)
```

### Plots

**Raster plots:**

```{r}
p_surv_cf <-
  pred_s_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous("lag (months)", breaks = 0:24, labels = labs, expand = c(0,0)) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_surv_cf
```

```{r}
p_surv_1ha <-
  pred_s_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous("lag (months)", breaks = 0:24, labels = labs, expand = c(0,0)) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_surv_1ha
```


**Slice through time at severe drought**

```{r}
p_surv_cf_slice <-
  pred_s_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "Continuous Forest", y = "P(survival)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_surv_cf_slice
```


```{r}
p_surv_1ha_slice <-
  pred_s_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "1-ha Fragments", y = "P(survival)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_surv_1ha_slice
```

## Flowering Probability

### Fit GAMs
```{r}
x <- demog_post_cf$flowered
sum(x, na.rm = TRUE) / length(x)
```

```{r}
f_post_cf <-
  gam(flowered ~ 
        s(log_shts) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_cf,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```

```{r}
# gam.check(f_post_cf)
```


```{r}
summary(f_post_cf)
```


```{r}
f_post_1ha <-
  gam(flowered ~ 
        s(log_shts) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_1ha,
      gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```


```{r}
summary(f_post_1ha)
```


### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
pred_f_post_cf  <- cb_margeff(f_post_cf,  Q = spei_history, L = L, ref_data = ref_data)
pred_f_post_1ha <- cb_margeff(f_post_1ha, Q = spei_history, L = L, ref_data = ref_data)
```

Shared color bar limits so scales can be combined.

```{r}
flowered_lim <- c(min(pred_f_post_1ha$fitted, pred_f_post_cf$fitted),
                  max(pred_f_post_1ha$fitted, pred_f_post_cf$fitted))
plogis(flowered_lim)
```

### Plots

```{r}
p_flowered_cf <-
  pred_f_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous("lag (months)", breaks = 0:24, labels = labs, expand = c(0,0)) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_flowered_cf
```
Something is wrong.  Flowering probability should not be 1.

```{r}
p_flowered_1ha <-
  pred_f_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous("lag (months)", breaks = 0:24, labels = labs, expand = c(0,0)) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_flowered_1ha
```


**Slice through time at severe drought**

```{r}
p_flowered_cf_slice <-
  pred_f_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "Continuous Forest", y = "P(flowering)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# p_surv_cf_slice
```


```{r}
p_flowered_1ha_slice <-
  pred_f_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "1-ha Fragments", y = "P(flowering)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# p_surv_1ha_slice
```

# Plots
## Growth
```{r}
p_growth_spei <-
  (p_growth_cf | p_growth_1ha) +
  plot_annotation(title = "Effect of drought on growth of average sized plant (~2.8 shoots)") +
  plot_layout(guides = "collect") & theme_talk
p_growth_spei
ggsave(here("growth_spei_xa.png"), p_growth_spei, height = 7, width = 14)
```

It looks like drought in September/October is bad for growth.

Reminder that these are still fit with two different models and might not be entirely comparable.  Different penalties to the smooths make these hard to compare as well.


Here's a slice through SPEI = -1.5 (severe drought)

```{r}
(p_growth_cf_slice + theme(axis.text.x = element_blank())) /
  p_growth_1ha_slice +
  plot_annotation(title = "Effect of severe drought (SPEI = -1.5) on average sized plant (~2.8 shoots)")
ggsave(here("growth slice_xa.png"))
```

Again, you can see that drought immediately preceding the census (Jan of that year) and in the previous October are bad for growth, but dry Decembers and Septembers are good for growth.

## Survival

Drought also has a significant effect on survival in both habitat types.

```{r}
p_surv_spei <- 
  (p_surv_cf|p_surv_1ha) + 
  plot_annotation(title = "Effect of drought on survival") +
  plot_layout(guides = "collect") & theme_talk
p_surv_spei
ggsave(here("surv_spei_xa.png"), p_surv_spei, width = 14, height = 7)
```

The surface for 1-ha fragments is basically flat except for a slight *negative* effect of recent wet weather on survival.  In continuous forest, wet conditions or very dry conditions in the previous August–October have a positive effect on survival.


Here's a slice through SPEI = -1.5 (severe drought)

```{r}
((p_surv_cf_slice + theme(axis.text.x = element_blank())) / p_surv_1ha_slice) +
  plot_annotation(title = "Effect of severe drought (SPEI = -1.5)")
ggsave(here("survival slice_xa.png"))
```
Pretty flat.

## Flowering


```{r}
p_flowered_spei <- 
  (p_flowered_cf|p_flowered_1ha) + 
  plot_annotation(title = "Effect of drought on flowering") +
  plot_layout(guides = "collect") & theme_talk
p_flowered_spei
ggsave(here("flowering_spei.png"), p_flowered_spei, width = 14, height = 7)
```

The surface for continuous forest is perfectly flat (did I do something wrong with the color scale?) and for 1-ha fragments there is a strange (anomalous?) negative effect of high SPEI (wet conditions) in the summer 2 years ago.


Here's a slice through SPEI = -1.5 (severe drought)

```{r}
((p_flowered_cf_slice + theme(axis.text.x = element_blank())) / p_flowered_1ha_slice) +
  plot_annotation(title = "Effect of severe drought (SPEI = -1.5)")
ggsave(here("flowering slice.png"))
```