---
title: "FLM for growth as function of SPEI"
author: "Eric R. Scott"
date: "Date Initiated"
output: 
  html_notebook: 
    highlight: kate
    theme: yeti
    toc: yes
    toc_float: yes
    number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, paged.print=FALSE)
library(tidyverse)
library(here)
library(mgcv)
library(dlnm)
library(bbmle)
library(lubridate)
library(glue)
library(patchwork)
library(sf)
library(tsibble)
library(broom)

library(conflicted)
conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("slice", "dplyr")

library(HeliconiaDemography) #load functions in this compendium
# devtools::load_all()
```

```{r}
#define plotting themes
theme_talk <- theme_bw() + theme(text = element_text(size = 18))
```


*Last compiled: `r Sys.Date()`*

# TODO:

- 
- ~~Remove seedlings from dataset, for now~~
- ~~Separate models for CF and fragment, for now~~
- Add model for probability of reproduction and other vital rates
- Model seedlings separately?
- Add random effects, interactions, other complexities
- Try integrative measure of size.  Some paper you read did some formula with height and leaf number. Plantago?

# Purpose

Take a crack at modeling vital rates as a function of previous height and lagged, non-linear, SPEI.

# Load Data

```{r data, echo=TRUE}
demog_full <-
  read_csv(here("analysis", "data", "derived_data", "ha_demog_spei.csv"), 
           col_names = TRUE,
           cols(plot = col_character(),
                bdffp_reserve_no = col_character()))
```

## Tidy

```{r}
demog_full <-
  demog_full %>% 
  mutate(log_shts = log(shts), .after = shts) %>% 
  mutate(log_shts_next = log(shts_next), .after = shts_next)
```

`gam` wants factors!

```{r}
demog_full <-
  demog_full %>% 
  mutate(across(c(ranch, bdffp_reserve_no, plot, habitat, ha_id_number), as.factor)) %>% 
  mutate(flowered = as.numeric(infl > 0), .after = infl)
# View(demog_full)
```

# Splitting up data

Because I can't model interactions with DLNMs, I can either include factors like habitat as predictors (different intercepts, same functional form, same data) or fit separate models (potentially different functional forms, but not using all the data).

```{r}
demog_post <- 
  demog_full %>% 
  filter(code_notes != "sdlg (1)" | is.na(code_notes))

demog_post_cf <-
  demog_post %>% 
  filter(habitat == "CF")

demog_post_1ha <-
  demog_post %>% 
  filter(habitat == "1-ha")

demog_sdlg <- 
  demog_full %>% 
  filter(code_notes == "sdlg (1)")

demog_sdlg_cf <- 
  demog_sdlg %>% 
  filter(habitat == "CF")

demog_sdlg_1ha <- 
  demog_sdlg %>% 
  filter(habitat == "1-ha")
```


## Growth

Start with no random effects

Using a scaled-t family distribution because residuals were leptokurtic with a gaussian.

### Fit GAMs

Fit the GAM with crossbasis smooth for lagged drought

```{r}
g_post_cf <-
  gam(shts_next ~ 
        s(log_shts) + 
        s(plot, bs = "re") + #random effect of plot
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #unimodal-ish response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      family = scat(link = "log"),
      data = demog_post_cf,
      # gamma = 1.2, #I maybe need to optimize this with cross-validation?
      method = "REML")
```

Inspect the GAM

```{r}
gam.check(g_post_cf) 
```

Suggests possibly more knots for s(log_shts), but it looks like a straight line to me

```{r}
plot(g_post_cf, select = 1, main = "select = FALSE")
```

```{r}
summary(g_post_cf)
```


Remember, R-sq is probably so high because size this year is a very good predictor of size next year.

```{r}
g_post_1ha <-
  gam(shts_next ~ 
        s(log_shts) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #unimodal response to drought, but one knot per month lag.
          xt = list(bs = "cr")),
      family = scat(link = "log"),
      data = demog_post_1ha,
      # gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```

```{r}
gam.check(g_post_1ha)
```


Looks great

```{r}
summary(g_post_1ha)
```

```{r}
plot(g_post_1ha, select = 1)
```

### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
# use mean size plant across both habitats so plots are comparable
ref_data <-
  demog_post %>%
  dplyr::summarize(log_shts = log(mean(shts, na.rm = TRUE)),  #log of mean shoots, not mean of log_shts
                   plot = "newlevel")
# exp(1.032814) # 2.8 shoots
mean_size <- round(exp(ref_data$log_shts), 1)
```


```{r}
pred_g_post_cf  <- cb_margeff(g_post_cf, Q = spei_history, L = L, ref_data = ref_data)
pred_g_post_1ha <- cb_margeff(g_post_1ha, Q = spei_history, L = L, ref_data = ref_data)
```

Shared color bar limits so scales can be combined.

```{r}
shoot_lim <- c(min(pred_g_post_1ha$fitted, pred_g_post_cf$fitted),
               max(pred_g_post_1ha$fitted, pred_g_post_cf$fitted))
```

### Plots

**Raster plots:**

```{r}
p_growth_cf <-
  pred_g_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = exp(fitted), fill = exp(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:24, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:24), label = TRUE))
  ) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("#shoots (t+1)", option = "A", limits = exp(shoot_lim)) +
  labs(title = "Continuous Forest",
       caption = glue("Predicted values for average sized plant ({mean_size} shoots)")) +
  theme_bw()
p_growth_cf
```

```{r}
p_growth_1ha <-
  pred_g_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = exp(fitted), fill = exp(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:24, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:24), label = TRUE))
  ) +  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("#shoots (t+1)", option = "A", limits = exp(shoot_lim)) +
  labs(title = "1-ha Fragments",
       caption = glue("Predicted values for average sized plant ({mean_size} shoots)")) +
  theme_bw()
p_growth_1ha
```


**Slice through time at severe drought**

```{r}
p_growth_cf_slice <-
  pred_g_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = exp(fitted))) +
  geom_ribbon(aes(
    ymin = exp(fitted - se.fit * 1.96),
    ymax = exp(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:24) +
  labs(title = "Continuous Forest", y = "shoots (t+1)") +
  theme_linedraw()
p_growth_cf_slice
```


```{r}
p_growth_1ha_slice <-
  pred_g_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = exp(fitted))) +
  geom_ribbon(aes(
    ymin = exp(fitted - se.fit * 1.96),
    ymax = exp(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:24) +
  labs(title = "1-ha Fragments", y = "shoots (t+1)") +
  theme_linedraw()
p_growth_1ha_slice
```


**Slice through individual months**

I find this less useful, but just shows that relationships are slightly quadratic at most complicated.  This would be more useful if there was a way to show which lines had "slopes" significantly different from 0 (i.e. don't totally overlap a flat line).

```{r}
plotdf <-
  pred_g_post_cf %>% 
  mutate(lag = round(lag)) %>% 
  group_by(x, lag) %>% 
  summarize(across(everything(),  mean))

foo <- function(x) {
  x <- as.numeric(x)
  mon <- month(ymd("2020-2-01") - months(x), label = TRUE)
  l <- glue("lag={x} ({mon})")
  return(l)
}

p_growth_cf_months <-
  plotdf %>% 
  ggplot(aes(x = x, y = exp(fitted))) +
  geom_ribbon(aes(
    ymin = exp(fitted - se.fit * 1.96),
    ymax = exp(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("SPEI3") +
  scale_y_continuous("shoots (t+1)") +
  facet_wrap(~lag, labeller = as_labeller(foo)) +
  theme_bw()
p_growth_cf_months
```

## Survival

### Fit GAMs

```{r}
s_post_cf <-
  gam(surv ~ 
        s(log_shts) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_cf,
      # gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```
```{r}
# gam.check(s_post_cf) #not sure what to expect from any of these plots
```
```{r}
summary(s_post_cf)
```


```{r}
s_post_1ha <-
  gam(surv ~ 
        s(log_shts) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_1ha,
      # gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```
```{r}
summary(s_post_1ha)
```


### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
pred_s_post_cf  <- cb_margeff(s_post_cf,  Q = spei_history, L = L, ref_data = ref_data)
pred_s_post_1ha <- cb_margeff(s_post_1ha, Q = spei_history, L = L, ref_data = ref_data)
```

Shared color bar limits so scales can be combined.

```{r}
surv_lim <- c(min(pred_s_post_1ha$fitted, pred_s_post_cf$fitted),
              max(pred_s_post_1ha$fitted, pred_s_post_cf$fitted))
# plogis(surv_lim)
```

### Plots

**Raster plots:**

```{r}
p_surv_cf <-
  pred_s_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:24, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:24), label = TRUE))
  ) + 
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "Continuous Forest",
       caption = glue("Predicted values for average sized plant ({mean_size} shoots)")) +
  theme_bw()
p_surv_cf
```

```{r}
p_surv_1ha <-
  pred_s_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:24, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:24), label = TRUE))
  ) +
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(survival)", option = "A", limits = plogis(surv_lim)) +
  labs(title = "1-ha Fragments",
       caption = glue("Predicted values for average sized plant ({mean_size} shoots)")) +
  theme_bw()
p_surv_1ha
```


**Slice through time at severe drought**

```{r}
p_surv_cf_slice <-
  pred_s_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:24) +
  labs(title = "Continuous Forest", y = "P(survival)") +
  theme_linedraw()
p_surv_cf_slice
```


```{r}
p_surv_1ha_slice <-
  pred_s_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("lag(months)", breaks = 0:24) +
  labs(title = "1-ha Fragments", y = "P(survival)") +
  theme_linedraw()
p_surv_1ha_slice
```

## Flowering Probability

### Fit GAMs

```{r}
x <- demog_post_cf$flowered
sum(x, na.rm = TRUE) / length(x)
```

Around 0.05 percent of plants flowered.

```{r}
f_post_cf <-
  gam(flowered ~ 
        s(log_shts) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_cf,
      # gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```

```{r}
# gam.check(f_post_cf)
```


```{r}
summary(f_post_cf)
```

```{r}
plot(f_post_cf, select = 1, trans = plogis)
```

Plants with exp(3) = 20 shoots have close to a 100% chance of flowering.

```{r}
f_post_1ha <-
  gam(flowered ~ 
        s(log_shts) +
        s(plot, bs = "re") +
        s(spei_history, L,
          bs = "cb",
          k = c(3, 25),  #cubic response (at most) to drought, one knot per month lag.
          xt = list(bs = "cr")),
      family = binomial,
      data = demog_post_1ha,
      # gamma = 1.2, #increases smoothness when above 1
      method = "REML")
```


```{r}
summary(f_post_1ha)
```

```{r}
plot(f_post_1ha, select = 1, trans = plogis)
```

### Get plot data

This is pretty slow. It could probably be faster if I understood matrix math better.

```{r}
pred_f_post_cf  <- cb_margeff(f_post_cf,  Q = spei_history, L = L, ref_data = ref_data)
pred_f_post_1ha <- cb_margeff(f_post_1ha, Q = spei_history, L = L, ref_data = ref_data)
```

Shared color bar limits so scales can be combined.

```{r}
flowered_lim <- c(min(pred_f_post_1ha$fitted, pred_f_post_cf$fitted),
                  max(pred_f_post_1ha$fitted, pred_f_post_cf$fitted))
plogis(flowered_lim)
```

### Plots

```{r}
p_flowered_cf <-
  pred_f_post_cf %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:24, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:24), label = TRUE))
  ) + 
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "Continuous Forest") +
  theme_bw()
p_flowered_cf
```

Something is wrong.  Flowering probability should not be 1 for an average-sized plant.

```{r}
p_flowered_1ha <-
  pred_f_post_1ha %>%
  filter(min_dist < 0.1) %>%
  ggplot(aes(x = x, y = lag, z = plogis(fitted), fill = plogis(fitted))) +
  geom_raster(interpolate = TRUE) +
  scale_y_continuous(
    "lag (months)",
    breaks = 0:24, 
    expand = c(0,0),
    sec.axis = dup_axis(
      name = "Month",
      labels = month(ymd("2020-2-01") - months(0:24), label = TRUE))
  ) + 
  scale_x_continuous("SPEI_3", expand = c(0,0)) +
  scale_fill_viridis_c("P(flowering)", option = "A", limits = plogis(flowered_lim)) +
  labs(title = "1-ha Fragments") +
  theme_bw()
p_flowered_1ha
```


**Slice through time at severe drought**

```{r}
p_flowered_cf_slice <-
  pred_f_post_cf %>% 
  filter(nearest(x, -1.50)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "Continuous Forest", y = "P(flowering)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_flowered_cf_slice
```


```{r}
p_flowered_1ha_slice <-
  pred_f_post_1ha %>% 
  filter(nearest(x, -1.5)) %>% 
  ggplot(aes(x = lag, y = plogis(fitted))) +
  geom_ribbon(aes(
    ymin = plogis(fitted - se.fit * 1.96),
    ymax = plogis(fitted + se.fit * 1.96)
  ), alpha = 0.3)+
  geom_line() +
  scale_x_continuous("", breaks = 0:24, labels = labs) +
  labs(title = "1-ha Fragments", y = "P(flowering)") +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p_flowered_1ha_slice
```

# Plots
## Growth
```{r}
p_growth_spei <-
  (p_growth_cf | p_growth_1ha) +
  plot_annotation(title = "Effect of drought on growth of average sized plant (~2.8 shoots)") +
  plot_layout(guides = "collect") & theme_talk & labs(caption = "")
p_growth_spei
ggsave(here("growth_spei_xa.png"), p_growth_spei, height = 7, width = 14)
```

It looks like drought in September/October is bad for growth.

Reminder that these are still fit with two different models and might not be entirely comparable.  Different penalties to the smooths make these hard to compare as well.


Here's a slice through SPEI = -1.5 (severe drought)

```{r}
(p_growth_cf_slice + theme(axis.text.x = element_blank())) /
  p_growth_1ha_slice +
  plot_annotation(title = "Effect of severe drought (SPEI = -1.5) on average sized plant (~2.8 shoots)")
ggsave(here("growth slice_xa.png"))
```

Again, you can see that drought immediately preceding the census (Jan of that year) and in the previous October are bad for growth, but dry Decembers and Septembers are good for growth.

## Survival

Drought also has a significant effect on survival in both habitat types.

```{r}
p_surv_spei <- 
  (p_surv_cf|p_surv_1ha) + 
  plot_annotation(title = "Effect of drought on survival") +
  plot_layout(guides = "collect") & theme_talk & labs(caption="")
p_surv_spei
ggsave(here("surv_spei_xa.png"), p_surv_spei, width = 14, height = 7)
```

The surface for 1-ha fragments is basically flat except for a slight *negative* effect of recent wet weather on survival.  In continuous forest, wet conditions or very dry conditions in the previous Augustâ€“October have a positive effect on survival.


Here's a slice through SPEI = -1.5 (severe drought)

```{r}
((p_surv_cf_slice + theme(axis.text.x = element_blank())) / p_surv_1ha_slice) +
  plot_annotation(title = "Effect of severe drought (SPEI = -1.5)")
ggsave(here("survival slice_xa.png"))
```
Pretty flat.

## Flowering


```{r}
p_flowered_spei <- 
  (p_flowered_cf|p_flowered_1ha) + 
  plot_annotation(title = "Effect of drought on flowering") +
  plot_layout(guides = "collect") & theme_talk & labs(caption = "")
p_flowered_spei
ggsave(here("flowering_spei.png"), p_flowered_spei, width = 14, height = 7)
```

The surface for continuous forest is perfectly flat (did I do something wrong with the color scale?) and for 1-ha fragments there is a strange (anomalous?) negative effect of high SPEI (wet conditions) in the summer 2 years ago.


Here's a slice through SPEI = -1.5 (severe drought)

```{r}
((p_flowered_cf_slice + theme(axis.text.x = element_blank())) / p_flowered_1ha_slice) +
  plot_annotation(title = "Effect of severe drought (SPEI = -1.5)")
ggsave(here("flowering slice.png"))
```