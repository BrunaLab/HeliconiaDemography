---
title: "Appendix 1: Quantifying Drought"
author: "Eric R. Scott"
date: '2020-09-13'
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/ecology.csl" # Insert path for the bib-style
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(
  include = TRUE,
  echo = FALSE,
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = "",
  dpi = 300)
library(tidyverse)
library(here)
library(conflicted)
library(SPEI)
library(tsibble)
library(lubridate)
library(glue)
library(colorspace)
library(latex2exp)
library(janitor)
library(Amelia)

library(HeliconiaDemography)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
```

*Last compiled: `r Sys.Date()`* \# TODO

-   Write brief text
-   Possibly make a figure S2 that compares SPEI across BDFFP from east to west (3 panels), using all data with similar resolution


# Outline

-   A review of global precip datasets (Sun et al. 2018) recommends ground-based products over satellite products for Brazil.

-   The global SPEI database is calculated from ground-based product (CRU) and a uses method for estimating evapotranspiration that takes more than just temperature into account.

-   There's also a ground-based product specifically for Brazil (Xavier et al).

-   We have rain gauge data that we can get SPEI from if we use imputation (informed by EMBRAPA station data)

```{r read-data}
# Precip Sources
sa <- read_csv(here("analysis", "data", "raw_data", "sa_daily_1x1.csv"))
# trmm <-
  
# Already calculated SPEI  

  
# bdffp <- read_csv(here("analysis", "data", "raw_data", "mon_precip_spi_imputed.csv"))
# #TODO edit to pull this from github or use bdffp rainfall data package

```

# Methods

We compared 3-month SPEI data calculated from a number of sources for the BDFFP site including ground-based data from on-site rain gauges, two nearby weather stations, satellite products, and gridded land station based datasets.

## EMBRAPA

```{r embrapa-spei}
rpde <-
  read_csv(here("analysis", "data", "raw_data", "embrapa", "Estacao_Rio Preto da Eva_1980-01-01_2016-12-31.csv")) %>% 
  select(date = Data,
         precip = Precipitacao,
         eto = Evatotranspiracao,
  )
manaus <-
  read_csv(here("analysis", "data", "raw_data", "embrapa", "Estacao_Manaus_1980-01-01_2016-12-31.csv"))%>% 
  select(date = Data,
         precip = Precipitacao,
         eto = Evatotranspiracao,
  )

embrapa_mon <-
  bind_rows("rpde" = rpde, "manaus" = manaus, .id = "station") %>% 
  mutate(yearmonth = yearmonth(date), .after = date) %>% 
  group_by(yearmonth, station) %>% 
  summarize(across(c(precip, eto), sum), .groups = "drop") %>% 
  as_tsibble(index = yearmonth, key = station)

embrapa_spei <-
  embrapa_mon %>% 
  mutate(cb = precip - eto) %>% 
  group_by(station) %>% 
  group_nest() %>% 
  mutate(st_spei = map(data, ~as.numeric(spei(.x$cb, scale = 3)$fitted))) %>% 
  unnest(c(st_spei, data)) %>% 
  select(-cb) 

embrapa_wide <-
  embrapa_spei %>% 
  select(yearmonth, station, st_spei) %>% 
  pivot_wider(names_from = station,
              values_from = st_spei,
              names_prefix = "spei_") %>% 
  rowwise() %>% 
  mutate(st_spei = mean(c(spei_manaus, spei_rpde))) %>% 
  ungroup()
```

Two weather stations within \_\_\_ km of BDFFP had data available through EMBRAPA <!--# what is this -->, Rio Preto da Eva to the East (-2.65º, -59.65º) and the Manaus station to the West (-2.65º, -60.35º).
We downloaded daily precipitation and potential evapotranspiration data, aggregated it to monthly, and calculated 3 month SPEI for each station separately.
We then averaged the SPEI values for two stations at each month to produce monthly estimates for the BDFFP site.

## BDFFP rain gauge data

```{r}
# Read in data 
#Change to something like this once repo is public
# bdffp_daily <- read_csv("https://raw.githubusercontent.com/BrunaLab/Heliconia-Drought/master/data_cleaned/daily_precip.csv")
bdffp_daily <- read_csv(here("analysis", "data", "raw_data", "daily_precip.csv"))
# Prep data for imputation ------------------------------------------------

# remove accumulations
bdffp2 <-
  bdffp_daily %>% 
  filter(!flag %in% c("A", "U"))

# spread and add rows for missing dates
bdffp_wide <- 
  bdffp2 %>% 
  #complete all the dates
  as_tsibble(key = site, index = date) %>% 
  fill_gaps() %>% 
  select(date, site, precip) %>% 
  as_tibble() %>% 
  pivot_wider(names_from = site, values_from = precip) %>% 
  clean_names()

# Cluster sites by ranch to reduce missingness
bdffp_wide2 <-
  bdffp_wide %>% 
  rowwise() %>% 
  mutate(colosso_clust = mean(c(colosso, florestal, cabo_frio, gaviao),
                              na.rm = TRUE),
         km_clust = mean(c(km37, km41),
                         na.rm = TRUE)) %>% 
  mutate(across(colosso_clust:km_clust, ~ifelse(is.nan(.x), NA, .x))) %>% 
  select(-cabo_frio, -colosso, -florestal, -gaviao, -km37, -km41)

# add additional representations of time for Amelia.
full_wide <- 
  bdffp_wide2 %>% 
  mutate(
    year = year(date),
    doy = yday(date),
    yearmonth = yearmonth(date),
    .before = everything()
  )
```

```{r imputation, cache=TRUE}
# Impute missing data -----------------------------------------------------
# round(runif(1, 1, 1000))
set.seed(937)
all_cols <- colnames(select(full_wide, -year, -doy, -date))

# histograms <-
#   map(all_cols, ~{
#     ggplot(full_wide, aes(full_wide[[.x]])) + geom_histogram() + labs(title = .x)
#   })
# histograms

# variables with log-normal-ish distributions

log_cols <-
  all_cols[str_detect(all_cols, "precip") |
             all_cols %in% c("km_clust", "colosso_clust", "porto_alegre", "dimona")]

imp <- 
  amelia(
    as.data.frame(full_wide),
    p2s = 0,
    m = 10,
    ts = "doy",
    cs = "year",
    intercs = TRUE,
    polytime = 3,
    logs = log_cols,
    idvars = c("date"),
    parallel = "multicore",
    ncpus = detectCores() - 1,
    empri = .01 * nrow(full_wide) #ridge penalty because of high degree of missingness
  )
# imp$imputations[[1]]
```

```{r}
# Prep eto data for SPEI calculation
# Aggregate by month
imp_mon <-
  map(imp$imputations, ~{
    .x %>% 
      rename_with(~paste0(., ".precip"), c(dimona, porto_alegre, colosso_clust, km_clust)) %>% 
      select(date, ends_with(".precip")) %>% 
      mutate(yearmonth = tsibble::yearmonth(date)) %>% 
      group_by(yearmonth) %>% 
      summarize(across(-date, ~sum(.x, na.rm = TRUE))) %>% 
      #remove first and last month, as they aren't complete
      slice(-1, -nrow(.))
  })
# Add mean ETO from EMBRAPA data
imp_mon <-
  map(imp_mon, ~ {
    left_join(.x, embrapa_mon %>% summarize(eto = mean(eto)), by = "yearmonth")
  }) %>% 
  map(., ~{
    mutate(.x, across(ends_with(".precip"),
                      ~ .x - eto,
                      .names = "{str_remove(col, '.precip')}.cb"))
  })
# imp_mon$imp1
```

```{r}
# Calculate SPEI3 (i.e. 3-month window SPEI)

imp_spei <-
  map(imp_mon, ~{
  .x %>% 
    mutate(across(ends_with(".cb"), ~as.numeric(SPEI::spei(.x, scale = 3)$fitted),
                  .names = "{str_remove(col, '.cb')}.spei")) %>%
      select(yearmonth, ends_with(c(".precip", ".spi", ".spei")))
}) 
# imp_spei$imp1
# Combine multiply imputed SPI and SPEI results by taking mean
bdffp_spei <- 
  imp_spei %>%
  bind_rows(.id = "imp") %>% 
  #replace any infinite values with NAs
  mutate(across(ends_with(".spei"), ~ ifelse(is.infinite(.x), NA, .x))) %>% 
  group_by(yearmonth) %>% 
  summarize(across(where(is.numeric), ~mean(., na.rm = TRUE))) %>% 
  #replace NaN's with NAs
  mutate(across(ends_with(".spei"), ~ ifelse(is.nan(.x), NA, .x))) %>% 
  rowwise() %>% 
  mutate(bdffp_spei = mean(c_across(ends_with(".spei")))) %>% 
  ungroup()
```

We obtained rain gauge data collected from 1987--2010 at BDFFP camps.
The precipitation data has a high degree of missingness due to camps being visited infrequently and because not all camps were active from 1987--2010.
There we also a large number of observations representing accumulated rainfall over two or more days.
We removed multi-day accumulations as it was impossible to know how rainfall was distributed over the prior days.
Missing values were then imputed after averaging rainfall data by ranch.
This averaging was necessary as the degree of missingness was too high for imputation to proceed for some camps.
Multiple imputation was performed using the `Amelia` package and was informed by lags/leads, seasonality, and continuous daily weather data from two nearby by weather stations including precipitation, temperature, relative humidity, and wind speed [@honakerAmeliaIIProgram2011].
We produced 10 imputed daily datasets which were then each aggregated monthly and used for calculating SPEI using the averaged potential evapotranspiration from the two EMBRAPA weather stations<!--# why not use mean temperature from weather stations? -->.
Then, the 10 resulting SPEI datasets were averaged to produce a single dataset.

## Xavier et al.

```{r xa-spei}
xa <- read_csv(here("analysis", "data", "raw_data", "xavier_daily_0.25x0.25.csv"))
#aggregate monthly, then calculate climate water balance.
xa_mon <-
  xa %>% 
  unite(latlon, lat, lon, sep = ", ") %>% 
  mutate(yearmonth = yearmonth(date), .after = date) %>% 
  group_by(yearmonth, latlon) %>% 
  summarize(across(c(precip, eto), sum), .groups = "drop") %>% 
  as_tsibble(index = yearmonth, key = latlon)

xa_spei <-
  xa_mon %>% 
  mutate(cb = precip - eto) %>% 
  group_by(latlon) %>%
  group_nest() %>% 
  mutate(xa_spei = map(data, ~as.numeric(spei(.x$cb, scale = 3)$fitted))) %>% 
  unnest(c(xa_spei, data)) %>% 
  select(-cb)
```

Gridded data from Xavier et al. [-@xavierDailyGriddedMeteorological2016] was used to calculate SPEI as described in the main text.
For figure S1, we used an average of SPEI values across all grid cells.

## TRMM

```{r trmm-spei}
trmm <- read_csv(here("analysis", "data", "raw_data", "trmm.csv"))
trmm2 <-
  trmm %>% 
  unite(latlon, lat, long, sep = ", ") %>% 
  mutate(yearmonth = yearmonth(date), .after = date)
# fortunately xa_mon has same latlon, so can join eto

unique(xa_mon$latlon) %in% unique(trmm2$latlon)

trmm_ts <- 
  left_join(trmm2, xa_mon %>% select(yearmonth, latlon, eto), by = c("yearmonth", "latlon")) %>% 
  #I guess I only need grid cells that are also in the Xavier et al. dataset?
  filter(!is.na(eto)) %>% 
  as_tsibble(index = yearmonth, key = latlon)

trmm_spei <- 
  trmm_ts %>% 
  mutate(cb = precip - eto) %>% 
  group_by(latlon) %>% 
  group_nest() %>% 
  mutate(trmm_spei = map(data, ~as.numeric(spei(.x$cb, scale = 3)$fitted))) %>% 
  unnest(c(trmm_spei, data)) %>% 
  select(-cb)
```

Monthly precipitation data from TRMM was used in combination with potential evapotranspiration data from Xavier et al. [-@xavierDailyGriddedMeteorological2016].

## Global SPEI

```{r global-spei}
gspei <-
  read_delim(here("analysis", "data", "raw_data", "global_spei_-59.75_-2.25.csv"),
             delim = ";") %>% 
  rename(date = "days since 1900-1-1", g_spei = spei) %>% 
  mutate(yearmonth = yearmonth(date), date = NULL)
```

Additionally, we downloaded SPEI data from the Global SPEI dataset [@begueriaSbegueriaSPEIbaseVersion2017].
These calculations were made using precipitation data from a gridded product based on land stations and evapotranspiration estimated with the Pennman-Montieth method.



# Combine into single tidy data frame

```{r}
# take average across site
xa_df <-
  xa_spei %>% 
  group_by(yearmonth) %>% 
  #Summarize across grid cells
  summarize(xa_spei = mean(xa_spei))

trmm_df <-
  trmm_spei %>% 
  group_by(yearmonth) %>% 
  summarize(trmm_spei = mean(trmm_spei))

comb <-
  full_join(xa_df, gspei) %>% 
  full_join(trmm_df) %>% 
  full_join(embrapa_wide %>% select(yearmonth, st_spei)) %>% 
  full_join(bdffp_spei %>% select(yearmonth, bdffp_spei)) %>% 
  pivot_longer(-yearmonth, names_to = "dataset", values_to = "spei") %>% 
  filter(yearmonth > yearmonth(ymd("1990-01-01"))) %>% 
  mutate(year = year(yearmonth), .before = yearmonth)
```


<!-- Annotate worst droughts.\ -->
<!-- Expected: -->

<!-- -   2004 & 2006: weak ENSO -->
<!-- -   2002 & 2009: moderate ENSO -->
<!-- -   1997: severe ENSO -->
<!-- -   2005 & 2010: severe SST -->

```{r}
spei_table <-
  comb %>% 
  group_by(year, dataset) %>% 
  mutate(min = min(spei, na.rm = TRUE)) %>% 
  filter(spei == min) %>% 
  mutate(month = month(yearmonth, label = TRUE)) %>% 
  # summarize(min = min, month = month) %>%
  filter(year %in% c(2002, 2004, 2006, 2009, 1997, 2005, 2010)) %>% 
  select(year, dataset, spei, month) %>% 
  mutate(dataset = str_remove(dataset, "_spei")) %>% 
  pivot_wider(names_from = dataset, values_from = c(spei, month)) %>% 
  add_column(cause = c("ENSO", "ENSO", "ENSO", "AMO", "ENSO", "ENSO", "AMO"), .after = "year") %>% 
  mutate(`Global SPEI` = glue("{round(spei_g, 2)} ({month_g})"),
         `Xavier et al.` = glue("{round(spei_xa, 2)} ({month_xa})"),
         EMBRAPA = glue("{round(spei_st, 2)} ({month_st})"),
         TRMM = glue("{round(spei_trmm, 2)} ({month_trmm})"),
         BDFFP = glue("{round(spei_bdffp, 2)} ({month_bdffp})")) %>% 
  ungroup()
```


```{r}
library(gt)
table <- 
  gt(spei_table) %>% 
  tab_style(
    style = list(
      cell_fill(color = "#ffffb2")
    ),
    locations = list(
      cells_body(
        columns = vars(`Global SPEI`),
        rows = spei_g < 0 & spei_g >= -1
      ),
      cells_body(
        columns = vars(EMBRAPA),
        rows = spei_st < 0 & spei_st >= -1
      ),
      cells_body(
        columns = vars(`Xavier et al.`),
        rows = spei_xa < 0 & spei_xa >= -1
      ),
      cells_body(
        columns = vars(TRMM),
        rows = spei_trmm < 0 & spei_trmm >= -1
      ),
      cells_body(
        columns = vars(BDFFP),
        rows = spei_bdffp < 0 & spei_bdffp >= -1
      )
    )
  ) %>% 
  tab_style(
    style = list(
      cell_fill(color = "#fecc5c")
    ),
    locations = list(
      cells_body(
        columns = vars(`Global SPEI`),
        rows = spei_g < -1 & spei_g >= -1.5
      ),
      cells_body(
        columns = vars(EMBRAPA),
        rows = spei_st < -1 & spei_st >= -1.5
      ),
      cells_body(
        columns = vars(`Xavier et al.`),
        rows = spei_xa < -1 & spei_xa >= -1.5
      ),
      cells_body(
        columns = vars(TRMM),
        rows = spei_trmm < -1 & spei_trmm >= -1.5
      ),
      cells_body(
        columns = vars(BDFFP),
        rows = spei_bdffp < -1 & spei_bdffp >= -1.5
      )
    )
  ) %>% 
  tab_style(
    style = list(
      cell_fill(color = "#fd8d3c")
    ),
    locations = list(
      cells_body(
        columns = vars(`Global SPEI`),
        rows = spei_g < -1.5 & spei_g >= -2
      ),
      cells_body(
        columns = vars(EMBRAPA),
        rows = spei_st < -1.5 & spei_st >= -2
      ),
      cells_body(
        columns = vars(`Xavier et al.`),
        rows = spei_xa < -1.5 & spei_xa >= -2
      ),
      cells_body(
        columns = vars(TRMM),
        rows = spei_trmm < -1.5 & spei_trmm >= -2
      ),
      cells_body(
        columns = vars(BDFFP),
        rows = spei_bdffp < -1.5 & spei_bdffp >= -2
      )
    )
  ) %>% 
  tab_style(
    style = list(
      cell_fill(color = "#e31a1c")
    ),
    locations = list(
      cells_body(
        columns = vars(`Global SPEI`),
        rows = spei_g < -2
      ),
      cells_body(
        columns = vars(EMBRAPA),
        rows = spei_st < -2
      ),
      cells_body(
        columns = vars(`Xavier et al.`),
        rows = spei_xa < -2
      ),
      cells_body(
        columns = vars(TRMM),
        rows = spei_trmm < -2
      ),
      cells_body(
        columns = vars(BDFFP),
        rows = spei_bdffp < -2
      )
    )
  ) %>% 
  cols_hide(starts_with(c("spei_", "month_"))) %>% 
  tab_spanner("Lowest SPEI for the year (Month)", vars(`Global SPEI`, EMBRAPA, `Xavier et al.`, TRMM, BDFFP))
# table
# gtsave(table, here("analysis", "supplementary-materials", "spei_table.png"))
#TODO: add citations to this table as footnotes on `cause` or a new column.
```

```{r}
cap <- "Comparison of SPEI values and drought categories across datasets for major drought events in the Amazon. Mild, moderate, severe, and extreme drought are represented by yellow, goldenrod, orange, and red, respectively. Cause indicates whether the drought was caused by the El Niño Southern Oscillation (ENSO) or Atlantic Sea Surface Temperatures (AMO). The lowest SPEI value for the year identified by each dataset is reported, along with the month that minimum value occurred in."
```

```{r spei-table, fig.cap=cap}
knitr::include_graphics(here("analysis", "supplementary-materials", "spei_table.png"))
```

# Plot

Create a plot comparing data sources with known drought years labeled.

```{r}
spei_plot <- 
  comb %>% 
  group_by(year) %>% 
  mutate(min_mon = spei == min(spei, na.rm = TRUE)) %>% 
  mutate(drought_label = case_when(
    year %in% c(2004, 2006) & min_mon ~ "weak ENSO",
    year %in% c(2002, 2009) & min_mon ~ "moderate ENSO",
    year == 1997 & min_mon ~ "severe ENSO",
    year %in% c(2005, 2010) & min_mon ~ "severe SST"
    )) %>% 
  mutate(dataset = case_when(
    dataset == "g_spei"  ~ "Global SPEI",   
    dataset == "xa_spei" ~ "Xavier et al.",
    dataset == "st_spei" ~ "EMBRAPA",
    dataset == "trmm_spei" ~ "TRMM",
    dataset == "bdffp_spei" ~ "BDFFP imputed"
  ))
```
```{r}
cap <- "Three-month SPEI at BDFFP calculated using 5 precipitation datasets.  Drought categories mild, moderate, severe, and extreme drought are represented by yellow, goldenrod, orange, and red panels, respectively."
```

```{r spei-plot, fig.cap=cap, fig.height=5, fig.width=10}
labs <-
  spei_plot %>%
  filter(!is.na(drought_label)) %>% 
  group_by(drought_label) %>% 
  mutate(xend = mean(yearmonth, na.rm = TRUE))

p <-
  ggplot(spei_plot, aes(x = yearmonth, y = spei)) +
  geom_line(aes(color = dataset), size = 0.5) +
  scale_x_yearmonth(
    "Date",
    date_breaks = "1 year",
    # date_minor_breaks = "1 month"
  ) +
  scale_y_continuous(TeX("SPEI_3_"),
                     breaks = seq(-2.5, 2.5, 0.5))+
  scale_color_discrete_qualitative() +
  coord_cartesian(xlim = c("1995-02-01", "2009-02-01")) +
  labs(color = "Dataset", linetype = "Dataset") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
# p
annotate_spei(p)
# ggsave(here("analysis", "supplementary-materials", "spei_comparison.png"))
```

<!-- # Notes -->

<!-- ### Meterological stations -->

<!-- -   EMBRAPA stations -->

<!--     -   Estacao Rio Preto da Eva: -2.65º, -59.65º -->

<!--     -   Estacao Manaus: -2.65º, -60.35º (note, this is not in Manaus city, but NW of it.) -->

<!--     -   Date Range: 1980-present -->

<!--     -   Unclear how evapotranspiration is calculated from the [information provided](https://www.embrapa.br/en/busca-de-solucoes-tecnologicas/-/produto-servico/6044/infoclima---informacoes-climaticas). -->

<!-- ### Ground-based gridded products -->

<!-- -   Daily gridded meteorological variables in Brazil [@xavierDailyGriddedMeteorological2016] -->

<!--     -   Resolution 0.25º x 0.25º -->
<!--     -   Includes precipitation and potential evapotranspiration -->
<!--     -   PET calculated by Pennman-Monteith method -->
<!--     -   Source: 3,625 ground-based weather stations across Brazil -->
<!--     -   Date range: 1980--2015 -->

<!-- -   Global SPEI [@santiago2017] -->

<!--     -   Resolution: 0.5º x 0.5º -->

<!--     -   Provides SPEI calculated using monthly precipitation and potential evapotranspiration estimated with the Pennman-Monteith method, which is considered a superior method to Thornwaite, which only takes temperature into account. -->

<!--     -   Source: Precipitation from CRU TS version 4.03, a gridded product based on land stations. -->

<!--     -   Date range: 1901--2018 -->

<!-- ### Satelite and reanalysis products -->

<!-- -   TRMM 3B43 <!--# doesn't go back far enough.  Not worth using? --> -->

<!--     -   Source DOI: 10.5067/TRMM/TMPA/MONTH/7 -->
<!--     -   Resolution: 0.25º x 0.25º -->
<!--     -   Includes: Monthly precip -->
<!--     -   Doesn't include PET, so I guess I'll take that from the ground stations?? -->
<!--     -   Date range: 1998--2019 -->

<!-- -   PERSIANN-CDR -->

<!--     -   only rainfall, but recommended by [@zhaoEvaluatingDroughtMonitoringUtility2019] for Amazonia. -->

<!--     -   0.25º resolution -->

<!--     -   1983--present -->

# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::
