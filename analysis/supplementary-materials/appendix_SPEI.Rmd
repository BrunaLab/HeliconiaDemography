---
title: "Appendix 1: Quantifying Drought"
author: "Eric R. Scott"
date: '2020-09-13'
output: 
    bookdown::word_document2:
      fig_caption: yes
      reference_docx: "../templates/template.docx" # Insert path for the DOCX file
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/ecology.csl" # Insert path for the bib-style
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(
  include = FALSE,
  echo = FALSE,
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "#>",
  fig.path = "",
  dpi = 300)
library(tidyverse)
library(here)
library(conflicted)
library(SPEI)
library(tsibble)
library(lubridate)
library(glue)
library(colorspace)
library(latex2exp)

library(HeliconiaDemography)

conflict_prefer("lag", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("select", "dplyr")
```

*Last compiled: `r Sys.Date()`*
# TODO

- Write
- Fix colors and labels and such on fig S1
- Make a figure S2 that compares SPEI across BDFFP from east to west (3 panels)
- Maybe add imputed data to this (or maybe not)

# Outline

-   A review of global precip datasets (Sun et al. 2018) recommends ground-based products over satellite products for Brazil.

-   The global SPEI database is calculated from ground-based product (CRU) and a uses method for estimating evapotranspiration that takes more than just temperature into account.

-   There's also a ground-based product specifically for Brazil (Xavier et al).

-   We have rain gauge data that we can get SPEI from if we use imputation (informed by EMBRAPA station data)

```{r read-data}
# Precip Sources
xa <- read_csv(here("analysis", "data", "raw_data", "xavier_daily_0.25x0.25.csv"))
sa <- read_csv(here("analysis", "data", "raw_data", "sa_daily_1x1.csv"))
# trmm <-
  
# Already calculated SPEI  
gspei <-
  read_delim(here("analysis", "data", "raw_data", "global_spei_-59.75_-2.25.csv"),
             delim = ";") %>% 
  rename(date = "days since 1900-1-1", g_spei = spei) %>% 
  mutate(yearmonth = yearmonth(date), date = NULL)
  
bdffp <- read_csv(here("analysis", "data", "raw_data", "mon_precip_spi_imputed.csv"))
#TODO edit to pull this from github or use bdffp rainfall data package

```

# Methods

## Data Source Descriptions

### BDFFP rain gauge data

Daily rain gauge data collected from 1987--2010 at BDFFP camps. The precipitation data has a high degree of missingness due to camps being visited infrequently and because not all camps were active from 1987--2010. There we also a large number of observations that were accumulated rainfall over two or more days. We removed multi-day accumulations as it was impossible to know how rainfall was distributed over the prior days. Missing values were then imputed after averaging rainfall data by ranch. This averaging was necessary as the degree of missingness was too high for imputation to proceed for some camps. Multiple imputation was performed using the `Amelia` package and was informed by lags/leads, seasonality, and continuous daily weather data from two nearby by weather stations including precipitation, temperature, relative humidity, and wind speed. Multiple imputation produced \_\_\_ <!--# 10? --> imputed daily datasets which were then each aggregated monthly and used for calculating SPEI using potential evapotranspiration from Xavier et al. [-@xavierDailyGriddedMeteorological2016] to calculate climatic water balance <!--# why not use mean temperature from weather stations? -->. Then, the <!--# number --> resulting SPEI datasets were averaged to produce a single dataset.

### Meterological stations

-   EMBRAPA stations

    -   Estacao Rio Preto da Eva: -2.65º, -59.65º

    -   Estacao Manaus: -2.65º, -60.35º (note, this is not in Manaus city, but NW of it.)

    -   Date Range: 1980-present

    -   Unclear how evapotranspiration is calculated from the [information provided](https://www.embrapa.br/en/busca-de-solucoes-tecnologicas/-/produto-servico/6044/infoclima---informacoes-climaticas).

### Ground-based gridded products

-   Daily gridded meteorological variables in Brazil [@xavierDailyGriddedMeteorological2016]

    -   Resolution 0.25º x 0.25º
    -   Includes precipitation and potential evapotranspiration
    -   PET calculated by Pennman-Monteith method
    -   Source: 3,625 ground-based weather stations across Brazil
    -   Date range: 1980--2015

-   Global SPEI [@santiago2017]

    -   Resolution: 0.5º x 0.5º

    -   Provides SPEI calculated using monthly precipitation and potential evapotranspiration estimated with the Pennman-Monteith method, which is considered a superior method to Thornwaite, which only takes temperature into account.

    -   Source: Precipitation from CRU TS version 4.03, a gridded product based on land stations.

    -   Date range: 1901--2018

### Satelite and reanalysis products

-   TRMM 3B43 <!--# doesn't go back far enough.  Not worth using? -->
    -   Source DOI: 10.5067/TRMM/TMPA/MONTH/7
    -   Resolution: 0.25º x 0.25º
    -   Includes: Monthly precip
    -   Doesn't include PET, so I guess I'll take that from the ground stations??
    -   Date range: 1998--2019

-   PERSIANN-CDR

    -   only rainfall, but recommended by [@zhaoEvaluatingDroughtMonitoringUtility2019] for Amazonia.

    -   0.25º resolution

    -   1983--present

# Xavier et al.

```{r xa-spei}
#aggregate monthly, then calculate climate water balance.
xa_mon <-
  xa %>% 
  unite(latlon, lat, lon, sep = ", ") %>% 
  mutate(yearmonth = yearmonth(date), .after = date) %>% 
  group_by(yearmonth, latlon) %>% 
  summarize(across(c(precip, eto), sum), .groups = "drop") %>% 
  as_tsibble(index = yearmonth, key = latlon)

xa_spei <-
  xa_mon %>% 
  mutate(cb = precip - eto) %>% 
  group_by(latlon) %>%
  group_nest() %>% 
  mutate(xa_spei = map(data, ~as.numeric(spei(.x$cb, scale = 3)$fitted))) %>% 
  unnest(c(xa_spei, data)) %>% 
  select(-cb)
```

# EMBRAPA stations

```{r embrapa-spei}
rpde <-
  read_csv(here("analysis", "data", "raw_data", "embrapa", "Estacao_Rio Preto da Eva_1980-01-01_2016-12-31.csv")) %>% 
  select(date = Data,
         precip = Precipitacao,
         eto = Evatotranspiracao,
  )
manaus <-
  read_csv(here("analysis", "data", "raw_data", "embrapa", "Estacao_Manaus_1980-01-01_2016-12-31.csv"))%>% 
  select(date = Data,
         precip = Precipitacao,
         eto = Evatotranspiracao,
  )

embrapa_mon <-
  bind_rows("rpde" = rpde, "manaus" = manaus, .id = "station") %>% 
  mutate(yearmonth = yearmonth(date), .after = date) %>% 
  group_by(yearmonth, station) %>% 
  summarize(across(c(precip, eto), sum), .groups = "drop") %>% 
  as_tsibble(index = yearmonth, key = station)

embrapa_spei <-
  embrapa_mon %>% 
  mutate(cb = precip - eto) %>% 
  group_by(station) %>% 
  group_nest() %>% 
  mutate(st_spei = map(data, ~as.numeric(spei(.x$cb, scale = 3)$fitted))) %>% 
  unnest(c(st_spei, data)) %>% 
  select(-cb) 

embrapa_wide <-
  embrapa_spei %>% 
  select(yearmonth, station, st_spei) %>% 
  pivot_wider(names_from= station, values_from = st_spei, names_prefix = "spei_") %>% 
  rowwise() %>% 
  mutate(st_spei = mean(c(spei_manaus, spei_rpde))) %>% 
  ungroup()
```

# TRMM

```{r trmm-spei}
trmm <- read_csv(here("analysis", "data", "raw_data", "trmm.csv"))
trmm2 <-
  trmm %>% 
  unite(latlon, lat, long, sep = ", ") %>% 
  mutate(yearmonth = yearmonth(date), .after = date)
# fortunately xa_mon has same latlon, so can join eto

unique(xa_mon$latlon) %in% unique(trmm2$latlon)

trmm_ts <- 
  left_join(trmm2, xa_mon %>% select(yearmonth, latlon, eto), by = c("yearmonth", "latlon")) %>% 
  #I guess I only need grid cells that are also in the Xavier et al. dataset?
  filter(!is.na(eto)) %>% 
  as_tsibble(index = yearmonth, key = latlon)

trmm_spei <- 
  trmm_ts %>% 
  mutate(cb = precip - eto) %>% 
  group_by(latlon) %>% 
  group_nest() %>% 
  mutate(trmm_spei = map(data, ~as.numeric(spei(.x$cb, scale = 3)$fitted))) %>% 
  unnest(c(trmm_spei, data)) %>% 
  select(-cb)
```

# Imputed data (averaged across for BDFFP)

```{r}
bdffp_spei <- 
  bdffp %>% group_by(date) %>% 
  summarize(bdffp_spei = mean(spei)) %>% 
  mutate(yearmonth = yearmonth(date), date = NULL)
```



# Combine into single tidy data frame

```{r}
# take average across site
xa_df <-
  xa_spei %>% 
  group_by(yearmonth) %>% 
  #Summarize across grid cells
  summarize(xa_spei = mean(xa_spei))

trmm_df <-
  trmm_spei %>% 
  group_by(yearmonth) %>% 
  summarize(trmm_spei = mean(trmm_spei))

comb <-
  full_join(xa_df, gspei) %>% 
  full_join(trmm_df) %>% 
  full_join(embrapa_wide %>% select(yearmonth, st_spei)) %>% 
  full_join(bdffp_spei) %>% 
  pivot_longer(-yearmonth, names_to = "dataset", values_to = "spei") %>% 
  filter(yearmonth > yearmonth(ymd("1990-01-01"))) %>% 
  mutate(year = year(yearmonth), .before = yearmonth)
```

# Table of Expected Droughts
Annotate worst droughts.\
Expected:

-   2004 & 2006: weak ENSO
-   2002 & 2009: moderate ENSO
-   1997: severe ENSO
-   2005 & 2010: severe SST


```{r}
spei_table <-
  comb %>% 
  group_by(year, dataset) %>% 
  mutate(min = min(spei, na.rm = TRUE)) %>% 
  filter(spei == min) %>% 
  mutate(month = month(yearmonth, label = TRUE)) %>% 
  # summarize(min = min, month = month) %>%
  filter(year %in% c(2002, 2004, 2006, 2009, 1997, 2005, 2010)) %>% 
  select(year, dataset, spei, month) %>% 
  mutate(dataset = str_remove(dataset, "_spei")) %>% 
  pivot_wider(names_from = dataset, values_from = c(spei, month)) %>% 
  add_column(cause = c("ENSO", "ENSO", "ENSO", "AMO", "ENSO", "ENSO", "AMO"), .after = "year") %>% 
  mutate(`Global SPEI` = glue("{round(spei_g, 2)} ({month_g})"),
         `Xavier et al.` = glue("{round(spei_xa, 2)} ({month_xa})"),
         EMBRAPA = glue("{round(spei_st, 2)} ({month_st})"),
         TRMM = glue("{round(spei_trmm, 2)} ({month_trmm})"),
         BDFFP = glue("{round(spei_bdffp, 2)} ({month_bdffp})")) %>% 
  ungroup()
```


```{r}
library(gt)
table <- 
  gt(spei_table) %>% 
  tab_style(
    style = list(
      cell_fill(color = "#ffffb2")
    ),
    locations = list(
      cells_body(
        columns = vars(`Global SPEI`),
        rows = spei_g < 0 & spei_g >= -1
      ),
      cells_body(
        columns = vars(EMBRAPA),
        rows = spei_st < 0 & spei_st >= -1
      ),
      cells_body(
        columns = vars(`Xavier et al.`),
        rows = spei_xa < 0 & spei_xa >= -1
      ),
      cells_body(
        columns = vars(TRMM),
        rows = spei_trmm < 0 & spei_trmm >= -1
      ),
      cells_body(
        columns = vars(BDFFP),
        rows = spei_bdffp < 0 & spei_bdffp >= -1
      )
    )
  ) %>% 
  tab_style(
    style = list(
      cell_fill(color = "#fecc5c")
    ),
    locations = list(
      cells_body(
        columns = vars(`Global SPEI`),
        rows = spei_g < -1 & spei_g >= -1.5
      ),
      cells_body(
        columns = vars(EMBRAPA),
        rows = spei_st < -1 & spei_st >= -1.5
      ),
      cells_body(
        columns = vars(`Xavier et al.`),
        rows = spei_xa < -1 & spei_xa >= -1.5
      ),
      cells_body(
        columns = vars(TRMM),
        rows = spei_trmm < -1 & spei_trmm >= -1.5
      ),
      cells_body(
        columns = vars(BDFFP),
        rows = spei_bdffp < -1 & spei_bdffp >= -1.5
      )
    )
  ) %>% 
  tab_style(
    style = list(
      cell_fill(color = "#fd8d3c")
    ),
    locations = list(
      cells_body(
        columns = vars(`Global SPEI`),
        rows = spei_g < -1.5 & spei_g >= -2
      ),
      cells_body(
        columns = vars(EMBRAPA),
        rows = spei_st < -1.5 & spei_st >= -2
      ),
      cells_body(
        columns = vars(`Xavier et al.`),
        rows = spei_xa < -1.5 & spei_xa >= -2
      ),
      cells_body(
        columns = vars(TRMM),
        rows = spei_trmm < -1.5 & spei_trmm >= -2
      ),
      cells_body(
        columns = vars(BDFFP),
        rows = spei_bdffp < -1.5 & spei_bdffp >= -2
      )
    )
  ) %>% 
  tab_style(
    style = list(
      cell_fill(color = "#e31a1c")
    ),
    locations = list(
      cells_body(
        columns = vars(`Global SPEI`),
        rows = spei_g < -2
      ),
      cells_body(
        columns = vars(EMBRAPA),
        rows = spei_st < -2
      ),
      cells_body(
        columns = vars(`Xavier et al.`),
        rows = spei_xa < -2
      ),
      cells_body(
        columns = vars(TRMM),
        rows = spei_trmm < -2
      ),
      cells_body(
        columns = vars(BDFFP),
        rows = spei_bdffp < -2
      )
    )
  ) %>% 
  cols_hide(starts_with(c("spei_", "month_"))) %>% 
  tab_spanner("Lowest SPEI for the year (Month)", vars(`Global SPEI`, EMBRAPA, `Xavier et al.`, TRMM, BDFFP))
table
gtsave(table, here("analysis", "supplementary-materials", "spei_table.png"))
#TODO: add citations to this table as footnotes on `cause` or a new column.
```



# Plot

Create a plot comparing data sources with known drought years labeled.

```{r}
spei_plot <- 
  comb %>% 
  group_by(year) %>% 
  mutate(min_mon = spei == min(spei, na.rm = TRUE)) %>% 
  mutate(drought_label = case_when(
    year %in% c(2004, 2006) & min_mon ~ "weak ENSO",
    year %in% c(2002, 2009) & min_mon ~ "moderate ENSO",
    year == 1997 & min_mon ~ "severe ENSO",
    year %in% c(2005, 2010) & min_mon ~ "severe SST"
    )) %>% 
  mutate(dataset = case_when(
    dataset == "g_spei"  ~ "Global SPEI",   
    dataset == "xa_spei" ~ "Xavier et al.",
    dataset == "st_spei" ~ "EMBRAPA",
    dataset == "trmm_spei" ~ "TRMM",
    dataset == "bdffp_spei" ~ "BDFFP imputed"
  ))
```





```{r fig.height=5, fig.width=10}
labs <-
  spei_plot %>%
  filter(!is.na(drought_label)) %>% 
  group_by(drought_label) %>% 
  mutate(xend = mean(yearmonth, na.rm = TRUE))

p <-
  ggplot(spei_plot, aes(x = yearmonth, y = spei)) +
  geom_line(aes(color = dataset), size = 0.5) +
  scale_x_yearmonth(
    "Date",
    date_breaks = "1 year",
    # date_minor_breaks = "1 month"
  ) +
  scale_y_continuous(TeX("SPEI_3_"),
                     breaks = seq(-2.5, 2.5, 0.5))+
  scale_color_discrete_qualitative() +
  coord_cartesian(xlim = c("1995-02-01", "2009-02-01")) +
  labs(color = "Dataset", linetype = "Dataset") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p
annotate_spei(p)
ggsave(here("analysis", "supplementary-materials", "spei_comparison.png"))
```


# References

<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->

::: {#refs}
:::
